<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deriv Bot Store Affiliates</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google reCAPTCHA v3 -->
  <script src="https://www.google.com/recaptcha/api.js?render=6LcJnj0rAAAAANGq6tGazaBo5aPBcUr_IrUwdbi7"></script>
  <!-- jwt-decode for JWT parsing -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/lib/jwt-decode.min.js"></script>
  <style>
    /* Custom animations */
    .slide-in {
      animation: slideIn 0.3s ease-in-out forwards;
    }
    .fade-out {
      animation: fadeOut 0.3s forwards;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    /* Card hover effect */
    .card-hover:hover {
      transform: translateY(-2px);
      transition: transform 0.2s;
    }
    /* Theme-specific styles */
    .theme-light { background-color: #ffffff; color: #000000; }
    .theme-dark { background-color: #1f2937; color: #d1d5db; }
  </style>
</head>
<body class="min-h-screen font-sans">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="text-center text-lg text-white">Initializing account, loading data...</div>
  </div>

  <!-- Header -->
  <header class="p-4 border-b theme-light" id="header">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="public/assets/logo.png" alt="Deriv Bot Store Affiliates" class="h-8" id="logo" onerror="this.onerror=null; this.remove(); document.getElementById('logoFallback').classList.remove('hidden');">
        <span id="logoFallback" class="text-2xl font-bold hidden">Deriv Bot Store Affiliates</span>
        <div id="welcomeMessage" class="ml-4 text-sm text-gray-500 hidden"></div>
      </div>
      <!-- Navigation -->
      <div class="flex items-center space-x-2">
        <button id="contactUsBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 hidden">Contact Us</button>
        <div id="settingsDropdown" class="relative hidden">
          <button class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center">
            <img src="public/assets/setting.png" alt="Settings" class="w-6 h-6 mr-2"> Settings
          </button>
          <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden theme-light" id="settingsMenu">
            <button id="changePasswordBtn" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100">Change Password</button>
            <button id="deleteAccountBtn" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100">Delete Account</button>
            <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100">Logout</button>
          </div>
        </div>
        <!-- Theme Toggle -->
        <button id="themeToggle" aria-label="Toggle theme" class="p-2 rounded-md hover:bg-gray-200">
          <svg id="sunIcon" class="w-6 h-6 hidden" fill="#f3f4f6" viewBox="0 0 24 24">
            <path d="M12 18a6 6 0 100-12 6 6 0 000 12zm0 2a8 8 0 110-16 8 8 0 010 16zM11 4V2h2v2h-2zm0 18v-2h2v2h-2zM4 11H2v2h2v-2zm18 0h-2v2h2v-2zM5.636 5.636l-1.414-1.414 1.414 1.414zm12.728 12.728l1.414-1.414-1.414 1.414zM5.636 18.364l1.414-1.414-1.414 1.414zm12.728-12.728l-1.414-1.414 1.414 1.414z"/>
          </svg>
          <svg id="moonIcon" class="w-6 h-6 hidden" fill="#1f2937" viewBox="0 0 24 24">
            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2a10.002 10.002 0 00-8.66 14.99A9.97 9.97 0 0012 22zm0-2A8 8 0 016.343 6.343 8 8 0 0112 4a8 8 0 018 8 8 8 0 01-8 8z"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto p-4">
    <!-- Auth Forms -->
    <div id="authSection" class="theme-light">
      <!-- Toggle Buttons -->
      <div class="flex justify-center space-x-2 mb-4">
        <button id="loginToggle" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md">Login</button>
        <button id="signupToggle" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md">Sign Up</button>
        <button id="forgotPasswordToggle" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md">Forgot Password</button>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto">
        <h2 class="text-lg font-bold mb-4">Login</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="loginEmail" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <div class="relative">
              <input type="password" id="loginPassword" class="w-full p-2 border rounded" required>
              <button type="button" id="loginPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="loginRecaptcha" required>
            <label class="ml-2 text-sm text-gray-700">I am not a robot (reCAPTCHA)</label>
          </div>
          <button id="loginSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Login</button>
          <p class="text-center text-sm">
            <a href="#" id="showForgotPassword" class="text-blue-500 hover:underline">Forgot Password?</a>
          </p>
        </div>
      </div>

      <!-- Sign-Up Form -->
      <div id="signupForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 class="text-lg font-bold mb-4">Sign Up</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Full Name</label>
            <input type="text" id="signupName" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Username</label>
            <input type="text" id="signupUsername" class="w-full p-2 border rounded" required>
            <p id="usernameStatus" class="text-sm mt-1"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="signupEmail" class="w-full p-2 border rounded" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <div class="relative">
              <input type="password" id="signupPassword" class="w-full p-2 border rounded" required>
              <button type="button" id="signupPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="signupTerms" required>
            <label class="ml-2 text-sm text-gray-700">I agree to the <a href="/affiliate-terms" class="text-blue-500 hover:underline">Terms & Conditions</a></label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="signupRecaptcha" required>
            <label class="ml-2 text-sm text-gray-700">I am not a robot (reCAPTCHA)</label>
          </div>
          <button id="signupSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Create Account</button>
          <p class="text-center text-sm">
            Already have an account? <a href="#" id="showLogin" class="text-blue-500 hover:underline">Login</a>
          </p>
        </div>
      </div>

      <!-- Forgot Password Form -->
      <div id="forgotPasswordForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 class="text-lg font-bold mb-4">Forgot Password</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="forgotEmail" class="w-full p-2 border rounded" required>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="forgotRecaptcha" required>
            <label class="ml-2 text-sm text-gray-700">I am not a robot (reCAPTCHA)</label>
          </div>
          <button id="forgotSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Submit</button>
        </div>
      </div>

      <!-- OTP Verification Form (Shared) -->
      <div id="otpForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 id="otpTitle" class="text-lg font-bold mb-4">Verify Your Email Address</h2>
        <p id="otpMessage" class="mb-4"></p>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">One-Time Password</label>
            <input type="text" id="otpInput" class="w-full p-2 border rounded" maxlength="6" required>
          </div>
          <p id="otpCountdown" class="text-sm text-gray-500"></p>
          <button id="otpResend" class="w-full bg-gray-500 text-white px-4 py-2 rounded-md opacity-50 cursor-not-allowed">Resend Code</button>
          <button id="otpVerify" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Verify</button>
        </div>
      </div>

      <!-- Set New Password Form -->
      <div id="setNewPasswordForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 class="text-lg font-bold mb-4">Set New Password</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">New Password</label>
            <div class="relative">
              <input type="password" id="newPassword" class="w-full p-2 border rounded" required>
              <button type="button" id="newPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
            <div class="relative">
              <input type="password" id="confirmPassword" class="w-full p-2 border rounded" required>
              <button type="button" id="confirmPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <button id="setNewPasswordSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Submit</button>
        </div>
      </div>
    </div>

    <!-- Dashboard (Post-Authentication) -->
    <div id="dashboardSection" class="hidden">
      <!-- Navigation Tabs -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="tabHome" class="bg-blue-500 text-white px-4 py-2 rounded-md">Home</button>
        <button id="tabWithdrawalHistory" class="bg-gray-500 text-white px-4 py-2 rounded-md">Withdrawal History</button>
        <button id="tabRewardsHistory" class="bg-gray-500 text-white px-4 py-2 rounded-md">Rewards History</button>
        <button id="tabLeaderboard" class="bg-gray-500 text-white px-4 py-2 rounded-md">Leaderboard</button>
        <button id="tabNotificationsHistory" class="bg-gray-500 text-white px-4 py-2 rounded-md">Notifications History</button>
        <button id="tabNews" class="bg-gray-500 text-white px-4 py-2 rounded-md">News</button>
        <button id="tabMarketing" class="bg-gray-500 text-white px-4 py-2 rounded-md">Marketing</button>
      </div>

      <!-- Home Tab -->
      <div id="homeTab">
        <div class="mb-4">
          <label class="block text-sm font-medium">Affiliate Link</label>
          <div class="flex">
            <input id="affiliateLink" class="w-full p-2 border rounded" readonly>
            <button id="copyLink" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 ml-2">Copy</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Link Clicks</h3>
            <p id="linkClicks" class="text-lg">0</p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Total Sales</h3>
            <p id="totalSales" class="text-lg">0</p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Monthly Sales</h3>
            <p id="monthlySales" class="text-lg">0</p>
            <p id="monthlyReset" class="text-sm text-gray-500"></p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Current Balance (KES)</h3>
            <p id="currentBalance" class="text-lg">0.00</p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Total Withdrawn (KES)</h3>
            <p id="withdrawnTotal" class="text-lg">0.00</p>
          </div>
        </div>
        <button id="commissionInfoBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mb-4">Commission Info</button>
        <div class="bg-white p-4 rounded-lg shadow theme-light">
          <h3 class="font-medium mb-2">Request Withdrawal</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Amount (KES)</label>
              <input type="number" id="withdrawalAmount" class="w-full p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">MPESA Number</label>
              <input type="text" id="withdrawalMpesaNumber" class="w-full p-2 border rounded" required>
            </div>
            <div>
              <label class="block text-sm font-medium">MPESA Name</label>
              <input type="text" id="withdrawalMpesaName" class="w-full p-2 border rounded" required>
            </div>
            <div class="flex items-center">
              <input type="checkbox" id="reuseDetails">
              <label class="ml-2 text-sm">Reuse Details</label>
            </div>
            <button id="editMpesaDetails" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Edit MPESA Details</button>
            <button id="requestWithdrawal" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Request Withdrawal</button>
          </div>
        </div>
      </div>

      <!-- Withdrawal History Tab -->
      <div id="withdrawalHistoryTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the last 20 withdrawals are shown.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-left">Amount (KES)</th>
              <th class="p-2 text-left">MPESA Number</th>
              <th class="p-2 text-left">MPESA Name</th>
              <th class="p-2 text-left">Status</th>
              <th class="p-2 text-left">MPESA Ref</th>
            </tr>
          </thead>
          <tbody id="withdrawalHistoryTable"></tbody>
        </table>
      </div>

      <!-- Rewards History Tab -->
      <div id="rewardsHistoryTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the last 20 rewards are shown.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-left">Type</th>
              <th class="p-2 text-left">Amount (KES)</th>
              <th class="p-2 text-left">Description</th>
            </tr>
          </thead>
          <tbody id="rewardsHistoryTable"></tbody>
        </table>
      </div>

      <!-- Leaderboard Tab -->
      <div id="leaderboardTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the first 10 affiliates appear here.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Rank</th>
              <th class="p-2 text-left">Affiliate Name</th>
              <th class="p-2 text-left">Monthly Sales</th>
              <th class="p-2 text-left">Momentum</th>
            </tr>
          </thead>
          <tbody id="leaderboardTable"></tbody>
        </table>
      </div>

      <!-- Notifications History Tab -->
      <div id="notificationsHistoryTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the last 20 notifications appear here.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Timestamp</th>
              <th class="p-2 text-left">Message</th>
              <th class="p-2 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="notificationsHistoryTable"></tbody>
        </table>
      </div>

      <!-- News Tab -->
      <div id="newsTab" class="hidden">
        <div id="newsList" class="space-y-4"></div>
      </div>

      <!-- Marketing Tab -->
      <div id="marketingTab" class="hidden">
        <p class="text-lg font-medium mb-4">Join our forums for free marketing videos and guidance</p>
        <div id="forumsList" class="space-y-4"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="p-4 border-t text-center text-sm text-gray-500 theme-light" id="footer">
    <div id="staticLinks"></div>
    <p id="copyrightText"></p>
  </footer>

  <!-- Modals -->
  <!-- Contact Us Modal -->
  <div id="contactUsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Contact Us</h2>
      <div class="space-y-4">
        <a id="whatsappLink" class="flex items-center bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
          <img src="public/assets/whatsapp.png" alt="WhatsApp" class="w-6 h-6 mr-2"> WhatsApp
        </a>
        <a id="emailLink" class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
          <img src="public/assets/email.png" alt="Email" class="w-6 h-6 mr-2"> Email
        </a>
      </div>
      <button id="closeContactUs" class="mt-4 text-gray-500 hover:text-gray-700">Close</button>
    </div>
  </div>

  <!-- Commission Info Modal -->
  <div id="commissionInfoModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Commission Info</h2>
      <p id="commissionText" class="mb-2"></p>
      <p id="commissionExample" class="mb-4"></p>
      <button id="closeCommissionInfo" class="text-gray-500 hover:text-gray-700">Close</button>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Change Password</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Current Password</label>
          <div class="relative">
            <input type="password" id="currentPassword" class="w-full p-2 border rounded" required>
            <button type="button" id="currentPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">New Password</label>
          <div class="relative">
            <input type="password" id="changeNewPassword" class="w-full p-2 border rounded" required>
            <button type="button" id="changeNewPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Confirm Password</label>
          <div class="relative">
            <input type="password" id="changeConfirmPassword" class="w-full p-2 border rounded" required>
            <button type="button" id="changeConfirmPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
          </div>
        </div>
        <button id="changePasswordSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Submit</button>
        <button id="closeChangePassword" class="w-full text-gray-500 hover:text-gray-700 mt-2">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div id="deleteAccountModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Delete Account</h2>
      <p class="mb-4">Are you sure you want to delete your account? This action cannot be undone.</p>
      <button id="confirmDelete" class="w-full bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Delete</button>
      <button id="closeDeleteAccount" class="w-full text-gray-500 hover:text-gray-700 mt-2">Cancel</button>
    </div>
  </div>

  <!-- Session Timeout Modal -->
  <div id="sessionTimeoutModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Are you still there?</h2>
      <p class="mb-4">Your session will expire in 4 minutes unless you verify your password.</p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Password</label>
          <input type="password" id="sessionPassword" class="w-full p-2 border rounded" required>
        </div>
        <button id="sessionYes" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Yes</button>
        <button id="sessionNo" class="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">No</button>
      </div>
    </div>
  </div>

  <!-- Static Page Modal -->
  <div id="staticPageModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 id="staticPageTitle" class="text-xl font-bold mb-4"></h2>
      <div id="staticPageContent" class="prose"></div>
      <button id="closeStaticPage" class="mt-4 text-gray-500 hover:text-gray-700">Close</button>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer" class="fixed top-4 right-4 space-y-2 max-w-xs"></div>

  <script>
    // Constants
    const API_BASE = 'https://affiliate-botblitz.onrender.com/api/affiliate';
    const WS_URL = 'wss://affiliate-botblitz.onrender.com/ws/affiliate';
    const RECAPTCHA_SITE_KEY = '6LcJnj0rAAAAANGq6tGazaBo5aPBcUr_IrUwdbi7';
    const SESSION_TIMEOUT = 10 * 60 * 1000; // 10 minutes
    const SESSION_GRACE = 4 * 60 * 1000; // 4 minutes
    const OTP_DURATION = 5 * 60 * 1000; // 5 minutes
    const RATE_LIMIT_DURATION = 10 * 60 * 1000; // 10 minutes
    const OTP_RATE_LIMIT_DURATION = 20 * 60 * 1000; // 20 minutes
    const OTP_BLOCK_DURATION = 30 * 60 * 1000; // 30 minutes

    // State
    let jwtToken = getCookie('jwt');
    let ws = null;
    let userData = null;
    let notificationsQueue = [];
    let activeNotifications = 0;
    let sessionTimer = null;
    let sessionGraceTimer = null;
    let otpTimer = null;
    let otpResendTimer = null;
    let otpBlockTimer = null;
    let currentTheme = localStorage.getItem('theme') || 'light';
    let otpContext = null; // Tracks current OTP flow (signup, login, etc.)

    // Utility Functions
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, maxAge) {
      document.cookie = `${name}=${value}; max-age=${maxAge}; path=/; secure; httpOnly`;
    }

    function applyTheme() {
      const elements = document.querySelectorAll('.theme-light, .theme-dark');
      elements.forEach(el => {
        if (currentTheme === 'light') {
          el.classList.remove('theme-dark', 'bg-gray-800', 'text-gray-100', 'bg-gray-900', 'bg-gray-700', 'prose-invert', 'bg-red-900');
          el.classList.add('theme-light', el.classList.contains('bg-gray-800') ? 'bg-white' : '', el.classList.contains('text-gray-100') ? 'text-black' : '', el.classList.contains('bg-gray-900') ? 'bg-white' : '', el.classList.contains('bg-gray-700') ? 'bg-gray-200' : '', el.classList.contains('prose-invert') ? 'prose' : '', el.classList.contains('bg-red-900') ? 'bg-red-100' : '');
        } else {
          el.classList.remove('theme-light', 'bg-white', 'text-black', 'bg-gray-200', 'prose', 'bg-red-100');
          el.classList.add('theme-dark', el.classList.contains('bg-white') ? 'bg-gray-800' : '', el.classList.contains('text-black') ? 'text-gray-100' : '', el.classList.contains('bg-gray-200') ? 'bg-gray-700' : '', el.classList.contains('prose') ? 'prose-invert' : '', el.classList.contains('bg-red-100') ? 'bg-red-900' : '');
        }
      });
      document.getElementById('sunIcon').classList.toggle('hidden', currentTheme !== 'light');
      document.getElementById('moonIcon').classList.toggle('hidden', currentTheme === 'light');
    }

    function showNotification(message, color, isUrgent = false) {
      const id = `NOTIF${Date.now()}`;
      notificationsQueue.push({ id, message, color, isUrgent, timestamp: new Date().toISOString() });
      displayNextNotification();
    }

    function displayNextNotification() {
      if (activeNotifications >= 3 || notificationsQueue.length === 0) return;
      const notif = notificationsQueue.shift();
      activeNotifications++;
      const div = document.createElement('div');
      div.className = `bg-white p-4 rounded shadow slide-in border-l-4 ${notif.color === 'green' ? 'border-green-500' : notif.color === 'red' ? 'border-red-500' : 'border-blue-500'} theme-light ${notif.isUrgent ? 'border-2 border-red-500 bg-red-100' : ''}`;
      div.innerHTML = `
        <div class="flex justify-between items-center">
          <p>${notif.message}</p>
          <button onclick="dismissNotification('${notif.id}', this.parentElement.parentElement)" class="text-gray-500 hover:text-gray-700">X</button>
        </div>
      `;
      document.getElementById('notificationContainer').appendChild(div);
      setTimeout(() => dismissNotification(notif.id, div), 30000);
    }

    async function dismissNotification(id, element) {
      element.classList.add('fade-out');
      await new Promise(resolve => setTimeout(resolve, 300));
      element.remove();
      activeNotifications--;
      displayNextNotification();
      if (jwtToken) {
        await fetch(`${API_BASE}/mark-notification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
          body: JSON.stringify({ notificationId: id })
        });
      }
    }

    async function validateJwt() {
      if (!jwtToken) return false;
      const res = await fetch(`${API_BASE}/validate`, {
        headers: { 'Authorization': `Bearer ${jwtToken}` }
      });
      if (res.ok) {
        const data = await res.json();
        userData = data.data;
        return true;
      }
      return false;
    }

    function initializeWebSocket() {
      if (!jwtToken) return;
      ws = new WebSocket(`${WS_URL}?token=${jwtToken}`);
      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'update') {
          await fetchDashboardData();
        } else if (msg.type === 'notification') {
          showNotification(msg.message, msg.color || 'blue', msg.urgent || false);
        } else if (msg.type === 'logout') {
          logout();
          showNotification('Session expired, please login', 'red');
        } else if (msg.type === 'username_check') {
          const statusEl = document.getElementById('usernameStatus');
          statusEl.textContent = msg.message;
          statusEl.className = `text-sm mt-1 ${msg.available ? 'text-green-500' : 'text-red-500'}`;
        }
      };
      ws.onclose = () => {
        ws = null;
      };
    }

    function startSessionTimer() {
      clearTimeout(sessionTimer);
      clearTimeout(sessionGraceTimer);
      sessionTimer = setTimeout(() => {
        document.getElementById('sessionTimeoutModal').classList.remove('hidden');
        sessionGraceTimer = setTimeout(() => {
          logout();
          showNotification('Session expired', 'red');
        }, SESSION_GRACE);
      }, SESSION_TIMEOUT);
    }

    function formatTime(ms) {
      const minutes = Math.floor(ms / 60000);
      const seconds = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
      return `${minutes}:${seconds}`;
    }

    async function fetchDashboardData() {
      const res = await fetch(`${API_BASE}/data`, {
        headers: { 'Authorization': `Bearer ${jwtToken}` }
      });
      const data = await res.json();
      if (data.success) {
        userData = data.data.user;
        document.getElementById('welcomeMessage').textContent = `Welcome ${userData.name}, Your username is ${userData.username}`;
        document.getElementById('affiliateLink').value = `https://botblitz.store?ref=${userData.refCode}`;
        document.getElementById('linkClicks').textContent = userData.linkClicks;
        document.getElementById('totalSales').textContent = userData.totalSales;
        document.getElementById('monthlySales').textContent = userData.totalSalesMonthly;
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        nextMonth.setDate(1);
        const daysUntilReset = Math.ceil((nextMonth - new Date()) / (1000 * 60 * 60 * 24));
        document.getElementById('monthlyReset').textContent = `Resets in ${daysUntilReset} days`;
        document.getElementById('currentBalance').textContent = userData.currentBalance.toFixed(2);
        document.getElementById('withdrawnTotal').textContent = userData.withdrawnTotal.toFixed(2);
        document.getElementById('withdrawalAmount').max = userData.currentBalance;
        document.getElementById('requestWithdrawal').classList.toggle('opacity-50 cursor-not-allowed', userData.currentBalance < 1);

        // Withdrawal History
        const withdrawalTable = document.getElementById('withdrawalHistoryTable');
        withdrawalTable.innerHTML = '';
        data.data.withdrawals.slice(0, 20).forEach(w => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${new Date(w.timestamp).toLocaleString()}</td>
            <td class="p-2">${w.data.amount.toFixed(2)}</td>
            <td class="p-2">${w.data.mpesaNumber}</td>
            <td class="p-2">${w.data.mpesaName}</td>
            <td class="p-2">${w.status}</td>
            <td class="p-2">${w.data.mpesaRef || '-'}</td>
          `;
          withdrawalTable.appendChild(row);
        });

        // Rewards History
        const rewardsTable = document.getElementById('rewardsHistoryTable');
        rewardsTable.innerHTML = '';
        data.data.rewards.slice(0, 20).forEach(r => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${new Date(r.timestamp).toLocaleString()}</td>
            <td class="p-2">${r.data.type}</td>
            <td class="p-2">${r.data.amount.toFixed(2)}</td>
            <td class="p-2">${r.data.description}</td>
          `;
          rewardsTable.appendChild(row);
        });

        // Leaderboard
        const leaderboardTable = document.getElementById('leaderboardTable');
        leaderboardTable.innerHTML = '';
        data.data.leaderboard.slice(0, 10).forEach((a, i) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${i + 1}</td>
            <td class="p-2">${a.name}</td>
            <td class="p-2">${a.totalSalesMonthly}</td>
            <td class="p-2">${a.momentum || '-'}</td>
          `;
          leaderboardTable.appendChild(row);
        });

        // Notifications History
        const notificationsTable = document.getElementById('notificationsHistoryTable');
        notificationsTable.innerHTML = '';
        data.data.notifications.slice(0, 20).forEach(n => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${new Date(n.timestamp).toLocaleString()}</td>
            <td class="p-2">${n.data.message}</td>
            <td class="p-2">${n.read ? 'Read' : 'Unread'}</td>
          `;
          notificationsTable.appendChild(row);
          if (!n.read) showNotification(n.data.message, n.data.color || 'blue');
        });

        // News
        const newsList = document.getElementById('newsList');
        newsList.innerHTML = '';
        data.data.news.slice(0, 10).forEach(n => {
          const div = document.createElement('div');
          const isRead = localStorage.getItem(`news-${n.id}`);
          div.className = 'bg-white p-4 rounded theme-light';
          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm text-gray-500">${new Date(n.timestamp).toLocaleString()}</p>
                <p>${n.message}</p>
              </div>
              ${isRead ? '' : '<span class="bg-blue-500 text-white px-2 rounded">New</span>'}
            </div>
          `;
          div.addEventListener('click', () => {
            localStorage.setItem(`news-${n.id}`, 'read');
            div.querySelector('span')?.remove();
          });
          newsList.appendChild(div);
        });

        // Forums
        const forumsList = document.getElementById('forumsList');
        forumsList.innerHTML = '';
        data.data.forums.forEach(f => {
          const div = document.createElement('div');
          div.className = 'bg-white p-4 rounded theme-light cursor-pointer';
          div.innerHTML = `
            <div class="flex items-center">
              <img src="public/assets/${f.icon}" alt="${f.name}" class="w-12 h-12 mr-4">
              <div>
                <p class="text-base font-medium">${f.name}</p>
                <p class="text-sm text-gray-500">${f.description}</p>
              </div>
            </div>
          `;
          div.addEventListener('click', () => window.open(f.link, '_blank'));
          forumsList.appendChild(div);
        });

        // Commission Info
        document.getElementById('commissionText').textContent = `Commission = Sale Amount Ã— ${(data.data.commissionRate * 100).toFixed(0)}%`;
        document.getElementById('commissionExample').textContent = `Sale = 1000 KES, Rate = ${(data.data.commissionRate * 100).toFixed(0)}%, Commission = ${(1000 * data.data.commissionRate).toFixed(0)} KES`;
      }
    }

    async function fetchSettings() {
      const res = await fetch(`${API_BASE}/settings`);
      const data = await res.json();
      if (data.success) {
        document.getElementById('copyrightText').textContent = data.data.copyrightText;
        document.getElementById('whatsappLink').href = data.data.whatsappLink;
        document.getElementById('emailLink').href = `mailto:${data.data.supportEmail}`;
        const staticLinks = document.getElementById('staticLinks');
        staticLinks.innerHTML = '';
        data.data.staticPages.forEach(page => {
          const a = document.createElement('a');
          a.href = `/affiliate-${page.slug}`;
          a.className = 'text-blue-500 hover:underline mx-2';
          a.textContent = page.title;
          a.addEventListener('click', async (e) => {
            e.preventDefault();
            const res = await fetch(`${API_BASE}/static-page/${page.slug}`);
            const pageData = await res.json();
            if (pageData.success) {
              document.getElementById('staticPageTitle').textContent = pageData.data.title;
              document.getElementById('staticPageContent').innerHTML = pageData.data.content;
              document.getElementById('staticPageModal').classList.remove('hidden');
              applyTheme();
            }
          });
          staticLinks.appendChild(a);
        });
      }
    }

    function logout() {
      setCookie('jwt', '', 0);
      jwtToken = null;
      userData = null;
      if (ws) ws.close();
      ws = null;
      clearTimeout(sessionTimer);
      clearTimeout(sessionGraceTimer);
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('dashboardSection').classList.add('hidden');
      document.getElementById('contactUsBtn').classList.add('hidden');
      document.getElementById('settingsDropdown').classList.add('hidden');
      document.getElementById('welcomeMessage').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
      document.getElementById('otpForm').classList.add('hidden');
      document.getElementById('setNewPasswordForm').classList.add('hidden');
    }

    // Event Listeners
    document.getElementById('themeToggle').addEventListener('click', async () => {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      localStorage.setItem('theme', currentTheme);
      applyTheme();
      if (jwtToken) {
        await fetch(`${API_BASE}/update-theme`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
          body: JSON.stringify({ theme: currentTheme })
        });
      }
    });

    document.getElementById('loginToggle').addEventListener('click', () => {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
    });

    document.getElementById('signupToggle').addEventListener('click', () => {
      document.getElementById('signupForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('forgotPasswordForm').classList.add('hidden');
    });

    document.getElementById('forgotPasswordToggle').addEventListener('click', () => {
      document.getElementById('forgotPasswordForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('signupForm').classList.add('hidden');
    });

    document.getElementById('showLogin').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('loginToggle').click();
    });

    document.getElementById('showForgotPassword').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('forgotPasswordToggle').click();
    });

    document.getElementById('signupUsername').addEventListener('input', () => {
      const username = document.getElementById('signupUsername').value;
      if (username.length >= 5 && ws) {
        ws.send(JSON.stringify({ type: 'username_check', username }));
      } else {
        document.getElementById('usernameStatus').textContent = '';
      }
    });

    document.getElementById('signupPasswordToggle').addEventListener('click', () => {
      const input = document.getElementById('signupPassword');
      const toggle = document.getElementById('signupPasswordToggle');
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('loginPasswordToggle').addEventListener('click', () => {
      const input = document.getElementById('loginPassword');
      const toggle = document.getElementById('loginPasswordToggle');
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('newPasswordToggle').addEventListener('click', () => {
      const input = document.getElementById('newPassword');
      const toggle = document.getElementById('newPasswordToggle');
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('confirmPasswordToggle').addEventListener('click', () => {
      const input = document.getElementById('confirmPassword');
      const toggle = document.getElementById('confirmPasswordToggle');
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('signupSubmit').addEventListener('click', async () => {
      const name = document.getElementById('signupName').value;
      const username = document.getElementById('signupUsername').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const terms = document.getElementById('signupTerms').checked;
      const recaptcha = document.getElementById('signupRecaptcha').checked;

      // Client-side validation
      if (!name.match(/^[a-zA-Z\s]+\s+[a-zA-Z\s]+$/)) {
        showNotification('Full name must contain at least two words', 'red');
        return;
      }
      if (!username.match(/^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{5,}$/)) {
        showNotification('Username must be at least 5 characters with 1 letter and 1 number', 'red');
        return;
      }
      if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        showNotification('Invalid email format', 'red');
        return;
      }
      if (!password.match(/^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{8,}$/)) {
        showNotification('Password must be at least 8 characters with 1 letter and 1 number', 'red');
        return;
      }
      if (!terms) {
        showNotification('You must agree to the Terms & Conditions', 'red');
        return;
      }
      if (!recaptcha) {
        showNotification('Please complete the reCAPTCHA', 'red');
        return;
      }

      document.getElementById('signupSubmit').classList.add('opacity-50', 'cursor-not-allowed');
      const recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' });
      const res = await fetch(`${API_BASE}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, username, email, password, termsAccepted: true, recaptchaToken })
      });
      const data = await res.json();
      document.getElementById('signupSubmit').classList.remove('opacity-50', 'cursor-not-allowed');

      if (data.success) {
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('otpForm').classList.remove('hidden');
        document.getElementById('otpMessage').textContent = `A one-time password has been sent to ${email}. It expires in 5 minutes.`;
        otpContext = { type: 'signup', email };
        startOtpTimer();
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('loginSubmit').addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const recaptcha = document.getElementById('loginRecaptcha').checked;

      if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        showNotification('Invalid email format', 'red');
        return;
      }
      if (!recaptcha) {
        showNotification('Please complete the reCAPTCHA', 'red');
        return;
      }

      document.getElementById('loginSubmit').classList.add('opacity-50', 'cursor-not-allowed');
      const recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' });
      const res = await fetch(`${API_BASE}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, recaptchaToken })
      });
      const data = await res.json();
      document.getElementById('loginSubmit').classList.remove('opacity-50', 'cursor-not-allowed');

      if (data.success) {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('otpForm').classList.remove('hidden');
        document.getElementById('otpMessage').textContent = `A one-time password has been sent to ${email}. It expires in 5 minutes.`;
        otpContext = { type: 'login', email };
        startOtpTimer();
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('forgotSubmit').addEventListener('click', async () => {
      const email = document.getElementById('forgotEmail').value;
      const recaptcha = document.getElementById('forgotRecaptcha').checked;

      if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        showNotification('Invalid email format', 'red');
        return;
      }
      if (!recaptcha) {
        showNotification('Please complete the reCAPTCHA', 'red');
        return;
      }

      document.getElementById('forgotSubmit').classList.add('opacity-50', 'cursor-not-allowed');
      const recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit' });
      const res = await fetch(`${API_BASE}/reset-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, recaptchaToken })
      });
      const data = await res.json();
      document.getElementById('forgotSubmit').classList.remove('opacity-50', 'cursor-not-allowed');

      if (data.success) {
        document.getElementById('forgotPasswordForm').classList.add('hidden');
        document.getElementById('otpForm').classList.remove('hidden');
        document.getElementById('otpMessage').textContent = `A one-time password has been sent to ${email}. It expires in 5 minutes.`;
        otpContext = { type: 'reset', email };
        startOtpTimer();
      } else {
        showNotification(data.error, 'red');
      }
    });

    function startOtpTimer() {
      clearInterval(otpTimer);
      clearInterval(otpResendTimer);
      clearInterval(otpBlockTimer);
      let timeLeft = OTP_DURATION;
      document.getElementById('otpCountdown').textContent = `Expires in ${formatTime(timeLeft)}`;
      document.getElementById('otpResend').textContent = `Resend code in ${formatTime(timeLeft)}`;
      document.getElementById('otpResend').classList.add('opacity-50', 'cursor-not-allowed');
      otpTimer = setInterval(() => {
        timeLeft -= 1000;
        document.getElementById('otpCountdown').textContent = `Expires in ${formatTime(timeLeft)}`;
        document.getElementById('otpResend').textContent = `Resend code in ${formatTime(timeLeft)}`;
        if (timeLeft <= 0) {
          clearInterval(otpTimer);
          document.getElementById('otpCountdown').textContent = 'OTP expired';
          document.getElementById('otpResend').textContent = 'Resend Code';
          document.getElementById('otpResend').classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }, 1000);
    }

    document.getElementById('otpResend').addEventListener('click', async () => {
      if (document.getElementById('otpResend').classList.contains('cursor-not-allowed')) return;
      // Check rate limit (simulated, actual check on server)
      const res = await fetch(`${API_BASE}/resend-otp`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: otpContext.email, type: otpContext.type })
      });
      const data = await res.json();
      if (data.success) {
        showNotification('OTP resent', 'green');
        startOtpTimer();
      } else {
        showNotification(data.error, 'red');
        if (data.error.includes('rate limit')) {
          let blockTime = OTP_BLOCK_DURATION;
          document.getElementById('otpResend').classList.add('opacity-50', 'cursor-not-allowed');
          otpBlockTimer = setInterval(() => {
            blockTime -= 1000;
            document.getElementById('otpResend').textContent = `Resend blocked for ${formatTime(blockTime)}`;
            if (blockTime <= 0) {
              clearInterval(otpBlockTimer);
              document.getElementById('otpResend').textContent = 'Resend Code';
              document.getElementById('otpResend').classList.remove('opacity-50', 'cursor-not-allowed');
            }
          }, 1000);
        }
      }
    });

    document.getElementById('otpVerify').addEventListener('click', async () => {
      const otp = document.getElementById('otpInput').value;
      if (!otp.match(/^\d{6}$/)) {
        showNotification('OTP must be 6 digits', 'red');
        return;
      }

      document.getElementById('otpVerify').classList.add('opacity-50', 'cursor-not-allowed');
      let endpoint;
      if (otpContext.type === 'signup') endpoint = 'verify-signup-otp';
      else if (otpContext.type === 'login') endpoint = 'verify-login-otp';
      else if (otpContext.type === 'reset') endpoint = 'verify-reset-otp';
      else if (otpContext.type === 'withdrawal') endpoint = 'verify-withdrawal-otp';
      else if (otpContext.type === 'change-password') endpoint = 'verify-password-otp';
      else if (otpContext.type === 'delete') endpoint = 'verify-delete-otp';

      const body = { email: otpContext.email, otp };
      if (otpContext.type === 'withdrawal') {
        body.amount = otpContext.amount;
        body.mpesaNumber = otpContext.mpesaNumber;
        body.mpesaName = otpContext.mpesaName;
        body.reuseDetails = otpContext.reuseDetails;
      }

      const res = await fetch(`${API_BASE}/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(jwtToken && { 'Authorization': `Bearer ${jwtToken}` }) },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      document.getElementById('otpVerify').classList.remove('opacity-50', 'cursor-not-allowed');

      if (data.success) {
        clearInterval(otpTimer);
        document.getElementById('otpForm').classList.add('hidden');
        if (otpContext.type === 'signup' || otpContext.type === 'login') {
          jwtToken = data.token;
          setCookie('jwt', jwtToken, 604800);
          userData = data.data;
          document.getElementById('loadingOverlay').classList.remove('hidden');
          await new Promise(resolve => setTimeout(resolve, 2000));
          document.getElementById('loadingOverlay').classList.add('hidden');
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('dashboardSection').classList.remove('hidden');
          document.getElementById('contactUsBtn').classList.remove('hidden');
          document.getElementById('settingsDropdown').classList.remove('hidden');
          document.getElementById('welcomeMessage').classList.remove('hidden');
          initializeWebSocket();
          await fetchDashboardData();
          startSessionTimer();
          showNotification(otpContext.type === 'signup' ? 'Account created successfully' : 'Logged in successfully', 'green');
        } else if (otpContext.type === 'reset') {
          document.getElementById('setNewPasswordForm').classList.remove('hidden');
        } else if (otpContext.type === 'withdrawal') {
          await fetchDashboardData();
          showNotification('Withdrawal submitted', 'green');
        } else if (otpContext.type === 'change-password') {
          logout();
          showNotification('Password changed, please login again', 'green');
        } else if (otpContext.type === 'delete') {
          logout();
          showNotification('Account deleted', 'green');
        }
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('setNewPasswordSubmit').addEventListener('click', async () => {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!newPassword.match(/^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{8,}$/)) {
        showNotification('Password must be at least 8 characters with 1 letter and 1 number', 'red');
        return;
      }
      if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'red');
        return;
      }

      document.getElementById('setNewPasswordSubmit').classList.add('opacity-50', 'cursor-not-allowed');
      const res = await fetch(`${API_BASE}/set-new-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: otpContext.email, newPassword })
      });
      const data = await res.json();
      document.getElementById('setNewPasswordSubmit').classList.remove('opacity-50', 'cursor-not-allowed');

      if (data.success) {
        document.getElementById('setNewPasswordForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        showNotification('Password reset successfully', 'green');
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('settingsDropdown').addEventListener('click', () => {
      document.getElementById('settingsMenu').classList.toggle('hidden');
    });

    document.getElementById('contactUsBtn').addEventListener('click', () => {
      document.getElementById('contactUsModal').classList.remove('hidden');
      applyTheme();
    });

    document.getElementById('closeContactUs').addEventListener('click', () => {
      document.getElementById('contactUsModal').classList.add('hidden');
    });

    document.getElementById('commissionInfoBtn').addEventListener('click', () => {
      document.getElementById('commissionInfoModal').classList.remove('hidden');
      applyTheme();
    });

    document.getElementById('closeCommissionInfo').addEventListener('click', () => {
      document.getElementById('commissionInfoModal').classList.add('hidden');
    });

    document.getElementById('changePasswordBtn').addEventListener('click', () => {
      document.getElementById('settingsMenu').classList.add('hidden');
      document.getElementById('changePasswordModal').classList.remove('hidden');
      applyTheme();
    });

    document.getElementById('closeChangePassword').addEventListener('click', () => {
      document.getElementById('changePasswordModal').classList.add('hidden');
    });

    document.getElementById('currentPasswordToggle').addEventListener('click', () => {
      const input = document.getElementById('currentPassword');
      const toggle = document.getElementById('currentPasswordToggle');
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('changeNewPasswordToggle').addEventListener('click', () => {
      const input = document.getElementById('changeNewPassword');
      const toggle = document.getElementById('changeNewPasswordToggle');
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('changeConfirmPasswordToggle').addEventListener('click', () => {
      const input = document.getElementById('changeConfirmPassword');
      const toggle = document.getElementById('changeConfirmPasswordToggle');
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    document.getElementById('changePasswordSubmit').addEventListener('click', async () => {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('changeNewPassword').value;
      const confirmPassword = document.getElementById('changeConfirmPassword').value;

      if (!newPassword.match(/^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{8,}$/)) {
        showNotification('New password must be at least 8 characters with 1 letter and 1 number', 'red');
        return;
      }
      if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'red');
        return;
      }

      document.getElementById('changePasswordSubmit').classList.add('opacity-50', 'cursor-not-allowed');
      const res = await fetch(`${API_BASE}/update-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
        body: JSON.stringify({ currentPassword, newPassword })
      });
      const data = await res.json();
      document.getElementById('changePasswordSubmit').classList.remove('opacity-50', 'cursor-not-allowed');

      if (data.success) {
        document.getElementById('changePasswordModal').classList.add('hidden');
        document.getElementById('otpForm').classList.remove('hidden');
        document.getElementById('otpMessage').textContent = `A one-time password has been sent to ${userData.email}. It expires in 5 minutes.`;
        otpContext = { type: 'change-password', email: userData.email };
        startOtpTimer();
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('deleteAccountBtn').addEventListener('click', () => {
      document.getElementById('settingsMenu').classList.add('hidden');
      document.getElementById('deleteAccountModal').classList.remove('hidden');
      applyTheme();
    });

    document.getElementById('closeDeleteAccount').addEventListener('click', () => {
      document.getElementById('deleteAccountModal').classList.add('hidden');
    });

    document.getElementById('confirmDelete').addEventListener('click', async () => {
      document.getElementById('deleteAccountModal').classList.add('hidden');
      document.getElementById('otpForm').classList.remove('hidden');
      document.getElementById('otpMessage').textContent = `A one-time password has been sent to ${userData.email}. It expires in 5 minutes.`;
      otpContext = { type: 'delete', email: userData.email };
      startOtpTimer();
      await fetch(`${API_BASE}/request-delete-otp`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
        body: JSON.stringify({ email: userData.email })
      });
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      document.getElementById('settingsMenu').classList.add('hidden');
      logout();
      showNotification('Logged out successfully', 'green');
    });

    document.getElementById('sessionYes').addEventListener('click', async () => {
      const password = document.getElementById('sessionPassword').value;
      const res = await fetch(`${API_BASE}/verify-session`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
        body: JSON.stringify({ password })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('sessionTimeoutModal').classList.add('hidden');
        startSessionTimer();
        if (ws) ws.close();
        initializeWebSocket();
      } else {
        showNotification('Invalid password', 'red');
      }
    });

    document.getElementById('sessionNo').addEventListener('click', () => {
      document.getElementById('sessionTimeoutModal').classList.add('hidden');
      logout();
      showNotification('Logged out successfully', 'green');
    });

    document.getElementById('copyLink').addEventListener('click', async () => {
      const link = document.getElementById('affiliateLink').value;
      try {
        await navigator.clipboard.writeText(link);
        showNotification('Link copied to clipboard', 'green');
      } catch {
        const textarea = document.createElement('textarea');
        textarea.value = link;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showNotification('Link copied to clipboard', 'green');
      }
    });

    document.getElementById('editMpesaDetails').addEventListener('click', () => {
      document.getElementById('withdrawalMpesaNumber').value = '';
      document.getElementById('withdrawalMpesaName').value = '';
      document.getElementById('reuseDetails').checked = false;
    });

    document.getElementById('requestWithdrawal').addEventListener('click', async () => {
      if (document.getElementById('requestWithdrawal').classList.contains('cursor-not-allowed')) return;
      const amount = parseFloat(document.getElementById('withdrawalAmount').value);
      const mpesaNumber = document.getElementById('withdrawalMpesaNumber').value;
      const mpesaName = document.getElementById('withdrawalMpesaName').value;
      const reuseDetails = document.getElementById('reuseDetails').checked;

      if (amount <= 0 || amount > userData.currentBalance) {
        showNotification('Invalid amount', 'red');
        return;
      }
      if (!mpesaNumber.match(/^0[17]\d{8}$/)) {
        showNotification('MPESA number must be 10 digits starting with 07 or 01', 'red');
        return;
      }
      if (!mpesaName.match(/^[a-zA-Z\s]+\s+[a-zA-Z\s]+$/)) {
        showNotification('MPESA name must contain at least two words', 'red');
        return;
      }

      const res = await fetch(`${API_BASE}/request-withdrawal-otp`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
        body: JSON.stringify({ email: userData.email, amount, mpesaNumber, mpesaName, reuseDetails })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('otpForm').classList.remove('hidden');
        document.getElementById('dashboardSection').classList.add('hidden');
        document.getElementById('otpMessage').textContent = `A one-time password has been sent to ${userData.email}. It expires in 5 minutes.`;
        otpContext = { type: 'withdrawal', email: userData.email, amount, mpesaNumber, mpesaName, reuseDetails };
        startOtpTimer();
      } else {
        showNotification(data.error, 'red');
      }
    });

    const tabs = ['homeTab', 'withdrawalHistoryTab', 'rewardsHistoryTab', 'leaderboardTab', 'notificationsHistoryTab', 'newsTab', 'marketingTab'];
    tabs.forEach(tab => {
      document.getElementById(`tab${tab.replace('Tab', '')}`).addEventListener('click', () => {
        tabs.forEach(t => {
          document.getElementById(t).classList.add('hidden');
          document.getElementById(`tab${t.replace('Tab', '')}`).classList.remove('bg-blue-500');
          document.getElementById(`tab${t.replace('Tab', '')}`).classList.add('bg-gray-500');
        });
        document.getElementById(tab).classList.remove('hidden');
        document.getElementById(`tab${tab.replace('Tab', '')}`).classList.remove('bg-gray-500');
        document.getElementById(`tab${tab.replace('Tab', '')}`).classList.add('bg-blue-500');
      });
    });

    document.getElementById('closeStaticPage').addEventListener('click', () => {
      document.getElementById('staticPageModal').classList.add('hidden');
    });

    // Initialization
    (async () => {
      applyTheme();
      await fetchSettings();
      const isAuthenticated = await validateJwt();
      if (isAuthenticated) {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');
        document.getElementById('contactUsBtn').classList.remove('hidden');
        document.getElementById('settingsDropdown').classList.remove('hidden');
        document.getElementById('welcomeMessage').classList.remove('hidden');
        initializeWebSocket();
        await fetchDashboardData();
        startSessionTimer();

        // Check for urgent popup from settings
        const settingsRes = await fetch(`${API_BASE}/settings`);
        const settingsData = await settingsRes.json();
        if (settingsData.success && settingsData.data.urgentPopup.enabled) {
          showNotification(settingsData.data.urgentPopup.message, 'red', true);
        }
      } else {
        document.getElementById('loginForm').classList.remove('hidden');
      }
      document.getElementById('loadingOverlay').classList.add('hidden');
    })();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (ws) ws.close();
    });
  </script>
</body>
</html>
