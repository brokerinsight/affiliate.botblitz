<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deriv Bot Store Affiliates</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google reCAPTCHA v3 -->
  <script src="https://www.google.com/recaptcha/api.js?render=6LcJnj0rAAAAANGq6tGazaBo5aPBcUr_IrUwdbi7"></script>
  <!-- jwt-decode for JWT parsing -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/lib/jwt-decode.min.js"></script>
  <style>
    /* Custom animations */
    .slide-in {
      animation: slideIn 0.3s ease-in-out forwards;
    }
    .fade-out {
      animation: fadeOut 0.3s forwards;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    /* Card hover effect */
    .card-hover:hover {
      transform: translateY(-2px);
      transition: transform 0.2s;
    }
    /* Theme-specific styles */
    .theme-light { background-color: #ffffff; color: #000000; }
    .theme-dark { background-color: #1f2937; color: #d1d5db; }
    /* Focus styles */
    input:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
    }
    button:focus {
      outline: none;
    }
    #signupSubmit:focus, #loginSubmit:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
    }
    /* Loading spinner */
    .spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen font-sans">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="text-center text-lg text-white">Initializing account, loading data...</div>
  </div>

  <!-- Header -->
  <header class="p-4 border-b theme-light" id="header">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <!-- Logo -->
      <div class="flex items-center">
        <img src="assets/logo.png" alt="Deriv Bot Store Affiliates" class="h-8" id="logo" onerror="this.onerror=null; this.remove(); document.getElementById('logoFallback').classList.remove('hidden');">
        <span id="logoFallback" class="text-2xl font-bold hidden">Deriv Bot Store Affiliates</span>
        <div id="welcomeMessage" class="ml-4 text-sm text-gray-500 hidden"></div>
      </div>
      <!-- Navigation -->
      <div class="flex items-center space-x-2">
        <button id="contactUsBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 hidden">Contact Us</button>
        <div id="settingsDropdown" class="relative hidden">
          <button class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex items-center">
            <img src="assets/setting.png" alt="Settings" class="w-6 h-6 mr-2" onerror="this.onerror=null; this.remove();"> Settings
          </button>
          <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden theme-light" id="settingsMenu">
            <button id="changePasswordBtn" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100">Change Password</button>
            <button id="deleteAccountBtn" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100">Delete Account</button>
            <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100">Logout</button>
          </div>
        </div>
        <!-- Theme Toggle -->
        <button id="themeToggle" aria-label="Toggle theme" class="p-2 rounded-md hover:bg-gray-200">
          <svg id="sunIcon" class="w-6 h-6" fill="#f3f4f6" viewBox="0 0 24 24">
            <path d="M12 18a6 6 0 100-12 6 6 0 000 12zm0 2a8 8 0 110-16 8 8 0 010 16zM11 4V2h2v2h-2zm0 18v-2h2v2h-2zM4 11H2v2h2v-2zm18 0h-2v2h2v-2zM5.636 5.636l-1.414-1.414 1.414 1.414zm12.728 12.728l1.414-1.414-1.414 1.414zM5.636 18.364l1.414-1.414-1.414 1.414zm12.728-12.728l-1.414-1.414 1.414 1.414z"/>
          </svg>
          <svg id="moonIcon" class="w-6 h-6 hidden" fill="#1f2937" viewBox="0 0 24 24">
            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2a10.002 10.002 0 00-8.66 14.99A9.97 9.97 0 0012 22zm0-2A8 8 0 016.343 6.343 8 8 0 0112 4a8 8 0 018 8 8 8 0 01-8 8z"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto p-4">
    <!-- Auth Forms -->
    <div id="authSection" class="theme-light">
      <!-- Toggle Buttons -->
      <div class="flex justify-center space-x-2 mb-4">
        <button id="loginToggle" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md">Login</button>
        <button id="signupToggle" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md">Sign Up</button>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto">
        <h2 class="text-lg font-bold mb-4">Login</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="loginEmail">Email</label>
            <input type="email" id="loginEmail" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="loginPassword">Password</label>
            <div class="relative">
              <input type="password" id="loginPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
              <button type="button" id="loginPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="loginRecaptcha" required aria-required="true">
            <label class="ml-2 text-sm text-gray-700" for="loginRecaptcha">I am not a robot (reCAPTCHA)</label>
          </div>
          <button id="loginSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">
            <span id="loginSubmitText">Login</span>
            <span id="loginSubmitSpinner" class="spinner hidden"></span>
          </button>
          <p class="text-center text-sm">
            <a href="#" id="showForgotPassword" class="text-blue-500 hover:underline">Forgot Password?</a>
          </p>
        </div>
      </div>

      <!-- Sign-Up Form -->
      <div id="signupForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 class="text-lg font-bold mb-4">Sign Up</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="signupName">Full Name</label>
            <input type="text" id="signupName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="signupUsername">Username</label>
            <input type="text" id="signupUsername" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
            <p id="usernameStatus" class="text-sm mt-1"></p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="signupEmail">Email</label>
            <input type="email" id="signupEmail" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="signupPassword">Password</label>
            <div class="relative">
              <input type="password" id="signupPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
              <button type="button" id="signupPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="signupTerms" required aria-required="true">
            <label class="ml-2 text-sm text-gray-700" for="signupTerms">I agree to the <a href="/affiliate-terms" class="text-blue-500 hover:underline">Terms & Conditions</a></label>
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="signupRecaptcha" required aria-required="true">
            <label class="ml-2 text-sm text-gray-700" for="signupRecaptcha">I am not a robot (reCAPTCHA)</label>
          </div>
          <button id="signupSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:ring-2 focus:ring-blue-500">
            <span id="signupSubmitText">Create Account</span>
            <span id="signupSubmitSpinner" class="spinner hidden"></span>
          </button>
          <p class="text-center text-sm">
            Already have an account? <a href="#" id="showLogin" class="text-blue-500 hover:underline">Login</a>
          </p>
        </div>
      </div>

      <!-- Forgot Password Form -->
      <div id="forgotPasswordForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 class="text-lg font-bold mb-4">Forgot Password</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="forgotEmail">Email</label>
            <input type="email" id="forgotEmail" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="forgotRecaptcha" required aria-required="true">
            <label class="ml-2 text-sm text-gray-700" for="forgotRecaptcha">I am not a robot (reCAPTCHA)</label>
          </div>
          <button id="forgotSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
            <span id="forgotSubmitText">Submit</span>
            <span id="forgotSubmitSpinner" class="spinner hidden"></span>
          </button>
        </div>
      </div>

      <!-- OTP Verification Form (Shared) -->
      <div id="otpForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 id="otpTitle" class="text-lg font-bold mb-4">Verify Your Email Address</h2>
        <p id="otpMessage" class="mb-4"></p>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="otpInput">One-Time Password</label>
            <input type="text" id="otpInput" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" maxlength="6" required aria-required="true">
          </div>
          <p id="otpCountdown" class="text-sm text-gray-500"></p>
          <button id="otpResend" class="w-full bg-gray-500 text-white px-4 py-2 rounded-md opacity-50 cursor-not-allowed">
            <span id="otpResendText">Resend Code</span>
            <span id="otpResendSpinner" class="spinner hidden"></span>
          </button>
          <button id="otpVerify" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
            <span id="otpVerifyText">Verify</span>
            <span id="otpVerifySpinner" class="spinner hidden"></span>
          </button>
        </div>
      </div>

      <!-- Set New Password Form -->
      <div id="setNewPasswordForm" class="bg-white p-6 rounded-lg shadow max-w-md mx-auto hidden">
        <h2 class="text-lg font-bold mb-4">Set New Password</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="newPassword">New Password</label>
            <div class="relative">
              <input type="password" id="newPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
              <button type="button" id="newPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="confirmPassword">Confirm Password</label>
            <div class="relative">
              <input type="password" id="confirmPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
              <button type="button" id="confirmPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
            </div>
          </div>
          <button id="setNewPasswordSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
            <span id="setNewPasswordSubmitText">Submit</span>
            <span id="setNewPasswordSubmitSpinner" class="spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Dashboard (Post-Authentication) -->
    <div id="dashboardSection" class="hidden">
      <!-- Navigation Tabs -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="tabHome" class="bg-blue-500 text-white px-4 py-2 rounded-md">Home</button>
        <button id="tabWithdrawalHistory" class="bg-gray-500 text-white px-4 py-2 rounded-md">Withdrawal History</button>
        <button id="tabRewardsHistory" class="bg-gray-500 text-white px-4 py-2 rounded-md">Rewards History</button>
        <button id="tabLeaderboard" class="bg-gray-500 text-white px-4 py-2 rounded-md">Leaderboard</button>
        <button id="tabNotificationsHistory" class="bg-gray-500 text-white px-4 py-2 rounded-md">Notifications History</button>
        <button id="tabNews" class="bg-gray-500 text-white px-4 py-2 rounded-md">News</button>
        <button id="tabMarketing" class="bg-gray-500 text-white px-4 py-2 rounded-md">Marketing</button>
      </div>

      <!-- Home Tab -->
      <div id="homeTab">
        <div id="dashboardWelcome" class="mb-4 text-sm text-gray-500"></div>
        <div class="mb-4">
          <label class="block text-sm font-medium">Affiliate Link</label>
          <div class="flex">
            <input id="affiliateLink" class="w-full p-2 border rounded" readonly aria-label="Affiliate Link">
            <button id="copyLink" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 ml-2">Copy</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Link Clicks</h3>
            <p id="linkClicks" class="text-lg">0</p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Total Sales</h3>
            <p id="totalSales" class="text-lg">0</p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Monthly Sales</h3>
            <p id="monthlySales" class="text-lg">0</p>
            <p id="monthlyReset" class="text-sm text-gray-500"></p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Current Balance (KES)</h3>
            <p id="currentBalance" class="text-lg">0.00</p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow card-hover theme-light">
            <h3 class="font-medium">Total Withdrawn (KES)</h3>
            <p id="withdrawnTotal" class="text-lg">0.00</p>
          </div>
        </div>
        <button id="commissionInfoBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mb-4">Commission Info</button>
        <div class="bg-white p-4 rounded-lg shadow theme-light">
          <h3 class="font-medium mb-2">Request Withdrawal</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium" for="withdrawalAmount">Amount (KES)</label>
              <input type="number" id="withdrawalAmount" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
            </div>
            <div>
              <label class="block text-sm font-medium" for="withdrawalMpesaNumber">MPESA Number</label>
              <input type="text" id="withdrawalMpesaNumber" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
            </div>
            <div>
              <label class="block text-sm font-medium" for="withdrawalMpesaName">MPESA Name</label>
              <input type="text" id="withdrawalMpesaName" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
            </div>
            <div class="flex items-center">
              <input type="checkbox" id="reuseDetails" aria-label="Reuse Details">
              <label class="ml-2 text-sm" for="reuseDetails">Reuse Details</label>
            </div>
            <button id="editMpesaDetails" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Edit MPESA Details</button>
            <button id="requestWithdrawal" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
              <span id="requestWithdrawalText">Request Withdrawal</span>
              <span id="requestWithdrawalSpinner" class="spinner hidden"></span>
            </button>
          </div>
        </div>
      </div>

      <!-- Withdrawal History Tab -->
      <div id="withdrawalHistoryTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the last 20 withdrawals are shown.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-left">Amount (KES)</th>
              <th class="p-2 text-left">MPESA Number</th>
              <th class="p-2 text-left">MPESA Name</th>
              <th class="p-2 text-left">Status</th>
              <th class="p-2 text-left">MPESA Ref</th>
            </tr>
          </thead>
          <tbody id="withdrawalHistoryTable"></tbody>
        </table>
        <div class="flex justify-between mt-4">
          <button id="withdrawalPrevPage" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600" disabled>Previous</button>
          <span id="withdrawalPageNumber" class="text-sm text-gray-500">Page 1</span>
          <button id="withdrawalNextPage" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Next</button>
        </div>
      </div>

      <!-- Rewards History Tab -->
      <div id="rewardsHistoryTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the last 20 rewards are shown.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-left">Type</th>
              <th class="p-2 text-left">Amount (KES)</th>
              <th class="p-2 text-left">Description</th>
            </tr>
          </thead>
          <tbody id="rewardsHistoryTable"></tbody>
        </table>
        <div class="flex justify-between mt-4">
          <button id="rewardsPrevPage" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600" disabled>Previous</button>
          <span id="rewardsPageNumber" class="text-sm text-gray-500">Page 1</span>
          <button id="rewardsNextPage" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Next</button>
        </div>
      </div>

      <!-- Leaderboard Tab -->
      <div id="leaderboardTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the first 10 affiliates appear here.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Rank</th>
              <th class="p-2 text-left">Affiliate Name</th>
              <th class="p-2 text-left">Monthly Sales</th>
              <th class="p-2 text-left">Momentum</th>
            </tr>
          </thead>
          <tbody id="leaderboardTable"></tbody>
        </table>
      </div>

      <!-- Notifications History Tab -->
      <div id="notificationsHistoryTab" class="hidden">
        <p class="text-sm text-gray-500 mb-2">Only the last 20 notifications appear here.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 theme-light">
              <th class="p-2 text-left">Timestamp</th>
              <th class="p-2 text-left">Message</th>
              <th class="p-2 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="notificationsHistoryTable"></tbody>
        </table>
        <div class="flex justify-between mt-4">
          <button id="notificationsPrevPage" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600" disabled>Previous</button>
          <span id="notificationsPageNumber" class="text-sm text-gray-500">Page 1</span>
          <button id="notificationsNextPage" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Next</button>
        </div>
      </div>

      <!-- News Tab -->
      <div id="newsTab" class="hidden">
        <div id="newsList" class="space-y-4"></div>
      </div>

      <!-- Marketing Tab -->
      <div id="marketingTab" class="hidden">
        <p class="text-lg font-medium mb-4">Join our forums for free marketing videos and guidance</p>
        <div id="forumsList" class="space-y-4"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="p-4 border-t text-center text-sm text-gray-500 theme-light" id="footer">
    <div id="staticLinks" class="mb-2"></div>
    <p id="copyrightText"></p>
    <p>Deriv Bot Store Affiliates 2025</p>
  </footer>

  <!-- Modals -->
  <!-- Contact Us Modal -->
  <div id="contactUsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Contact Us</h2>
      <div class="space-y-4">
        <a id="whatsappLink" href="https://wa.link/4wppln" class="flex items-center bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
          <img src="assets/whatsapp.png" alt="WhatsApp" class="w-6 h-6 mr-2" onerror="this.onerror=null; this.remove();"> WhatsApp
        </a>
        <a id="emailLink" href="mailto:derivbotstore@gmail.com" class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
          <img src="assets/email.png" alt="Email" class="w-6 h-6 mr-2" onerror="this.onerror=null; this.remove();"> Email
        </a>
      </div>
      <button id="closeContactUs" class="mt-4 text-gray-500 hover:text-gray-700">Close</button>
    </div>
  </div>

  <!-- Commission Info Modal -->
  <div id="commissionInfoModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Commission Info</h2>
      <p id="commissionText" class="mb-2">Commission = Sale Amount × 20%</p>
      <p id="commissionExample" class="mb-4">Sale = 1000 KES, Rate = 20%, Commission = 200 KES</p>
      <button id="closeCommissionInfo" class="text-gray-500 hover:text-gray-700">Close</button>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Change Password</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium" for="currentPassword">Current Password</label>
          <div class="relative">
            <input type="password" id="currentPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
            <button type="button" id="currentPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium" for="changeNewPassword">New Password</label>
          <div class="relative">
            <input type="password" id="changeNewPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
            <button type="button" id="changeNewPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium" for="changeConfirmPassword">Confirm Password</label>
          <div class="relative">
            <input type="password" id="changeConfirmPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
            <button type="button" id="changeConfirmPasswordToggle" class="absolute right-2 top-2 text-gray-500">Show</button>
          </div>
        </div>
        <button id="changePasswordSubmit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
          <span id="changePasswordSubmitText">Submit</span>
          <span id="changePasswordSubmitSpinner" class="spinner hidden"></span>
        </button>
        <button id="closeChangePassword" class="w-full text-gray-500 hover:text-gray-700 mt-2">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div id="deleteAccountModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Delete Account</h2>
      <p class="mb-4">Are you sure you want to delete your account? This action cannot be undone.</p>
      <button id="confirmDelete" class="w-full bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
        <span id="confirmDeleteText">Delete</span>
        <span id="confirmDeleteSpinner" class="spinner hidden"></span>
      </button>
      <button id="closeDeleteAccount" class="w-full text-gray-500 hover:text-gray-700 mt-2">Cancel</button>
    </div>
  </div>

  <!-- Session Timeout Modal -->
  <div id="sessionTimeoutModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 class="text-xl font-bold mb-4">Are you still there?</h2>
      <p class="mb-4">Your session will expire in 4 minutes unless you verify your password.</p>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium" for="sessionPassword">Password</label>
          <input type="password" id="sessionPassword" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500" required aria-required="true">
        </div>
        <button id="sessionYes" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
          <span id="sessionYesText">Yes</span>
          <span id="sessionYesSpinner" class="spinner hidden"></span>
        </button>
        <button id="sessionNo" class="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">No</button>
      </div>
    </div>
  </div>

  <!-- Static Page Modal -->
  <div id="staticPageModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg max-w-md theme-light">
      <h2 id="staticPageTitle" class="text-xl font-bold mb-4"></h2>
      <div id="staticPageContent" class="prose"></div>
      <button id="closeStaticPage" class="mt-4 text-gray-500 hover:text-gray-700">Close</button>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer" class="fixed top-4 right-4 space-y-2 max-w-xs"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM fully loaded and ready');

      // Constants
      const API_BASE = 'https://affiliate-botblitz.onrender.com/api/affiliate';
      const WS_URL = 'wss://affiliate-botblitz.onrender.com/ws/affiliate';
      const RECAPTCHA_SITE_KEY = '6LcJnj0rAAAAANGq6tGazaBo5aPBcUr_IrUwdbi7';
      const SESSION_TIMEOUT = 10 * 60 * 1000;
      const SESSION_GRACE = 4 * 60 * 1000;
      const OTP_DURATION = 5 * 60 * 1000;
      const RATE_LIMIT_DURATION = 10 * 60 * 1000;
      const OTP_RATE_LIMIT_DURATION = 20 * 60 * 1000;
      const OTP_BLOCK_DURATION = 30 * 60 * 1000;
      const ITEMS_PER_PAGE = 10;

      // State
      let jwtToken = getCookie('jwt');
      let ws = null;
      let userData = null;
      let notificationsQueue = [];
      let activeNotifications = 0;
      let sessionTimer = null;
      let sessionGraceTimer = null;
      let otpTimer = null;
      let otpResendTimer = null;
      let otpBlockTimer = null;
      let currentTheme = localStorage.getItem('theme') || 'light';
      let otpContext = null;
      let urgentPopupDismissed = localStorage.getItem('urgentPopupDismissed') || false;
      let withdrawalPage = 1;
      let rewardsPage = 1;
      let notificationsPage = 1;
      let allWithdrawals = [];
      let allRewards = [];
      let allNotifications = [];

      // Utility Functions
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      function setCookie(name, value, maxAge) {
        document.cookie = `${name}=${value}; max-age=${maxAge}; path=/; secure; httpOnly`;
      }

      function applyTheme() {
        console.log('Applying theme:', currentTheme);
        const elements = document.querySelectorAll('.theme-light, .theme-dark');
        elements.forEach(el => {
          if (currentTheme === 'light') {
            el.classList.remove('theme-dark', 'bg-gray-800', 'text-gray-100', 'bg-gray-900', 'bg-gray-700', 'prose-invert', 'bg-red-900');
            el.classList.add('theme-light', el.classList.contains('bg-gray-800') ? 'bg-white' : '', el.classList.contains('text-gray-100') ? 'text-black' : '', el.classList.contains('bg-gray-900') ? 'bg-white' : '', el.classList.contains('bg-gray-700') ? 'bg-gray-200' : '', el.classList.contains('prose-invert') ? 'prose' : '', el.classList.contains('bg-red-900') ? 'bg-red-100' : '');
          } else {
            el.classList.remove('theme-light', 'bg-white', 'text-black', 'bg-gray-200', 'prose', 'bg-red-100');
            el.classList.add('theme-dark', el.classList.contains('bg-white') ? 'bg-gray-800' : '', el.classList.contains('text-black') ? 'text-gray-100' : '', el.classList.contains('bg-gray-200') ? 'bg-gray-700' : '', el.classList.contains('prose') ? 'prose-invert' : '', el.classList.contains('bg-red-100') ? 'bg-red-900' : '');
          }
        });
        document.getElementById('sunIcon').classList.toggle('hidden', currentTheme !== 'light');
        document.getElementById('moonIcon').classList.toggle('hidden', currentTheme === 'light');
      }

      function showNotification(message, color, isUrgent = false, persist = false) {
        console.log('Showing notification:', message);
        const id = `NOTIF${Date.now()}`;
        const notification = { id, message, color, isUrgent, persist, timestamp: new Date().toISOString() };
        if (persist) {
          if (urgentPopupDismissed) return;
          notificationsQueue.unshift(notification);
        } else {
          notificationsQueue.push(notification);
        }
        displayNextNotification();
      }

      function displayNextNotification() {
        console.log('Displaying next notification, queue length:', notificationsQueue.length);
        if (activeNotifications >= 3 || notificationsQueue.length === 0) return;
        const notif = notificationsQueue.shift();
        activeNotifications++;
        const div = document.createElement('div');
        div.className = `bg-white p-4 rounded shadow slide-in border-l-4 ${notif.color === 'green' ? 'border-green-500' : notif.color === 'red' ? 'border-red-500' : 'border-blue-500'} theme-light ${notif.isUrgent ? 'border-2 border-red-500 bg-red-100' : ''}`;
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <p>${notif.message}</p>
            <button class="notification-close text-gray-500 hover:text-gray-700">X</button>
          </div>
        `;
        const closeButton = div.querySelector('.notification-close');
        closeButton.addEventListener('click', () => dismissNotification(notif.id, div, notif.persist));
        document.getElementById('notificationContainer').appendChild(div);
        if (!notif.persist) {
          setTimeout(() => dismissNotification(notif.id, div, notif.persist), 30000);
        }
      }

      async function dismissNotification(id, element, persist) {
        console.log('Dismissing notification:', id);
        element.classList.add('fade-out');
        await new Promise(resolve => setTimeout(resolve, 300));
        element.remove();
        activeNotifications--;
        if (persist) {
          localStorage.setItem('urgentPopupDismissed', 'true');
          urgentPopupDismissed = true;
        } else {
          displayNextNotification();
          if (jwtToken) {
            await fetch(`${API_BASE}/mark-notification`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
              body: JSON.stringify({ notificationId: id })
            });
          }
        }
      }

      async function validateJwt() {
        console.log('Validating JWT');
        if (!jwtToken) return false;
        const res = await fetch(`${API_BASE}/validate`, {
          headers: { 'Authorization': `Bearer ${jwtToken}` }
        });
        if (res.ok) {
          const data = await res.json();
          userData = data.data;
          return true;
        }
        return false;
      }

      function initializeWebSocket() {
        console.log('Initializing WebSocket');
        if (!jwtToken) return;
        ws = new WebSocket(`${WS_URL}?token=${jwtToken}`);
        ws.onmessage = async (event) => {
          console.log('WebSocket message received:', event.data);
          const msg = JSON.parse(event.data);
          if (msg.type === 'update') {
            await fetchDashboardData();
          } else if (msg.type === 'notification') {
            showNotification(msg.message, msg.color || 'blue', msg.urgent || false);
          } else if (msg.type === 'logout') {
            logout();
            showNotification('Session expired, please login', 'red');
          } else if (msg.type === 'username_check') {
            const statusEl = document.getElementById('usernameStatus');
            statusEl.textContent = msg.message;
            statusEl.className = `text-sm mt-1 ${msg.available ? 'text-green-500' : 'text-red-500'}`;
          }
        };
        ws.onclose = () => {
          console.log('WebSocket closed');
          ws = null;
        };
      }

      function startSessionTimer() {
        console.log('Starting session timer');
        clearTimeout(sessionTimer);
        clearTimeout(sessionGraceTimer);
        sessionTimer = setTimeout(() => {
          document.getElementById('sessionTimeoutModal').classList.remove('hidden');
          sessionGraceTimer = setTimeout(() => {
            logout();
            showNotification('Session expired', 'red');
          }, SESSION_GRACE);
        }, SESSION_TIMEOUT);
      }

      function formatTime(ms) {
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
      }

      function formatCurrency(value) {
        return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function getDaysUntilNextMonth() {
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
        const diffTime = nextMonth - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }

      function paginateData(data, page, itemsPerPage) {
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        return data.slice(start, end);
      }

      async function fetchDashboardData() {
        console.log('Fetching dashboard data');
        const res = await fetch(`${API_BASE}/data`, {
          headers: { 'Authorization': `Bearer ${jwtToken}` }
        });
        const data = await res.json();
        if (data.success) {
          userData = data.data.user;
          document.getElementById('welcomeMessage').textContent = `Welcome ${userData.name}, Your username is ${userData.username}`;
          document.getElementById('dashboardWelcome').textContent = `Welcome ${userData.name}, Your username is ${userData.username}`;
          document.getElementById('affiliateLink').value = userData.refCode ? `https://botblitz.store?ref=${userData.refCode}` : 'Link unavailable';
          document.getElementById('linkClicks').textContent = userData.linkClicks || 0;
          document.getElementById('totalSales').textContent = userData.totalSales || 0;
          document.getElementById('monthlySales').textContent = userData.totalSalesMonthly || 0;
          const daysUntilReset = getDaysUntilNextMonth();
          document.getElementById('monthlyReset').textContent = `Resets in ${daysUntilReset} days`;
          document.getElementById('currentBalance').textContent = formatCurrency(userData.currentBalance || 0);
          document.getElementById('withdrawnTotal').textContent = formatCurrency(userData.withdrawnTotal || 0);
          document.getElementById('withdrawalAmount').max = userData.currentBalance || 0;
          document.getElementById('requestWithdrawal').classList.toggle('opacity-50 cursor-not-allowed', (userData.currentBalance || 0) < 1);

          allWithdrawals = data.data.withdrawals || [];
          allRewards = data.data.rewards || [];
          allNotifications = data.data.notifications || [];

          withdrawalPage = 1;
          updateWithdrawalTable();

          rewardsPage = 1;
          updateRewardsTable();

          const leaderboardTable = document.getElementById('leaderboardTable');
          leaderboardTable.innerHTML = '';
          (data.data.leaderboard || []).slice(0, 10).forEach((a, i) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="p-2">${i + 1}</td>
              <td class="p-2">${a.name}</td>
              <td class="p-2">${a.totalSalesMonthly}</td>
              <td class="p-2">${a.momentum || '-'}</td>
            `;
            leaderboardTable.appendChild(row);
          });

          notificationsPage = 1;
          updateNotificationsTable();

          const newsList = document.getElementById('newsList');
          newsList.innerHTML = '';
          (data.data.news || []).slice(0, 10).forEach(n => {
            const div = document.createElement('div');
            const isRead = localStorage.getItem(`news-${n.id}`);
            div.className = 'bg-white p-4 rounded theme-light';
            div.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-sm text-gray-500">${new Date(n.timestamp).toLocaleString()}</p>
                  <p>${n.message}</p>
                </div>
                ${isRead ? '' : '<span class="bg-blue-500 text-white px-2 rounded">New</span>'}
              </div>
            `;
            div.addEventListener('click', () => {
              localStorage.setItem(`news-${n.id}`, 'read');
              div.querySelector('span')?.remove();
            });
            newsList.appendChild(div);
          });

          const forumsList = document.getElementById('forumsList');
          forumsList.innerHTML = '';
          (data.data.forums || []).forEach(f => {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded theme-light cursor-pointer';
            div.innerHTML = `
              <div class="flex items-center">
                <img src="assets/${f.icon}" alt="${f.name}" class="w-12 h-12 mr-4" onerror="this.onerror=null; this.remove();">
                <div>
                  <p class="text-base font-medium">${f.name}</p>
                  <p class="text-sm text-gray-500">${f.description}</p>
                </div>
              </div>
            `;
            div.addEventListener('click', () => window.open(f.link, '_blank'));
            forumsList.appendChild(div);
          });

          const commissionRate = data.data.commissionRate || 0.2;
          document.getElementById('commissionText').textContent = `Commission = Sale Amount × ${(commissionRate * 100).toFixed(0)}%`;
          document.getElementById('commissionExample').textContent = `Sale = 1000 KES, Rate = ${(commissionRate * 100).toFixed(0)}%, Commission = ${(1000 * commissionRate).toFixed(0)} KES`;
        } else {
          showNotification('Failed to load dashboard data', 'red');
          document.getElementById('affiliateLink').value = 'Link unavailable';
        }
      }

      function updateWithdrawalTable() {
        console.log('Updating withdrawal table, page:', withdrawalPage);
        const withdrawalTable = document.getElementById('withdrawalHistoryTable');
        withdrawalTable.innerHTML = '';
        const paginatedWithdrawals = paginateData(allWithdrawals, withdrawalPage, ITEMS_PER_PAGE);
        paginatedWithdrawals.forEach(w => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${new Date(w.timestamp).toLocaleString()}</td>
            <td class="p-2">${formatCurrency(w.data.amount)}</td>
            <td class="p-2">${w.data.mpesaNumber}</td>
            <td class="p-2">${w.data.mpesaName}</td>
            <td class="p-2">${w.status}</td>
            <td class="p-2">${w.data.mpesaRef || '-'}</td>
          `;
          withdrawalTable.appendChild(row);
        });
        document.getElementById('withdrawalPageNumber').textContent = `Page ${withdrawalPage}`;
        document.getElementById('withdrawalPrevPage').disabled = withdrawalPage === 1;
        document.getElementById('withdrawalNextPage').disabled = withdrawalPage * ITEMS_PER_PAGE >= allWithdrawals.length;
      }

      function updateRewardsTable() {
        console.log('Updating rewards table, page:', rewardsPage);
        const rewardsTable = document.getElementById('rewardsHistoryTable');
        rewardsTable.innerHTML = '';
        const paginatedRewards = paginateData(allRewards, rewardsPage, ITEMS_PER_PAGE);
        paginatedRewards.forEach(r => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${new Date(r.timestamp).toLocaleString()}</td>
            <td class="p-2">${r.data.type}</td>
            <td class="p-2">${formatCurrency(r.data.amount)}</td>
            <td class="p-2">${r.data.description}</td>
          `;
          rewardsTable.appendChild(row);
        });
        document.getElementById('rewardsPageNumber').textContent = `Page ${rewardsPage}`;
        document.getElementById('rewardsPrevPage').disabled = rewardsPage === 1;
        document.getElementById('rewardsNextPage').disabled = rewardsPage * ITEMS_PER_PAGE >= allRewards.length;
      }

      function updateNotificationsTable() {
        console.log('Updating notifications table, page:', notificationsPage);
        const notificationsTable = document.getElementById('notificationsHistoryTable');
        notificationsTable.innerHTML = '';
        const paginatedNotifications = paginateData(allNotifications, notificationsPage, ITEMS_PER_PAGE);
        paginatedNotifications.forEach(n => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${new Date(n.timestamp).toLocaleString()}</td>
            <td class="p-2">${n.data.message}</td>
            <td class="p-2">${n.read ? 'Read' : 'Unread'}</td>
          `;
          notificationsTable.appendChild(row);
          if (!n.read) showNotification(n.data.message, n.data.color || 'blue');
        });
        document.getElementById('notificationsPageNumber').textContent = `Page ${notificationsPage}`;
        document.getElementById('notificationsPrevPage').disabled = notificationsPage === 1;
        document.getElementById('notificationsNextPage').disabled = notificationsPage * ITEMS_PER_PAGE >= allNotifications.length;
      }

      async function fetchSettings() {
        console.log('Fetching settings');
        const res = await fetch(`${API_BASE}/settings`);
        const data = await res.json();
        if (data.success) {
          document.getElementById('copyrightText').textContent = data.data.copyrightText || '© 2025 Deriv Bot Store Affiliates';
          document.getElementById('whatsappLink').href = data.data.whatsappLink || 'https://wa.link/4wppln';
          document.getElementById('emailLink').href = `mailto:${data.data.supportEmail || 'derivbotstore@gmail.com'}`;
          const staticLinks = document.getElementById('staticLinks');
          staticLinks.innerHTML = '';
          (data.data.staticPages || []).forEach(page => {
            const a = document.createElement('a');
            a.href = `/affiliate-${page.slug}`;
            a.className = 'text-blue-500 hover:underline mx-2';
            a.textContent = page.title;
            a.addEventListener('click', async (e) => {
              e.preventDefault();
              const res = await fetch(`${API_BASE}/static-page/${page.slug}`);
              const pageData = await res.json();
              if (pageData.success) {
                document.getElementById('staticPageTitle').textContent = pageData.data.title;
                document.getElementById('staticPageContent').innerHTML = pageData.data.content;
                document.getElementById('staticPageModal').classList.remove('hidden');
                applyTheme();
              }
            });
            staticLinks.appendChild(a);
          });
        }
      }

      function logout() {
        console.log('Logging out');
        setCookie('jwt', '', 0);
        jwtToken = null;
        userData = null;
        if (ws) ws.close();
        ws = null;
        clearTimeout(sessionTimer);
        clearTimeout(sessionGraceTimer);
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('dashboardSection').classList.add('hidden');
        document.getElementById('contactUsBtn').classList.add('hidden');
        document.getElementById('settingsDropdown').classList.add('hidden');
        document.getElementById('welcomeMessage').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('forgotPasswordForm').classList.add('hidden');
        document.getElementById('otpForm').classList.add('hidden');
        document.getElementById('setNewPasswordForm').classList.add('hidden');
      }

      function toggleButtonLoading(buttonId, spinnerId, textId, isLoading) {
        console.log(`Toggling loading for ${buttonId}:`, isLoading);
        const button = document.getElementById(buttonId);
        const spinner = document.getElementById(spinnerId);
        const text = document.getElementById(textId);
        if (isLoading) {
          button.disabled = true;
          button.classList.add('opacity-50', 'cursor-not-allowed');
          spinner.classList.remove('hidden');
          text.classList.add('hidden');
        } else {
          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-not-allowed');
          spinner.classList.add('hidden');
          text.classList.remove('hidden');
        }
      }

      // Form Toggle Functions
      function showLoginForm() {
        console.log('Showing login form');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('forgotPasswordForm').classList.add('hidden');
        document.getElementById('otpForm').classList.add('hidden');
        document.getElementById('setNewPasswordForm').classList.add('hidden');
      }

      function showSignupForm() {
        console.log('Showing signup form');
        document.getElementById('signupForm').classList.remove('hidden');
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('forgotPasswordForm').classList.add('hidden');
        document.getElementById('otpForm').classList.add('hidden');
        document.getElementById('setNewPasswordForm').classList.add('hidden');
      }

      function showForgotPasswordForm() {
        console.log('Showing forgot password form');
        document.getElementById('forgotPasswordForm').classList.remove('hidden');
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('otpForm').classList.add('hidden');
        document.getElementById('setNewPasswordForm').classList.add('hidden');
      }

      // Event Listeners
      document.getElementById('themeToggle').addEventListener('click', async () => {
        console.log('Theme toggle clicked');
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', currentTheme);
        applyTheme();
        if (jwtToken) {
          await fetch(`${API_BASE}/update-theme`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
            body: JSON.stringify({ theme: currentTheme })
          });
        }
      });

      document.getElementById('loginToggle').addEventListener('click', (e) => {
        console.log('Login toggle clicked');
        e.preventDefault();
        showLoginForm();
      });

      document.getElementById('signupToggle').addEventListener('click', (e) => {
        console.log('Signup toggle clicked');
        e.preventDefault();
        showSignupForm();
      });

      document.getElementById('showLogin').addEventListener('click', (e) => {
        console.log('Show login clicked');
        e.preventDefault();
        showLoginForm();
      });

      document.getElementById('showForgotPassword').addEventListener('click', (e) => {
        console.log('Show forgot password clicked');
        e.preventDefault();
        showForgotPasswordForm();
      });

      document.getElementById('signupUsername').addEventListener('input', () => {
        console.log('Signup username input changed');
        const username = document.getElementById('signupUsername').value;
        const statusEl = document.getElementById('usernameStatus');
        if (username.length < 5 && username.length > 0) {
          statusEl.textContent = 'Username must be at least 5 characters';
          statusEl.className = 'text-sm mt-1 text-red-500';
        } else if (username.length >= 5 && ws) {
          ws.send(JSON.stringify({ type: 'username_check', username }));
        } else {
          statusEl.textContent = '';
        }
      });

      document.getElementById('signupPasswordToggle').addEventListener('click', () => {
        console.log('Signup password toggle clicked');
        const password = document.getElementById('signupPassword');
        const toggle = document.getElementById('signupPasswordToggle');
        if (password.type === 'password') {
          password.type = 'text';
          toggle.textContent = 'Hide';
        } else {
          password.type = 'password';
          toggle.textContent = 'Show';
        }
      });

      document.getElementById('loginPasswordToggle').addEventListener('click', () => {
        console.log('Login password toggle clicked');
        const password = document.getElementById('loginPassword');
        const toggle = document.getElementById('loginPasswordToggle');
        if (password.type === 'password') {
          password.type = 'text';
          toggle.textContent = 'Hide';
        } else {
          password.type = 'password';
          toggle.textContent = 'Show';
        }
      });

      document.getElementById('newPasswordToggle').addEventListener('click', () => {
        console.log('New password toggle clicked');
        const password = document.getElementById('newPassword');
        const toggle = document.getElementById('newPasswordToggle');
        if (password.type === 'password') {
          password.type = 'text';
          toggle.textContent = 'Hide';
        } else {
          password.type = 'password';
          toggle.textContent = 'Show';
        }
      });

      document.getElementById('confirmPasswordToggle').addEventListener('click', () => {
        console.log('Confirm password toggle clicked');
        const password = document.getElementById('confirmPassword');
        const toggle = document.getElementById('confirmPasswordToggle');
        if (password.type === 'password') {
          password.type = 'text';
          toggle.textContent = 'Hide';
        } else {
          password.type = 'password';
          toggle.textContent = 'Show';
        }
      });

      document.getElementById('currentPasswordToggle').addEventListener('click', () => {
        console.log('Current password toggle clicked');
        const password = document.getElementById('currentPassword');
        const toggle = document.getElementById('currentPasswordToggle');
        if (password.type === 'password') {
          password.type = 'text';
          toggle.textContent = 'Hide';
        } else {
          password.type = 'password';
          toggle.textContent = 'Show';
        }
      });

      document.getElementById('changeNewPasswordToggle').addEventListener('click', () => {
        console.log('Change new password toggle clicked');
        const password = document.getElementById('changeNewPassword');
        const toggle = document.getElementById('changeNewPasswordToggle');
        if (password.type === 'password') {
          password.type = 'text';
          toggle.textContent = 'Hide';
        } else {
          password.type = 'password';
          toggle.textContent = 'Show';
        }
      });

      document.getElementById('changeConfirmPasswordToggle').addEventListener('click', () => {
        console.log('Change confirm password toggle clicked');
        const password = document.getElementById('changeConfirmPassword');
        const toggle = document.getElementById('changeConfirmPasswordToggle');
        if (password.type === 'password') {
          password.type = 'text';
          toggle.textContent = 'Hide';
        } else {
          password.type = 'password';
          toggle.textContent = 'Show';
        }
      });

      document.getElementById('signupSubmit').addEventListener('click', async () => {
        console.log('Signup submit clicked');
        const name = document.getElementById('signupName').value.trim();
        const username = document.getElementById('signupUsername').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value.trim();
        const terms = document.getElementById('signupTerms').checked;
        const recaptcha = document.getElementById('signupRecaptcha').checked;

        if (!name || !username || !email || !password || !terms || !recaptcha) {
          showNotification('Please fill all fields and agree to terms', 'red');
          return;
        }
        if (!username.match(/^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{5,}$/)) {
          showNotification('Username must be 5+ characters with letters and numbers', 'red');
          return;
        }
        if (!email.match(/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/)) {
          showNotification('Invalid email format', 'red');
          return;
        }
        if (!password.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/)) {
          showNotification('Password must be 8+ characters with uppercase, lowercase, and numbers', 'red');
          return;
        }

        toggleButtonLoading('signupSubmit', 'signupSubmitSpinner', 'signupSubmitText', true);
        const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'signup' });
        const res = await fetch(`${API_BASE}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, username, email, password, recaptchaToken: token })
        });
        const data = await res.json();
        toggleButtonLoading('signupSubmit', 'signupSubmitSpinner', 'signupSubmitText', false);
        if (data.success) {
          otpContext = { email, type: 'signup' };
          document.getElementById('otpForm').classList.remove('hidden');
          document.getElementById('signupForm').classList.add('hidden');
          document.getElementById('otpTitle').textContent = 'Verify Your Email Address';
          document.getElementById('otpMessage').textContent = `We sent a 6-digit code to ${email}. It expires in 5 minutes.`;
          startOtpTimer();
        } else {
          showNotification(data.error, 'red');
        }
      });

      document.getElementById('loginSubmit').addEventListener('click', async () => {
        console.log('Login submit clicked');
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        const recaptcha = document.getElementById('loginRecaptcha').checked;

        if (!email || !password || !recaptcha) {
          showNotification('Please fill all fields and verify reCAPTCHA', 'red');
          return;
        }
        if (!email.match(/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/)) {
          showNotification('Invalid email format', 'red');
          return;
        }

        toggleButtonLoading('loginSubmit', 'loginSubmitSpinner', 'loginSubmitText', true);
        const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'login' });
        const res = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, recaptchaToken: token })
        });
        const data = await res.json();
        toggleButtonLoading('loginSubmit', 'loginSubmitSpinner', 'loginSubmitText', false);
        if (data.success) {
          if (data.data.requiresOtp) {
            otpContext = { email, type: 'login' };
            document.getElementById('otpForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('otpTitle').textContent = 'Verify Your Email Address';
            document.getElementById('otpMessage').textContent = `We sent a 6-digit code to ${email}. It expires in 5 minutes.`;
            startOtpTimer();
          } else {
            jwtToken = data.data.token;
            setCookie('jwt', jwtToken, 30 * 24 * 60 * 60);
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('contactUsBtn').classList.remove('hidden');
            document.getElementById('settingsDropdown').classList.remove('hidden');
            document.getElementById('welcomeMessage').classList.remove('hidden');
            initializeWebSocket();
            await fetchDashboardData();
            startSessionTimer();
            fetchSettings();
          }
        } else {
          showNotification(data.error, 'red');
        }
      });

      document.getElementById('forgotSubmit').addEventListener('click', async () => {
        console.log('Forgot password submit clicked');
        const email = document.getElementById('forgotEmail').value.trim();
        const recaptcha = document.getElementById('forgotRecaptcha').checked;

        if (!email || !recaptcha) {
          showNotification('Please enter an email and verify reCAPTCHA', 'red');
          return;
        }
        if (!email.match(/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/)) {
          showNotification('Invalid email format', 'red');
          return;
        }

        toggleButtonLoading('forgotSubmit', 'forgotSubmitSpinner', 'forgotSubmitText', true);
        const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'forgot' });
        const res = await fetch(`${API_BASE}/forgot-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, recaptchaToken: token })
        });
        const data = await res.json();
        toggleButtonLoading('forgotSubmit', 'forgotSubmitSpinner', 'forgotSubmitText', false);
        if (data.success) {
          otpContext = { email, type: 'reset' };
          document.getElementById('otpForm').classList.remove('hidden');
          document.getElementById('forgotPasswordForm').classList.add('hidden');
          document.getElementById('otpTitle').textContent = 'Verify Your Email Address';
          document.getElementById('otpMessage').textContent = `We sent a 6-digit code to ${email}. It expires in 5 minutes.`;
          startOtpTimer();
        } else {
          showNotification(data.error, 'red');
        }
      });

      document.getElementById('otpVerify').addEventListener('click', async () => {
        console.log('OTP verify clicked');
        const otp = document.getElementById('otpInput').value.trim();
        if (!otp.match(/^\d{6}$/)) {
          showNotification('OTP must be a 6-digit code', 'red');
          return;
        }
        toggleButtonLoading('otpVerify', 'otpVerifySpinner', 'otpVerifyText', true);
        const res = await fetch(`${API_BASE}/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: otpContext.email, otp, type: otpContext.type })
        });
        const data = await res.json();
        toggleButtonLoading('otpVerify', 'otpVerifySpinner', 'otpVerifyText', false);
        if (data.success) {
          if (otpContext.type === 'signup') {
            document.getElementById('otpForm').classList.add('hidden');
            document.getElementById('setNewPasswordForm').classList.remove('hidden');
            document.getElementById('otpTitle').textContent = 'Set Your Password';
            document.getElementById('otpMessage').textContent = 'Please set a new password for your account.';
          } else if (otpContext.type === 'login') {
            jwtToken = data.data.token;
            setCookie('jwt', jwtToken, 30 * 24 * 60 * 60);
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('contactUsBtn').classList.remove('hidden');
            document.getElementById('settingsDropdown').classList.remove('hidden');
            document.getElementById('welcomeMessage').classList.remove('hidden');
            initializeWebSocket();
            await fetchDashboardData();
            startSessionTimer();
            fetchSettings();
          } else if (otpContext.type === 'reset') {
            document.getElementById('otpForm').classList.add('hidden');
            document.getElementById('setNewPasswordForm').classList.remove('hidden');
            document.getElementById('otpTitle').textContent = 'Reset Your Password';
            document.getElementById('otpMessage').textContent = 'Please set a new password.';
          }
        } else {
          showNotification(data.error, 'red');
        }
      });

      document.getElementById('otpResend').addEventListener('click', async () => {
        console.log('OTP resend clicked');
        if (document.getElementById('otpResend').disabled) return;
        const email = otpContext.email;
        toggleButtonLoading('otpResend', 'otpResendSpinner', 'otpResendText', true);
        const res = await fetch(`${API_BASE}/resend-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        toggleButtonLoading('otpResend', 'otpResendSpinner', 'otpResendText', false);
        if (data.success) {
          startOtpTimer();
          showNotification('New OTP sent to your email', 'green');
        } else {
          showNotification(data.error, 'red');
          otpBlockTimer = setTimeout(() => {
            clearInterval(otpBlockTimer);
            otpBlockTimer = null;
          }, OTP_BLOCK_DURATION);
        }
      });

      function startOtpTimer() {
        console.log('Starting OTP timer');
        clearInterval(otpTimer);
        clearInterval(otpResendTimer);
        clearInterval(otpBlockTimer);
        let timeLeft = OTP_DURATION;
        document.getElementById('otpCountdown').textContent = `Expires in ${formatTime(timeLeft)}`;
        const resendButton = document.getElementById('otpResend');
        resendButton.disabled = true;
        resendButton.classList.add('opacity-50', 'cursor-not-allowed');
        otpTimer = setInterval(() => {
          timeLeft -= 1000;
          if (timeLeft <= 0) {
            clearInterval(otpTimer);
            document.getElementById('otpCountdown').textContent = 'Code expired';
            document.getElementById('otpVerify').disabled = true;
            return;        
        let resendCooldown = RATE_LIMIT_DURATION;
        otpResendTimer = setInterval(() => {
          resendCooldown -= 1000;
          if (resendCooldown <= 0) {
            resendButton.disabled = false;
            resendButton.classList.remove('opacity-50', 'cursor-not-allowed');
            clearInterval(otpResendTimer);
          }
        }, 1000);
      }, 1000);
    }

    document.getElementById('setNewPasswordSubmit').addEventListener('click', async () => {
      console.log('Set new password submit clicked');
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();

      if (!newPassword || !confirmPassword) {
        showNotification('Please fill all fields', 'red');
        return;
      }
      if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'red');
        return;
      }
      if (!newPassword.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/)) {
        showNotification('Password must be 8+ characters with uppercase, lowercase, and numbers', 'red');
        return;
      }

      toggleButtonLoading('setNewPasswordSubmit', 'setNewPasswordSubmitSpinner', 'setNewPasswordSubmitText', true);
      const res = await fetch(`${API_BASE}/set-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: otpContext.email, password: newPassword, type: otpContext.type })
      });
      const data = await res.json();
      toggleButtonLoading('setNewPasswordSubmit', 'setNewPasswordSubmitSpinner', 'setNewPasswordSubmitText', false);
      if (data.success) {
        showNotification('Password set successfully', 'green');
        document.getElementById('setNewPasswordForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        if (otpContext.type === 'signup') {
          showNotification('Account created successfully, please login', 'green');
        }
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('settingsDropdown').addEventListener('click', () => {
      console.log('Settings dropdown clicked');
      document.getElementById('settingsMenu').classList.toggle('hidden');
    });

    document.getElementById('contactUsBtn').addEventListener('click', () => {
      console.log('Contact us button clicked');
      document.getElementById('contactUsModal').classList.remove('hidden');
      applyTheme();
    });

    document.getElementById('closeContactUs').addEventListener('click', () => {
      console.log('Close contact us modal clicked');
      document.getElementById('contactUsModal').classList.add('hidden');
    });

    document.getElementById('commissionInfoBtn').addEventListener('click', () => {
      console.log('Commission info button clicked');
      document.getElementById('commissionInfoModal').classList.remove('hidden');
      applyTheme();
    });

    document.getElementById('closeCommissionInfo').addEventListener('click', () => {
      console.log('Close commission info modal clicked');
      document.getElementById('commissionInfoModal').classList.add('hidden');
    });

    document.getElementById('changePasswordBtn').addEventListener('click', () => {
      console.log('Change password button clicked');
      document.getElementById('changePasswordModal').classList.remove('hidden');
      document.getElementById('settingsMenu').classList.add('hidden');
      applyTheme();
    });

    document.getElementById('closeChangePassword').addEventListener('click', () => {
      console.log('Close change password modal clicked');
      document.getElementById('changePasswordModal').classList.add('hidden');
    });

    document.getElementById('changePasswordSubmit').addEventListener('click', async () => {
      console.log('Change password submit clicked');
      const currentPassword = document.getElementById('currentPassword').value.trim();
      const newPassword = document.getElementById('changeNewPassword').value.trim();
      const confirmPassword = document.getElementById('changeConfirmPassword').value.trim();

      if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('Please fill all fields', 'red');
        return;
      }
      if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'red');
        return;
      }
      if (!newPassword.match(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/)) {
        showNotification('New password must be 8+ characters with uppercase, lowercase, and numbers', 'red');
        return;
      }

      toggleButtonLoading('changePasswordSubmit', 'changePasswordSubmitSpinner', 'changePasswordSubmitText', true);
      const res = await fetch(`${API_BASE}/change-password`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
        body: JSON.stringify({ currentPassword, newPassword })
      });
      const data = await res.json();
      toggleButtonLoading('changePasswordSubmit', 'changePasswordSubmitSpinner', 'changePasswordSubmitText', false);
      if (data.success) {
        showNotification('Password changed successfully', 'green');
        document.getElementById('changePasswordModal').classList.add('hidden');
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('deleteAccountBtn').addEventListener('click', () => {
      console.log('Delete account button clicked');
      document.getElementById('deleteAccountModal').classList.remove('hidden');
      document.getElementById('settingsMenu').classList.add('hidden');
      applyTheme();
    });

    document.getElementById('closeDeleteAccount').addEventListener('click', () => {
      console.log('Close delete account modal clicked');
      document.getElementById('deleteAccountModal').classList.add('hidden');
    });

    document.getElementById('confirmDelete').addEventListener('click', async () => {
      console.log('Confirm delete account clicked');
      toggleButtonLoading('confirmDelete', 'confirmDeleteSpinner', 'confirmDeleteText', true);
      const res = await fetch(`${API_BASE}/delete-account`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${jwtToken}` }
      });
      const data = await res.json();
      toggleButtonLoading('confirmDelete', 'confirmDeleteSpinner', 'confirmDeleteText', false);
      if (data.success) {
        showNotification('Account deleted successfully', 'green');
        logout();
        document.getElementById('deleteAccountModal').classList.add('hidden');
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('sessionYes').addEventListener('click', async () => {
      console.log('Session yes clicked');
      const password = document.getElementById('sessionPassword').value.trim();
      if (!password) {
        showNotification('Please enter your password', 'red');
        return;
      }

      toggleButtonLoading('sessionYes', 'sessionYesSpinner', 'sessionYesText', true);
      const res = await fetch(`${API_BASE}/verify-session`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
        body: JSON.stringify({ password })
      });
      const data = await res.json();
      toggleButtonLoading('sessionYes', 'sessionYesSpinner', 'sessionYesText', false);
      if (data.success) {
        startSessionTimer();
        document.getElementById('sessionTimeoutModal').classList.add('hidden');
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('sessionNo').addEventListener('click', () => {
      console.log('Session no clicked');
      logout();
      document.getElementById('sessionTimeoutModal').classList.add('hidden');
      showNotification('Session ended', 'red');
    });

    document.getElementById('closeStaticPage').addEventListener('click', () => {
      console.log('Close static page modal clicked');
      document.getElementById('staticPageModal').classList.add('hidden');
    });

    document.getElementById('copyLink').addEventListener('click', () => {
      console.log('Copy link clicked');
      const affiliateLink = document.getElementById('affiliateLink').value;
      navigator.clipboard.writeText(affiliateLink).then(() => {
        showNotification('Affiliate link copied to clipboard', 'green');
      }).catch(() => {
        showNotification('Failed to copy link', 'red');
      });
    });

    document.getElementById('editMpesaDetails').addEventListener('click', () => {
      console.log('Edit MPESA details clicked');
      document.getElementById('withdrawalMpesaNumber').readOnly = false;
      document.getElementById('withdrawalMpesaName').readOnly = false;
      document.getElementById('reuseDetails').checked = false;
    });

    document.getElementById('requestWithdrawal').addEventListener('click', async () => {
      console.log('Request withdrawal clicked');
      if (document.getElementById('requestWithdrawal').classList.contains('cursor-not-allowed')) {
        showNotification('Insufficient balance for withdrawal', 'red');
        return;
      }

      const amount = parseFloat(document.getElementById('withdrawalAmount').value);
      const mpesaNumber = document.getElementById('withdrawalMpesaNumber').value.trim();
      const mpesaName = document.getElementById('withdrawalMpesaName').value.trim();
      const reuseDetails = document.getElementById('reuseDetails').checked;

      if (!amount || !mpesaNumber || !mpesaName) {
        showNotification('Please fill all withdrawal fields', 'red');
        return;
      }
      if (amount < 1) {
        showNotification('Withdrawal amount must be at least 1 KES', 'red');
        return;
      }
      if (!mpesaNumber.match(/^\+254\d{9}$/)) {
        showNotification('Invalid MPESA number format', 'red');
        return;
      }

      toggleButtonLoading('requestWithdrawal', 'requestWithdrawalSpinner', 'requestWithdrawalText', true);
      const res = await fetch(`${API_BASE}/request-withdrawal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${jwtToken}` },
        body: JSON.stringify({ amount, mpesaNumber, mpesaName, reuseDetails })
      });
      const data = await res.json();
      toggleButtonLoading('requestWithdrawal', 'requestWithdrawalSpinner', 'requestWithdrawalText', false);
      if (data.success) {
        showNotification('Withdrawal request submitted', 'green');
        document.getElementById('withdrawalAmount').value = '';
        if (!reuseDetails) {
          document.getElementById('withdrawalMpesaNumber').value = '';
          document.getElementById('withdrawalMpesaName').value = '';
        }
        await fetchDashboardData();
      } else {
        showNotification(data.error, 'red');
      }
    });

    document.getElementById('tabHome').addEventListener('click', () => {
      console.log('Home tab clicked');
      document.querySelectorAll('#dashboardSection > div').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('homeTab').classList.remove('hidden');
      document.querySelectorAll('#dashboardSection button').forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-500'));
      document.getElementById('tabHome').classList.replace('bg-gray-500', 'bg-blue-500');
    });

    document.getElementById('tabWithdrawalHistory').addEventListener('click', () => {
      console.log('Withdrawal history tab clicked');
      document.querySelectorAll('#dashboardSection > div').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('withdrawalHistoryTab').classList.remove('hidden');
      document.querySelectorAll('#dashboardSection button').forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-500'));
      document.getElementById('tabWithdrawalHistory').classList.replace('bg-gray-500', 'bg-blue-500');
    });

    document.getElementById('tabRewardsHistory').addEventListener('click', () => {
      console.log('Rewards history tab clicked');
      document.querySelectorAll('#dashboardSection > div').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('rewardsHistoryTab').classList.remove('hidden');
      document.querySelectorAll('#dashboardSection button').forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-500'));
      document.getElementById('tabRewardsHistory').classList.replace('bg-gray-500', 'bg-blue-500');
    });

    document.getElementById('tabLeaderboard').addEventListener('click', () => {
      console.log('Leaderboard tab clicked');
      document.querySelectorAll('#dashboardSection > div').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('leaderboardTab').classList.remove('hidden');
      document.querySelectorAll('#dashboardSection button').forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-500'));
      document.getElementById('tabLeaderboard').classList.replace('bg-gray-500', 'bg-blue-500');
    });

    document.getElementById('tabNotificationsHistory').addEventListener('click', () => {
      console.log('Notifications history tab clicked');
      document.querySelectorAll('#dashboardSection > div').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('notificationsHistoryTab').classList.remove('hidden');
      document.querySelectorAll('#dashboardSection button').forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-500'));
      document.getElementById('tabNotificationsHistory').classList.replace('bg-gray-500', 'bg-blue-500');
    });

    document.getElementById('tabNews').addEventListener('click', () => {
      console.log('News tab clicked');
      document.querySelectorAll('#dashboardSection > div').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('newsTab').classList.remove('hidden');
      document.querySelectorAll('#dashboardSection button').forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-500'));
      document.getElementById('tabNews').classList.replace('bg-gray-500', 'bg-blue-500');
    });

    document.getElementById('tabMarketing').addEventListener('click', () => {
      console.log('Marketing tab clicked');
      document.querySelectorAll('#dashboardSection > div').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('marketingTab').classList.remove('hidden');
      document.querySelectorAll('#dashboardSection button').forEach(btn => btn.classList.replace('bg-blue-500', 'bg-gray-500'));
      document.getElementById('tabMarketing').classList.replace('bg-gray-500', 'bg-blue-500');
    });

    document.getElementById('withdrawalPrevPage').addEventListener('click', () => {
      console.log('Withdrawal previous page clicked');
      if (withdrawalPage > 1) {
        withdrawalPage--;
        updateWithdrawalTable();
      }
    });

    document.getElementById('withdrawalNextPage').addEventListener('click', () => {
      console.log('Withdrawal next page clicked');
      if (withdrawalPage * ITEMS_PER_PAGE < allWithdrawals.length) {
        withdrawalPage++;
        updateWithdrawalTable();
      }
    });

    document.getElementById('rewardsPrevPage').addEventListener('click', () => {
      console.log('Rewards previous page clicked');
      if (rewardsPage > 1) {
        rewardsPage--;
        updateRewardsTable();
      }
    });

    document.getElementById('rewardsNextPage').addEventListener('click', () => {
      console.log('Rewards next page clicked');
      if (rewardsPage * ITEMS_PER_PAGE < allRewards.length) {
        rewardsPage++;
        updateRewardsTable();
      }
    });

    document.getElementById('notificationsPrevPage').addEventListener('click', () => {
      console.log('Notifications previous page clicked');
      if (notificationsPage > 1) {
        notificationsPage--;
        updateNotificationsTable();
      }
    });

    document.getElementById('notificationsNextPage').addEventListener('click', () => {
      console.log('Notifications next page clicked');
      if (notificationsPage * ITEMS_PER_PAGE < allNotifications.length) {
        notificationsPage++;
        updateNotificationsTable();
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      console.log('Logout button clicked');
      logout();
      showNotification('Logged out successfully', 'green');
      document.getElementById('settingsMenu').classList.add('hidden');
    });

    // Initialize
    applyTheme();
    const isValidJwt = await validateJwt();
    if (isValidJwt) {
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('dashboardSection').classList.remove('hidden');
      document.getElementById('contactUsBtn').classList.remove('hidden');
      document.getElementById('settingsDropdown').classList.remove('hidden');
      document.getElementById('welcomeMessage').classList.remove('hidden');
      initializeWebSocket();
      await fetchDashboardData();
      startSessionTimer();
    } else {
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('dashboardSection').classList.add('hidden');
    }
    fetchSettings();
  });
  </script>
</body>
</html>
