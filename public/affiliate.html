<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotBlitz Affiliate Program</title>
    <link rel="stylesheet" href="/output.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="https://botblitz.store/favicon.ico">
    <script src="/assets/axios.min.js"></script>
    <script src="/assets/jwt-decode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .popup { transition: opacity 0.3s ease, transform 0.3s ease; }
        .table-container { max-height: 500px; overflow-y: auto; }
        .btn { min-width: 120px; transition: all 0.2s ease; }
        .live-clicks { animation: pulse 2s infinite; }
        .toast { transition: opacity 0.5s ease; }
        .tick-icon { animation: tick 0.5s ease-in-out; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes tick { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @media (max-width: 640px) {
            .table-container { max-height: 300px; }
            .btn { min-width: 100px; font-size: 0.875rem; }
            .popup { max-width: 90%; }
            .grid-cols-2 { grid-template-columns: 1fr; }
            .nav-icons { flex-direction: row; gap: 1rem; }
            .auth-card { max-width: 90%; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app"></div>
    <div id="toast" class="fixed bottom-4 right-4 px-4 py-2 rounded-md toast hidden text-white"></div>
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 popup hidden">
        <div id="modal-content" class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h2>
            <div id="modal-body"></div>
            <button id="modal-close" class="mt-4 btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Close</button>
        </div>
    </div>
    <div id="cookie-consent" class="fixed bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg z-50 hidden">
        <p class="text-sm text-gray-700">We use cookies to enhance your experience.</p>
        <button id="cookie-accept" class="mt-2 btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Accept</button>
    </div>
    <script>
        const API_URL = 'https://affiliate-botblitz.onrender.com/api/affiliate';
        const WS_URL = 'wss://affiliate-botblitz.onrender.com';
        const pageSize = 20;

        // State
        let state = {
            isLogin: true,
            token: localStorage.getItem('affiliateToken'),
            user: {
                fullName: localStorage.getItem('affiliateName') || '',
                email: '',
                refCode: localStorage.getItem('affiliateRefCode') || '',
                linkClicks: 0,
                totalSales: 0,
                currentBalance: 0,
                mpesaNumber: '',
                mpesaName: '',
                reuseDetails: false
            },
            settings: { commissionRate: 20, supportEmail: 'support@botblitz.store', copyrightText: 'Â© 2025 BotBlitz', whatsappLink: '#' },
            staticPages: [],
            notifications: [],
            withdrawals: [],
            rewards: [],
            leaderboard: [],
            unreadCount: 0,
            currentTab: 'home',
            currentPage: 1,
            loading: false,
            error: '',
            modal: { isOpen: false, title: '', content: '', className: '' }
        };

        let ws = null;

        // JWT Token Validation
        function isTokenValid(token) {
            try {
                const decoded = jwt_decode(token);
                return decoded.exp * 1000 > Date.now();
            } catch (e) {
                console.error('Token validation error:', e);
                return false;
            }
        }

        // Axios Interceptor
        axios.interceptors.request.use(config => {
            if (state.token) config.headers.Authorization = `Bearer ${state.token}`;
            config.headers['x-device-id'] = navigator.userAgent;
            return config;
        }, error => {
            console.error('Axios request error:', error);
            return Promise.reject(error);
        });

        // WebSocket Connection
        function connectWebSocket() {
            if (!state.user.email || !state.token) return;
            ws = new WebSocket(`${WS_URL}?token=${state.token}`);
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'linkClick') {
                    state.user.linkClicks = data.count;
                    render();
                } else if (data.type === 'notification') {
                    state.notifications = [[new Date().toISOString(), data.message, false], ...state.notifications];
                    state.unreadCount++;
                    render();
                } else if (data.type === 'popup') {
                    state.modal = { isOpen: true, title: 'Urgent Message', content: data.message, className: '' };
                    render();
                } else if (data.type === 'logout') {
                    logout();
                }
            };
            ws.onclose = () => {
                if (isTokenValid(state.token)) {
                    setTimeout(connectWebSocket, 5000);
                }
            };
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Show Toast
        function showToast(message, isError) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            toast.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Show Modal
        function showModal(title, content, className = '') {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.classList.remove('hidden');
            modal.classList.add(className);
            document.getElementById('modal-close').onclick = () => {
                modal.classList.add('hidden');
                state.modal.isOpen = false;
                render();
            };
        }

        // Cookie Consent
        function initCookieConsent() {
            if (localStorage.getItem('cookieConsent')) return;
            const cookieConsent = document.getElementById('cookie-consent');
            cookieConsent.classList.remove('hidden');
            document.getElementById('cookie-accept').onclick = () => {
                localStorage.setItem('cookieConsent', 'true');
                cookieConsent.classList.add('hidden');
            };
        }

        // Fetch Dashboard Data
        async function fetchDashboardData() {
            state.loading = true;
            state.error = '';
            render();
            try {
                const res = await axios.get(`${API_URL}/data`);
                state.user = { ...state.user, ...res.data };
                state.settings = res.data.settings;
                state.staticPages = res.data.staticPages;
                state.notifications = res.data.notifications || [];
                state.withdrawals = res.data.withdrawals || [];
                state.rewards = res.data.rewards || [];
                state.leaderboard = res.data.leaderboard || [];
                state.unreadCount = state.notifications.filter(n => !n[2]).length;
                state.user.email = res.data.email;
                connectWebSocket();
            } catch (err) {
                state.error = err.response?.data?.error || 'Failed to load data';
                showToast(state.error, true);
                if (err.response?.status === 403) {
                    logout();
                }
            } finally {
                state.loading = false;
                render();
            }
        }

        // Handle Signup/Login
        async function handleAuth(e) {
            e.preventDefault();
            state.error = '';
            state.loading = true;
            render();

            const fullName = document.getElementById('full-name')?.value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const terms = document.getElementById('terms')?.checked;

            // Client-side Validation
            if (!state.isLogin) {
                const names = fullName.split(' ').filter(name => name.trim() !== '');
                if (names.length < 2) {
                    state.error = 'Full name must include first and last name';
                    showToast(state.error, true);
                    state.loading = false;
                    render();
                    return;
                }
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    state.error = 'Invalid email format';
                    showToast(state.error, true);
                    state.loading = false;
                    render();
                    return;
                }
                if (password.length < 8 || !/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
                    state.error = 'Password must be 8+ characters with letters and numbers';
                    showToast(state.error, true);
                    state.loading = false;
                    render();
                    return;
                }
                if (!terms) {
                    state.error = 'You must accept the terms';
                    showToast(state.error, true);
                    state.loading = false;
                    render();
                    return;
                }
            }

            try {
                const endpoint = state.isLogin ? '/login' : '/register';
                const payload = state.isLogin
                    ? { email, password }
                    : { fullName, email, password, termsAccepted: terms };
                const res = await axios.post(`${API_URL}${endpoint}`, payload);
                state.token = res.data.token;
                localStorage.setItem('affiliateToken', res.data.token);
                localStorage.setItem('affiliateName', res.data.name);
                localStorage.setItem('affiliateRefCode', res.data.refCode);
                showToast(state.isLogin ? 'Login successful' : 'Account created successfully', false);
                window.location.hash = '/dashboard';
            } catch (err) {
                state.error = err.response?.data?.error || 'An error occurred';
                showToast(state.error, true);
            } finally {
                state.loading = false;
                render();
            }
        }

        // Handle Withdrawal
        async function handleWithdrawal(e) {
            e.preventDefault();
            state.error = '';
            state.loading = true;
            render();

            const amount = document.getElementById('withdrawal-amount').value;
            const mpesaNumber = document.getElementById('mpesa-number').value;
            const mpesaName = document.getElementById('mpesa-name').value;
            const reuseDetails = document.getElementById('reuse-details').checked;
            const password = document.getElementById('withdrawal-password').value;

            if (parseFloat(amount) > state.user.currentBalance) {
                state.error = 'Amount exceeds current balance';
                showToast(state.error, true);
                state.loading = false;
                render();
                return;
            }
            if (!/^07[0-9]{8}$/.test(mpesaNumber)) {
                state.error = 'Invalid M-PESA number (must be 07XXXXXXXX)';
                showToast(state.error, true);
                state.loading = false;
                render();
                return;
            }

            try {
                const res = await axios.post(`${API_URL}/request-withdrawal`, {
                    amount,
                    mpesaNumber,
                    mpesaName,
                    reuseDetails,
                    password
                });
                state.user.currentBalance -= parseFloat(amount);
                state.withdrawals = [[new Date().toISOString(), amount, mpesaNumber, mpesaName, 'Pending', '', reuseDetails], ...state.withdrawals];
                showModal('Withdrawal Submitted', `
                    <div class="text-center">
                        <i class="fas fa-check-circle text-4xl text-green-500 mb-4 tick-icon"></i>
                        <p>Your withdrawal request has been submitted successfully. You will receive it as soon as it is processed.</p>
                    </div>
                `, 'text-center');
                showToast('Withdrawal request submitted', false);
            } catch (err) {
                state.error = err.response?.data?.error || 'Withdrawal failed';
                showToast(state.error, true);
            } finally {
                state.loading = false;
                render();
            }
        }

        // Copy Affiliate Link
        function copyLink() {
            navigator.clipboard.writeText(`https://botblitz.store?ref=${state.user.refCode}`);
            showToast('Link copied to clipboard', false);
        }

        // Mark Notification as Read
        async function markNotificationRead(index) {
            const notification = state.notifications[index];
            if (notification[2]) return;
            try {
                await axios.post(`${API_URL}/mark-notification`, { timestamp: notification[0] });
                state.notifications[index][2] = true;
                state.unreadCount--;
                showToast('Notification marked as read', false);
                render();
            } catch (err) {
                showToast('Failed to mark notification', true);
            }
        }

        // Handle Password Update
        async function handlePasswordUpdate(e) {
            e.preventDefault();
            state.error = '';
            state.loading = true;
            render();

            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;

            try {
                await axios.post(`${API_URL}/update-password`, { currentPassword, newPassword });
                showToast('Password updated successfully', false);
                logout();
            } catch (err) {
                state.error = err.response?.data?.error || 'Password update failed';
                showToast(state.error, true);
                state.loading = false;
                render();
            }
        }

        // Handle Account Deletion
        async function handleDeleteAccount() {
            state.error = '';
            state.loading = true;
            render();

            const deletePassword = document.getElementById('delete-password').value;

            try {
                await axios.post(`${API_URL}/delete-account`, { password: deletePassword });
                showToast('Account deleted successfully', false);
                logout();
            } catch (err) {
                state.error = err.response?.data?.error || 'Account deletion failed';
                showToast(state.error, true);
                state.loading = false;
                render();
            }
        }

        // Logout
        function logout() {
            if (ws) ws.close();
            localStorage.clear();
            state.token = null;
            state.user = { fullName: '', email: '', refCode: '', linkClicks: 0, totalSales: 0, currentBalance: 0 };
            state.notifications = [];
            state.unreadCount = 0;
            window.location.hash = '/login';
        }

        // Routing
        function getCurrentRoute() {
            const hash = window.location.hash || '#/login';
            if (state.token && isTokenValid(state.token)) {
                if (hash === '#/login' || hash === '#/signup') return '/dashboard';
                return hash.slice(1);
            }
            if (hash === '#/dashboard') return '/login';
            return hash.slice(1);
        }

        // Render
        function render() {
            const app = document.getElementById('app');
            const route = getCurrentRoute();

            if (route === '/dashboard') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <!-- Navigation -->
                        <nav class="bg-white shadow-md">
                            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div class="flex justify-between h-16">
                                    <div class="flex items-center">
                                        <span class="text-xl font-bold text-gray-800">BotBlitz Affiliates</span>
                                    </div>
                                    <div class="flex items-center nav-icons space-x-4">
                                        <a href="${state.settings.whatsappLink}" target="_blank" class="text-2xl text-green-500">
                                            <i class="fab fa-whatsapp"></i>
                                        </a>
                                        <div class="relative">
                                            <button id="notifications-btn" class="relative focus:outline-none">
                                                <i class="fas fa-bell text-2xl text-gray-600"></i>
                                                ${state.unreadCount > 0 ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2">${state.unreadCount}</span>` : ''}
                                            </button>
                                        </div>
                                        <button id="settings-btn" class="focus:outline-none">
                                            <i class="fas fa-cog text-2xl text-gray-600"></i>
                                        </button>
                                        <button id="logout-btn" class="focus:outline-none">
                                            <i class="fas fa-sign-out-alt text-2xl text-gray-600"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </nav>

                        <!-- Main Content -->
                        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <h1 class="text-3xl font-bold mb-8 text-gray-800">Welcome, ${state.user.fullName}</h1>
                            <div class="flex space-x-4 mb-8">
                                <button id="tab-home" class="px-4 py-2 rounded-md focus:outline-none ${state.currentTab === 'home' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">Home</button>
                                <button id="tab-withdrawals" class="px-4 py-2 rounded-md focus:outline-none ${state.currentTab === 'withdrawals' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">Withdrawal History</button>
                                <button id="tab-rewards" class="px-4 py-2 rounded-md focus:outline-none ${state.currentTab === 'rewards' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">Rewards</button>
                                <button id="tab-leaderboard" class="px-4 py-2 rounded-md focus:outline-none ${state.currentTab === 'leaderboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">Leaderboard</button>
                            </div>
                            ${state.loading ? `
                                <div class="flex justify-center items-center">
                                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                                </div>
                            ` : state.error ? `
                                <p class="text-red-600">${state.error}</p>
                            ` : `
                                ${state.currentTab === 'home' ? `
                                    <div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                            <div class="bg-white p-6 rounded-lg shadow">
                                                <h2 class="text-xl font-bold mb-4 text-gray-800">Affiliate Link</h2>
                                                <p class="text-blue-500 break-all mb-2">https://botblitz.store?ref=${state.user.refCode}</p>
                                                <button id="copy-link" class="btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Copy Link</button>
                                            </div>
                                            <div class="bg-white p-6 rounded-lg shadow">
                                                <h2 class="text-xl font-bold mb-4 text-gray-800">Statistics</h2>
                                                <p><strong>Live Link Clicks:</strong> <span class="live-clicks font-semibold">${state.user.linkClicks || 0}</span></p>
                                                <p><strong>Total Sales:</strong> <span class="font-semibold">${state.user.totalSales || 0}</span></p>
                                                <p><strong>Current Balance:</strong> <span class="font-semibold">${(state.user.currentBalance || 0).toFixed(2)} KES</span></p>
                                                <button id="commission-info" class="mt-2 text-blue-500 hover:underline">How is commission calculated?</button>
                                            </div>
                                        </div>
                                        <div class="bg-white p-6 rounded-lg shadow mb-8">
                                            <h2 class="text-xl font-bold mb-4 text-gray-800">Withdraw Commission</h2>
                                            ${state.error ? `<p class="text-red-500 mb-4">${state.error}</p>` : ''}
                                            <form id="withdrawal-form">
                                                <div class="mb-4">
                                                    <label class="block text-sm font-medium text-gray-700">Amount (KES)</label>
                                                    <input type="number" id="withdrawal-amount" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" min="1" max="${state.user.currentBalance || 0}" required />
                                                </div>
                                                <div class="mb-4">
                                                    <label class="block text-sm font-medium text-gray-700">M-PESA Number</label>
                                                    <input type="text" id="mpesa-number" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" value="${state.user.mpesaNumber}" pattern="^07[0-9]{8}$" required />
                                                </div>
                                                <div class="mb-4">
                                                    <label class="block text-sm font-medium text-gray-700">M-PESA Name</label>
                                                    <input type="text" id="mpesa-name" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" value="${state.user.mpesaName}" required />
                                                </div>
                                                <div class="mb-4 flex items-center">
                                                    <input type="checkbox" id="reuse-details" class="mr-2" ${state.user.reuseDetails ? 'checked' : ''} />
                                                    <label class="text-sm text-gray-700">Save M-PESA details for future withdrawals</label>
                                                </div>
                                                <div class="mb-4">
                                                    <label class="block text-sm font-medium text-gray-700">Password</label>
                                                    <input type="password" id="withdrawal-password" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                                </div>
                                                <button type="submit" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400" ${state.user.currentBalance <= 0 ? 'disabled' : ''}>
                                                    ${state.loading ? '<i class="fas fa-spinner fa-spin"></i>' : 'Withdraw'}
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                ` : state.currentTab === 'withdrawals' ? `
                                    <div class="bg-white p-6 rounded-lg shadow">
                                        <h2 class="text-xl font-bold mb-4 text-gray-800">Withdrawal History</h2>
                                        <div class="table-container">
                                            <table class="min-w-full bg-white">
                                                <thead>
                                                    <tr>
                                                        <th class="py-2 px-4 border-b text-left">Amount (KES)</th>
                                                        <th class="py-2 px-4 border-b text-left">M-PESA Number</th>
                                                        <th class="py-2 px-4 border-b text-left">M-PESA Name</th>
                                                        <th class="py-2 px-4 border-b text-left">Status</th>
                                                        <th class="py-2 px-4 border-b text-left">Requested At</th>
                                                        <th class="py-2 px-4 border-b text-left">M-PESA Ref</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${state.withdrawals.slice((state.currentPage - 1) * pageSize, state.currentPage * pageSize).map(w => `
                                                        <tr>
                                                            <td class="py-2 px-4 border-b">${parseFloat(w[1]).toFixed(2)}</td>
                                                            <td class="py-2 px-4 border-b">${w[2]}</td>
                                                            <td class="py-2 px-4 border-b">${w[3]}</td>
                                                            <td class="py-2 px-4 border-b">${w[4]}</td>
                                                            <td class="py-2 px-4 border-b">${new Date(w[0]).toLocaleString()}</td>
                                                            <td class="py-2 px-4 border-b">${w[5] || '-'}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="mt-4 flex justify-between">
                                            <button id="prev-page" class="btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 disabled:bg-gray-400" ${state.currentPage === 1 ? 'disabled' : ''}>Previous</button>
                                            <span class="text-gray-700">Page ${state.currentPage} of ${Math.ceil(state.withdrawals.length / pageSize)}</span>
                                            <button id="next-page" class="btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 disabled:bg-gray-400" ${state.currentPage >= Math.ceil(state.withdrawals.length / pageSize) ? 'disabled' : ''}>Next</button>
                                        </div>
                                    </div>
                                ` : state.currentTab === 'rewards' ? `
                                    <div class="bg-white p-6 rounded-lg shadow">
                                        <h2 class="text-xl font-bold mb-4 text-gray-800">Rewards History</h2>
                                        <div class="table-container">
                                            <table class="min-w-full bg-white">
                                                <thead>
                                                    <tr>
                                                        <th class="py-2 px-4 border-b text-left">Amount (KES)</th>
                                                        <th class="py-2 px-4 border-b text-left">Description</th>
                                                        <th class="py-2 px-4 border-b text-left">Received At</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${state.rewards.map(r => `
                                                        <tr>
                                                            <td class="py-2 px-4 border-b">${parseFloat(r[2]).toFixed(2)}</td>
                                                            <td class="py-2 px-4 border-b">${r[3]}</td>
                                                            <td class="py-2 px-4 border-b">${new Date(r[0]).toLocaleString()}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ` : state.currentTab === 'leaderboard' ? `
                                    <div class="bg-white p-6 rounded-lg shadow">
                                        <h2 class="text-xl font-bold mb-4 text-gray-800">Top 10 Affiliates</h2>
                                        <div class="table-container">
                                            <table class="min-w-full bg-white">
                                                <thead>
                                                    <tr>
                                                        <th class="py-2 px-4 border-b text-left">Rank</th>
                                                        <th class="py-2 px-4 border-b text-left">Name</th>
                                                        <th class="py-2 px-4 border-b text-left">Total Sales</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${state.leaderboard.map((l, i) => `
                                                        <tr>
                                                            <td class="py-2 px-4 border-b">${i + 1}</td>
                                                            <td class="py-2 px-4 border-b">${l.name}</td>
                                                            <td class="py-2 px-4 border-b">${l.totalSales}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ` : ''}
                            `}
                        </main>

                        <!-- Footer -->
                        <footer class="bg-white shadow-md mt-8 py-4">
                            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-600">
                                <div class="mb-2 flex flex-wrap justify-center gap-2">
                                    ${state.staticPages.map(page => `<a href="/${page.slug}" class="text-blue-500 hover:underline" target="_blank">${page.title}</a>`).join(' ')}
                                </div>
                                <p>${state.settings.copyrightText}</p>
                            </div>
                        </footer>
                    </div>
                `;

                // Event Listeners for Dashboard
                document.getElementById('tab-home')?.addEventListener('click', () => {
                    state.currentTab = 'home';
                    render();
                });
                document.getElementById('tab-withdrawals')?.addEventListener('click', () => {
                    state.currentTab = 'withdrawals';
                    render();
                });
                document.getElementById('tab-rewards')?.addEventListener('click', () => {
                    state.currentTab = 'rewards';
                    render();
                });
                document.getElementById('tab-leaderboard')?.addEventListener('click', () => {
                    state.currentTab = 'leaderboard';
                    render();
                });
                document.getElementById('copy-link')?.addEventListener('click', copyLink);
                document.getElementById('commission-info')?.addEventListener('click', () => {
                    showModal('How Commission is Calculated', `Commission is calculated as ${state.settings.commissionRate}% of each confirmed sale. For example, a 1000 KES sale earns ${(state.settings.commissionRate / 100 * 1000).toFixed(2)} KES.`);
                });
                document.getElementById('withdrawal-form')?.addEventListener('submit', handleWithdrawal);
                document.getElementById('prev-page')?.addEventListener('click', () => {
                    state.currentPage--;
                    render();
                });
                document.getElementById('next-page')?.addEventListener('click', () => {
                    state.currentPage++;
                    render();
                });
                document.getElementById('notifications-btn')?.addEventListener('click', () => {
                    showModal('Notifications', `
                        <div class="max-h-64 overflow-y-auto">
                            ${state.notifications.length ? state.notifications.map((n, i) => `
                                <div class="mb-2 p-2 bg-gray-100 rounded flex justify-between items-center">
                                    <p class="${n[2] ? 'text-gray-600' : 'text-gray-800 font-semibold'}">${n[1]}</p>
                                    ${!n[2] ? `<button class="text-blue-500 hover:underline mark-read" data-index="${i}">Mark as Read</button>` : ''}
                                </div>
                            `).join('') : '<p>No notifications</p>'}
                        </div>
                    `);
                    document.querySelectorAll('.mark-read').forEach(btn => {
                        btn.addEventListener('click', () => markNotificationRead(btn.dataset.index));
                    });
                });
                document.getElementById('settings-btn')?.addEventListener('click', () => {
                    showModal('Settings', `
                        <div>
                            <form id="password-form" class="mb-4">
                                <h3 class="text-lg font-semibold mb-2">Change Password</h3>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Current Password</label>
                                    <input type="password" id="current-password" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">New Password</label>
                                    <input type="password" id="new-password" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" minlength="8" required />
                                </div>
                                <button type="submit" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400">
                                    ${state.loading ? '<i class="fas fa-spinner fa-spin"></i>' : 'Update Password'}
                                </button>
                            </form>
                            <div>
                                <h3 class="text-lg font-semibold mb-2">Delete Account</h3>
                                <button id="delete-account" class="btn bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete Account</button>
                            </div>
                        </div>
                    `);
                    document.getElementById('password-form').addEventListener('submit', handlePasswordUpdate);
                    document.getElementById('delete-account').addEventListener('click', () => {
                        showModal('Confirm Account Deletion', `
                            <div>
                                <p class="text-gray-600 mb-4">Are you sure you want to delete your account? This action cannot be undone.</p>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Password</label>
                                    <input type="password" id="delete-password" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                </div>
                                <div class="flex justify-end space-x-4">
                                    <button id="cancel-delete" class="btn bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">No</button>
                                    <button id="confirm-delete" class="btn bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                                        ${state.loading ? '<i class="fas fa-spinner fa-spin"></i>' : 'Yes'}
                                    </button>
                                </div>
                            </div>
                        `);
                        document.getElementById('cancel-delete').onclick = () => {
                            document.getElementById('modal').classList.add('hidden');
                            state.modal.isOpen = false;
                            render();
                        };
                        document.getElementById('confirm-delete').onclick = handleDeleteAccount;
                    });
                });
                document.getElementById('logout-btn')?.addEventListener('click', () => {
                    showToast('Logged out successfully', false);
                    logout();
                });
            } else {
                state.isLogin = route === '/login';
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gray-900">
                        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md auth-card">
                            <h1 class="text-2xl font-bold mb-6 text-center">${state.isLogin ? 'Affiliate Login' : 'Affiliate Sign Up'}</h1>
                            ${state.error ? `<p class="text-red-500 mb-4 text-center">${state.error}</p>` : ''}
                            ${state.loading ? `
                                <div class="flex justify-center items-center">
                                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                                </div>
                            ` : ''}
                            <form id="auth-form" class="${state.loading ? 'hidden' : ''}">
                                ${!state.isLogin ? `
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                        <input type="text" id="full-name" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                ` : ''}
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="email" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                                </div>
                                <div class="mb-4 relative">
                                    <label class="block text-sm font-medium text-gray-700">Password</label>
                                    <input type="password" id="password" class="mt-1 p-2 w-full border rounded-md focus:ring-blue-500 focus:border-blue-500" minlength="8" required />
                                    <button type="button" id="toggle-password" class="absolute right-2 top-8 text-gray-500">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                ${!state.isLogin ? `
                                    <div class="mb-4 flex items-center">
                                        <input type="checkbox" id="terms" class="mr-2" required />
                                        <label class="text-sm text-gray-700">
                                            I agree to the <a href="/page/botblitz/affiliate-terms" class="text-blue-500 hover:underline" target="_blank">Terms and Conditions</a>
                                        </label>
                                    </div>
                                ` : ''}
                                <button type="submit" class="w-full btn bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400">
                                    ${state.isLogin ? 'Login' : 'Create Account'}
                                </button>
                                <p class="mt-4 text-center text-sm text-gray-600">
                                    ${state.isLogin ? 'Need an account?' : 'Already have an account?'}
                                    <a href="#${state.isLogin ? '/signup' : '/login'}" id="toggle-auth" class="text-blue-500 hover:underline">${state.isLogin ? 'Sign Up' : 'Login'}</a>
                                </p>
                            </form>
                            <footer class="mt-8 text-center text-sm text-gray-600">
                                <div class="mb-2 flex flex-wrap justify-center gap-2">
                                    ${state.staticPages.map(page => `<a href="/${page.slug}" class="text-blue-500 hover:underline" target="_blank">${page.title}</a>`).join(' ')}
                                </div>
                                <p>${state.settings.copyrightText}</p>
                            </footer>
                        </div>
                    </div>
                `;

                // Event Listeners for Auth Page
                document.getElementById('auth-form').addEventListener('submit', handleAuth);
                document.getElementById('toggle-password').addEventListener('click', () => {
                    const passwordInput = document.getElementById('password');
                    const isVisible = passwordInput.type === 'text';
                    passwordInput.type = isVisible ? 'password' : 'text';
                    document.getElementById('toggle-password').innerHTML = `<i class="fas ${isVisible ? 'fa-eye' : 'fa-eye-slash'}"></i>`;
                });
            }

            if (state.modal.isOpen) {
                showModal(state.modal.title, state.modal.content, state.modal.className);
            }
        }

        // Initial Setup
        document.addEventListener('DOMContentLoaded', () => {
            if (state.token && isTokenValid(state.token)) {
                window.location.hash = '/dashboard';
                fetchDashboardData();
            } else {
                window.location.hash = '/login';
            }
            initCookieConsent();
            render();
        });

        window.addEventListener('hashchange', render);
    </script>
</body>
</html>
