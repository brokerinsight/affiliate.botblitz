<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Deriv Bot Store Affiliates</title>
  <link href="/output.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Custom Popup Component
    const Popup = ({ message, type, onClose }) => (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
          <div className="flex items-center mb-4">
            <i className={`fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} text-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-500 mr-2`}></i>
            <p className="text-gray-900 dark:text-white">{message}</p>
          </div>
          <button
            onClick={onClose}
            className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
          >
            OK
          </button>
        </div>
      </div>
    );

    // Login Form Component
    const LoginForm = ({ handleLogin, error, loading, attemptsLeft }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [showPassword, setShowPassword] = useState(false);

      return (
        <div className="flex items-center justify-center min-h-screen px-4">
          <div className="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 className="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">Admin Login</h2>
            {error && <p className="text-red-500 text-center mb-4">{error}</p>}
            {attemptsLeft < 5 && (
              <p className="text-yellow-500 text-center mb-4">{attemptsLeft} login attempts remaining</p>
            )}
            <form onSubmit={(e) => {
              e.preventDefault();
              handleLogin({ email, password });
            }}>
              <div className="mb-4">
                <label className="block text-gray-700 dark:text-gray-200 mb-1">Email</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-600"
                  required
                />
              </div>
              <div className="mb-4 relative">
                <label className="block text-gray-700 dark:text-gray-200 mb-1">Password</label>
                <input
                  type={showPassword ? 'text' : 'password'}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-600"
                  required
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-2 top-9 text-gray-500 dark:text-gray-300"
                >
                  <i className={`fas fa-eye${showPassword ? '-slash' : ''}`}></i>
                </button>
              </div>
              <button
                type="submit"
                className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 transition duration-200"
                disabled={loading || attemptsLeft === 0}
              >
                {loading ? 'Logging in...' : 'Login'}
              </button>
            </form>
          </div>
        </div>
      );
    };

    // Admin Dashboard Component
    const AdminDashboard = ({ setIsLoggedIn }) => {
      const [activeTab, setActiveTab] = useState('home');
      const [settings, setSettings] = useState({});
      const [affiliates, setAffiliates] = useState([]);
      const [pendingWithdrawals, setPendingWithdrawals] = useState([]);
      const [sortedWithdrawals, setSortedWithdrawals] = useState([]);
      const [staticPages, setStaticPages] = useState([]);
      const [leaderboard, setLeaderboard] = useState([]);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [popup, setPopup] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [sortBy, setSortBy] = useState('sales');
      const [currentPage, setCurrentPage] = useState(1);
      const [rewardForm, setRewardForm] = useState({
        topN: 5,
        rewardType: 'fixed',
        rewardValue: '',
        duration: 30,
      });
      const [saleRewardForm, setSaleRewardForm] = useState({
        threshold: 10,
        rewardType: 'fixed',
        rewardValue: '',
        duration: 30,
      });
      const [notificationForm, setNotificationForm] = useState({
        message: '',
        filter: 'all',
        saleCount: '',
      });
      const [urgentPopupForm, setUrgentPopupForm] = useState({ message: '', enabled: false });
      const [newPageForm, setNewPageForm] = useState({ title: '', content: '' });
      const [editPage, setEditPage] = useState(null);
      const [settingsForm, setSettingsForm] = useState({
        supportEmail: '',
        whatsappLink: '',
        copyrightText: '',
        adminEmail: '',
        adminPassword: '',
        commissionRate: '',
      });
      const itemsPerPage = 20;

      // Fetch initial data
      useEffect(() => {
        const token = document.cookie.split('; ').find(row => row.startsWith('jwt='))?.split('=')[1];
        axios.get('/api/admin/affiliate/data', { withCredentials: true })
          .then(res => {
            setSettings(res.data.settings);
            setAffiliates(res.data.affiliates);
            setPendingWithdrawals(res.data.pendingWithdrawals);
            setSortedWithdrawals(res.data.sortedWithdrawals);
            setStaticPages(res.data.staticPages);
            setLeaderboard(res.data.leaderboard);
            setUrgentPopupForm(res.data.settings.urgentPopup || { message: '', enabled: false });
            setSettingsForm({
              supportEmail: res.data.settings.supportEmail || '',
              whatsappLink: res.data.settings.whatsappLink || '',
              copyrightText: res.data.settings.copyrightText || '',
              adminEmail: res.data.settings.adminEmail || '',
              adminPassword: '',
              commissionRate: (res.data.settings.commissionRate * 100) || '',
            });
          })
          .catch(err => {
            setError(err.response?.data?.error || 'Failed to fetch data');
            setIsLoggedIn(false);
          });

        // WebSocket setup
        const socket = io('https://affiliate-botblitz.onrender.com', { auth: { token } });
        socket.on('update', (newData) => {
          setSettings(newData.settings || settings);
          setAffiliates(newData.affiliates || affiliates);
          setPendingWithdrawals(newData.pendingWithdrawals || pendingWithdrawals);
          setSortedWithdrawals(newData.sortedWithdrawals || sortedWithdrawals);
          setStaticPages(newData.staticPages || staticPages);
          setLeaderboard(newData.leaderboard || leaderboard);
        });
        socket.on('forceLogout', () => {
          setPopup({ message: 'Session terminated by admin', type: 'error' });
          setTimeout(() => {
            document.cookie = 'jwt=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
            setIsLoggedIn(false);
          }, 2000);
        });
        return () => socket.disconnect();
      }, []);

      // Handle settings update
      const handleSettingsUpdate = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        try {
          if (settingsForm.adminPassword && (settingsForm.adminPassword.length < 8 || !/[a-zA-Z]/.test(settingsForm.adminPassword) || !/[0-9]/.test(settingsForm.adminPassword))) {
            throw new Error('Password must be 8+ characters with letters and numbers');
          }
          if (settingsForm.commissionRate && (settingsForm.commissionRate <= 0 || settingsForm.commissionRate > 100)) {
            throw new Error('Commission rate must be between 1 and 100%');
          }
          const payload = {
            ...settingsForm,
            commissionRate: settingsForm.commissionRate ? settingsForm.commissionRate / 100 : settings.commissionRate,
          };
          await axios.post('/api/admin/affiliate/settings', payload, { withCredentials: true });
          setSuccess('Settings updated successfully');
          setSettingsForm(prev => ({ ...prev, adminPassword: '' }));
          if (payload.adminPassword) setIsLoggedIn(false); // Force re-login after password change
        } catch (err) {
          setError(err.response?.data?.error || err.message || 'Failed to update settings');
        }
      };

      // Handle affiliate actions (block/delete)
      const handleAffiliateAction = async (email, action) => {
        setError('');
        setSuccess('');
        try {
          await axios.post(`/api/admin/affiliate/${action}`, { email }, { withCredentials: true });
          setSuccess(`${action.charAt(0).toUpperCase() + action.slice(1)} successful`);
          setAffiliates(prev => prev.filter(a => a.email !== email));
        } catch (err) {
          setError(err.response?.data?.error || `Failed to ${action} affiliate`);
        }
      };

      // Handle withdrawal confirmation
      const handleWithdrawalConfirm = async (withdrawal, mpesaRef) => {
        setError('');
        setSuccess('');
        try {
          await axios.post('/api/admin/affiliate/withdrawals/confirm', { ...withdrawal, mpesaRef }, { withCredentials: true });
          setSuccess('Withdrawal confirmed');
          setPendingWithdrawals(prev => prev.filter(w => w.email !== withdrawal.email || w.timestamp !== withdrawal.timestamp));
        } catch (err) {
          setError(err.response?.data?.error || 'Failed to confirm withdrawal');
        }
      };

      // Handle withdrawal dispute
      const handleWithdrawalDispute = async (withdrawal) => {
        setError('');
        setSuccess('');
        try {
          await axios.post('/api/admin/affiliate/withdrawals/dispute', withdrawal, { withCredentials: true });
          setSuccess('Withdrawal disputed and refunded');
          setPendingWithdrawals(prev => prev.filter(w => w.email !== withdrawal.email || w.timestamp !== withdrawal.timestamp));
        } catch (err) {
          setError(err.response?.data?.error || 'Failed to dispute withdrawal');
        }
      };

      // Handle reward submission
      const handleRewardSubmit = async (e, type) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        try {
          const formData = type === 'leaderboard' ? rewardForm : saleRewardForm;
          if (formData.rewardValue <= 0) throw new Error('Reward value must be positive');
          await axios.post(`/api/admin/affiliate/rewards`, { ...formData, type }, { withCredentials: true });
          setSuccess(`${type.charAt(0).toUpperCase() + type.slice(1)} reward applied`);
          if (type === 'leaderboard') {
            setRewardForm({ topN: 5, rewardType: 'fixed', rewardValue: '', duration: 30 });
          } else {
            setSaleRewardForm({ threshold: 10, rewardType: 'fixed', rewardValue: '', duration: 30 });
          }
        } catch (err) {
          setError(err.response?.data?.error || `Failed to apply ${type} reward`);
        }
      };

      // Terminate ongoing reward
      const handleTerminateReward = async (rewardId) => {
        setError('');
        setSuccess('');
        try {
          await axios.post('/api/admin/affiliate/rewards/terminate', { rewardId }, { withCredentials: true });
          setSuccess('Reward terminated');
          setLeaderboard(prev => prev.filter(r => r.rewardId !== rewardId));
        } catch (err) {
          setError(err.response?.data?.error || 'Failed to terminate reward');
        }
      };

      // Handle notification submission
      const handleNotificationSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        try {
          if (!notificationForm.message) throw new Error('Notification message is required');
          await axios.post('/api/admin/affiliate/communication', { type: 'notification', ...notificationForm }, { withCredentials: true });
          setSuccess('Notification sent');
          setNotificationForm({ message: '', filter: 'all', saleCount: '' });
        } catch (err) {
          setError(err.response?.data?.error || 'Failed to send notification');
        }
      };

      // Handle urgent popup update
      const handleUrgentPopupUpdate = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        try {
          if (!urgentPopupForm.message && urgentPopupForm.enabled) throw new Error('Popup message is required when enabled');
          await axios.post('/api/admin/affiliate/communication', { type: 'popup', ...urgentPopupForm }, { withCredentials: true });
          setSuccess('Urgent popup updated');
        } catch (err) {
          setError(err.response?.data?.error || 'Failed to update popup');
        }
      };

      // Handle static page actions
      const handlePageAction = async (action, pageData) => {
        setError('');
        setSuccess('');
        try {
          await axios.post(`/api/admin/affiliate/staticpages`, { action, ...pageData }, { withCredentials: true });
          setSuccess(`${action.charAt(0).toUpperCase() + action.slice(1)} page successful`);
          setNewPageForm({ title: '', content: '' });
          setEditPage(null);
          if (action !== 'edit') {
            axios.get('/api/admin/affiliate/staticpages', { withCredentials: true })
              .then(res => setStaticPages(res.data));
          }
        } catch (err) {
          setError(err.response?.data?.error || `Failed to ${action} page`);
        }
      };

      // Filter and sort affiliates
      const filteredAffiliates = affiliates
        .filter(a => a.name.toLowerCase().includes(searchQuery.toLowerCase()))
        .sort((a, b) => {
          if (sortBy === 'sales') return b.saleCount - a.saleCount;
          if (sortBy === 'withdrawals') return b.withdrawnTotal - a.withdrawnTotal;
          return b.linkClicks - a.linkClicks;
        });

      // Pagination for sorted withdrawals
      const paginatedSortedWithdrawals = sortedWithdrawals.slice(
        (currentPage - 1) * itemsPerPage,
        currentPage * itemsPerPage
      );

      return (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          {popup && <Popup message={popup.message} type={popup.type} onClose={() => setPopup(null)} />}
          <header className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Affiliate Admin Panel</h1>
            <button
              onClick={() => {
                document.cookie = 'jwt=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
                setIsLoggedIn(false);
              }}
              className="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400"
            >
              <i className="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
          </header>
          <nav className="flex flex-wrap gap-2 mb-6">
            {['home', 'affiliates', 'pending-withdrawals', 'sorted-withdrawals', 'rewards', 'static-pages', 'communication', 'settings'].map(tab => (
              <button
                key={tab}
                onClick={() => { setActiveTab(tab); setCurrentPage(1); setError(''); setSuccess(''); }}
                className={`px-4 py-2 rounded-md text-sm font-medium transition duration-200 ${
                  activeTab === tab
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600'
                }`}
              >
                {tab.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}
              </button>
            ))}
          </nav>
          {success && (
            <div className="mb-4 p-4 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-md">
              {success}
            </div>
          )}
          {error && (
            <div className="mb-4 p-4 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-md">
              {error}
            </div>
          )}
          {activeTab === 'home' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Global Settings</h2>
              <div className="space-y-4">
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Support Email</label>
                  <input
                    type="email"
                    value={settings.supportEmail || ''}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    disabled
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Copyright Text</label>
                  <input
                    type="text"
                    value={settings.copyrightText || ''}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    disabled
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">WhatsApp Link</label>
                  <input
                    type="url"
                    value={settings.whatsappLink || ''}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    disabled
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Commission Rate (%)</label>
                  <input
                    type="number"
                    value={settings.commissionRate * 100 || ''}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    disabled
                    step="0.1"
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Admin Email</label>
                  <input
                    type="email"
                    value={settings.adminEmail || ''}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    disabled
                  />
                </div>
                <p className="text-gray-600 dark:text-gray-300 text-sm">To update settings, use the Settings tab.</p>
              </div>
            </div>
          )}
          {activeTab === 'affiliates' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Affiliates</h2>
              <div className="flex flex-col sm:flex-row justify-between mb-4">
                <input
                  type="text"
                  placeholder="Search by name..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-full sm:w-1/3 p-2 border rounded-md dark:bg-gray-700 dark:text-white mb-2 sm:mb-0"
                />
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value)}
                  className="w-full sm:w-1/4 p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                >
                  <option value="sales">Sort by Sales</option>
                  <option value="withdrawals">Sort by Withdrawals</option>
                  <option value="clicks">Sort by Link Clicks</option>
                </select>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full table-auto">
                  <thead>
                    <tr className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                      <th className="p-3 text-left text-sm">Name</th>
                      <th className="p-3 text-left text-sm">Email</th>
                      <th className="p-3 text-left text-sm">Join Date</th>
                      <th className="p-3 text-left text-sm">Link Clicks</th>
                      <th className="p-3 text-left text-sm">Sale Count</th>
                      <th className="p-3 text-left text-sm">Total Earnings</th>
                      <th className="p-3 text-left text-sm">Withdrawn</th>
                      <th className="p-3 text-left text-sm">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredAffiliates.map(a => (
                      <tr key={a.email} className="border-b dark:border-gray-700">
                        <td className="p-3 text-gray-900 dark:text-white text-sm">{a.name}</td>
                        <td className="p-3 text-gray-900 dark:text-white text-sm">{a.email}</td>
                        <td className="p-3 text-gray-900 dark:text-white text-sm">{new Date(a.joinDate).toLocaleDateString()}</td>
                        <td className="p-3 text-gray-900 dark:text-white text-sm">{a.linkClicks}</td>
                        <td className="p-3 text-gray-900 dark:text-white text-sm">{a.saleCount}</td>
                        <td className="p-3 text-gray-900 dark:text-white text-sm">KES {a.totalEarnings.toFixed(2)}</td>
                        <td className="p-3 text-gray-900 dark:text-white text-sm">KES {a.withdrawnTotal.toFixed(2)}</td>
                        <td className="p-3 text-sm">
                          <button
                            onClick={() => handleAffiliateAction(a.email, 'block')}
                            className="text-yellow-600 hover:text-yellow-700 mr-2"
                            title="Block"
                          >
                            <i className="fas fa-ban"></i>
                          </button>
                          <button
                            onClick={() => handleAffiliateAction(a.email, 'delete')}
                            className="text-red-600 hover:text-red-700"
                            title="Delete"
                          >
                            <i className="fas fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              {filteredAffiliates.length === 0 && (
                <p className="text-gray-600 dark:text-gray-300 mt-4">No affiliates found.</p>
              )}
            </div>
          )}
          {activeTab === 'pending-withdrawals' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Pending Withdrawals</h2>
              {pendingWithdrawals.length === 0 ? (
                <p className="text-gray-600 dark:text-gray-300">No pending withdrawals.</p>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full table-auto">
                    <thead>
                      <tr className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                        <th className="p-3 text-left text-sm">Email</th>
                        <th className="p-3 text-left text-sm">Timestamp</th>
                        <th className="p-3 text-left text-sm">Amount</th>
                        <th className="p-3 text-left text-sm">Mpesa Number</th>
                        <th className="p-3 text-left text-sm">Mpesa Name</th>
                        <th className="p-3 text-left text-sm">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {pendingWithdrawals.map(w => (
                        <tr key={`${w.email}-${w.timestamp}`} className="border-b dark:border-gray-700">
                          <td className="p-3 text-gray-900 dark:text-white text-sm">{w.email}</td>
                          <td className="p-3 text-gray-900 dark:text-white text-sm">{new Date(w.timestamp).toLocaleString()}</td>
                          <td className="p-3 text-gray-900 dark:text-white text-sm">KES {w.amount.toFixed(2)}</td>
                          <td className="p-3 text-gray-900 dark:text-white text-sm">
                            {w.mpesaNumber}
                            <button
                              onClick={() => navigator.clipboard.write(w.mpesaNumber).then(() => setSuccess('Mpesa number copied'))}
                              className="ml-2 text-blue-600 hover:text-blue-700"
                              title="Copy"
                            >
                              <i className="fas fa-copy"></i>
                            </button>
                          </td>
                          <td className="p-3 text-gray-900 dark:text-white text-sm">{w.mpesaName}</td>
                          <td className="p-3 text-sm">
                            <select
                              onChange={(e) => {
                                if (e.target.value === 'done') {
                                  const mpesaRef = prompt('Enter Mpesa Reference Code:');
                                  if (mpesaRef) handleWithdrawalConfirm(w, mpesaRef);
                                } else if (e.target.value === 'dispute') {
                                  handleWithdrawalDispute(w);
                                }
                                e.target.value = '';
                              }}
                              className="p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                            >
                              <option value="">Select Action</option>
                              <option value="done">Done</option>
                              <option value="dispute">Dispute</option>
                            </select>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}
          {activeTab === 'sorted-withdrawals' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Sorted Withdrawals</h2>
              {paginatedSortedWithdrawals.length === 0 ? (
                <p className="text-gray-600 dark:text-gray-300">No sorted withdrawals.</p>
              ) : (
                <>
                  <div className="overflow-x-auto">
                    <table className="w-full table-auto">
                      <thead>
                        <tr className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                          <th className="p-3 text-left text-sm">Email</th>
                          <th className="p-3 text-left text-sm">Timestamp</th>
                          <th className="p-3 text-left text-sm">Amount</th>
                          <th className="p-3 text-left text-sm">Mpesa Number</th>
                          <th className="p-3 text-left text-sm">Mpesa Name</th>
                          <th className="p-3 text-left text-sm">Status</th>
                          <th className="p-3 text-left text-sm">Mpesa Ref</th>
                        </tr>
                      </thead>
                      <tbody>
                        {paginatedSortedWithdrawals.map(w => (
                          <tr key={`${w.email}-${w.timestamp}`} className="border-b dark:border-gray-700">
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{w.email}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{new Date(w.timestamp).toLocaleString()}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">KES {w.amount.toFixed(2)}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{w.mpesaNumber}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{w.mpesaName}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{w.status}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{w.mpesaRef || '-'}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <div className="flex justify-between mt-4">
                    <button
                      onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                      disabled={currentPage === 1}
                      className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      Previous
                    </button>
                    <button
                      onClick={() => setCurrentPage(prev => prev + 1)}
                      disabled={currentPage * itemsPerPage >= sortedWithdrawals.length}
                      className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      Next
                    </button>
                  </div>
                </>
              )}
            </div>
          )}
          {activeTab === 'rewards' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Rewards Management</h2>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Leaderboard Rewards</h3>
                <form onSubmit={(e) => handleRewardSubmit(e, 'leaderboard')} className="space-y-4">
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Top N Affiliates</label>
                    <input
                      type="number"
                      value={rewardForm.topN}
                      onChange={(e) => setRewardForm({ ...rewardForm, topN: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                      required
                      min="1"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Reward Type</label>
                    <select
                      value={rewardForm.rewardType}
                      onChange={(e) => setRewardForm({ ...rewardForm, rewardType: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    >
                      <option value="fixed">Fixed KES</option>
                      <option value="percentage">Percentage of Commission</option>
                      <option value="commission">Increase Commission Rate</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Reward Value</label>
                    <input
                      type="number"
                      value={rewardForm.rewardValue}
                      onChange={(e) => setRewardForm({ ...rewardForm, rewardValue: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                      required
                      min="0"
                      step="0.01"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Duration (days)</label>
                    <input
                      type="number"
                      value={rewardForm.duration}
                      onChange={(e) => setRewardForm({ ...rewardForm, duration: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                      required
                      min="1"
                    />
                  </div>
                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
                  >
                    Apply Leaderboard Reward
                  </button>
                </form>
              </div>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Sale Count Rewards</h3>
                <form onSubmit={(e) => handleRewardSubmit(e, 'sale')} className="space-y-4">
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Sale Threshold</label>
                    <input
                      type="number"
                      value={saleRewardForm.threshold}
                      onChange={(e) => setSaleRewardForm({ ...saleRewardForm, threshold: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                      required
                      min="1"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Reward Type</label>
                    <select
                      value={saleRewardForm.rewardType}
                      onChange={(e) => setSaleRewardForm({ ...saleRewardForm, rewardType: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    >
                      <option value="fixed">Fixed KES</option>
                      <option value="percentage">Percentage of Commission</option>
                      <option value="commission">Increase Commission Rate</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Reward Value</label>
                    <input
                      type="number"
                      value={saleRewardForm.rewardValue}
                      onChange={(e) => setSaleRewardForm({ ...saleRewardForm, rewardValue: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                      required
                      min="0"
                      step="0.01"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Duration (days)</label>
                    <input
                      type="number"
                      value={saleRewardForm.duration}
                      onChange={(e) => setSaleRewardForm({ ...saleRewardForm, duration: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                      required
                      min="1"
                    />
                  </div>
                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
                  >
                    Apply Sale Reward
                  </button>
                </form>
              </div>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Ongoing Rewards</h3>
                {leaderboard.filter(r => r.ongoing).length === 0 ? (
                  <p className="text-gray-600 dark:text-gray-300">No ongoing rewards.</p>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full table-auto">
                      <thead>
                        <tr className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                          <th className="p-3 text-left text-sm">Affiliate</th>
                          <th className="p-3 text-left text-sm">Reward Type</th>
                          <th className="p-3 text-left text-sm">Value</th>
                          <th className="p-3 text-left text-sm">End Date</th>
                          <th className="p-3 text-left text-sm">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {leaderboard.filter(r => r.ongoing).map(r => (
                          <tr key={r.rewardId} className="border-b dark:border-gray-700">
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{r.affiliateName}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{r.rewardType}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{r.rewardValue}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{new Date(r.endDate).toLocaleDateString()}</td>
                            <td className="p-3 text-sm">
                              <button
                                onClick={() => handleTerminateReward(r.rewardId)}
                                className="text-red-600 hover:text-red-700"
                                title="Terminate"
                              >
                                <i className="fas fa-times"></i>
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          )}
          {activeTab === 'static-pages' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Static Pages</h2>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">{editPage ? 'Edit Page' : 'Create New Page'}</h3>
                <form
                  onSubmit={(e) => {
                    e.preventDefault();
                    handlePageAction(editPage ? 'edit' : 'create', editPage ? { ...editPage, ...newPageForm } : newPageForm);
                  }}
                  className="space-y-4"
                >
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Title</label>
                    <input
                      type="text"
                      value={newPageForm.title}
                      onChange={(e) => setNewPageForm({ ...newPageForm, title: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Content (HTML)</label>
                    <textarea
                      value={newPageForm.content}
                      onChange={(e) => setNewPageForm({ ...newPageForm, content: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white h-40"
                      required
                    ></textarea>
                  </div>
                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
                  >
                    {editPage ? 'Update Page' : 'Create Page'}
                  </button>
                  {editPage && (
                    <button
                      type="button"
                      onClick={() => setEditPage(null)}
                      className="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700"
                    >
                      Cancel
                    </button>
                  )}
                </form>
              </div>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Existing Pages</h3>
                {staticPages.length === 0 ? (
                  <p className="text-gray-600 dark:text-gray-300">No static pages.</p>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full table-auto">
                      <thead>
                        <tr className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                          <th className="p-3 text-left text-sm">Title</th>
                          <th className="p-3 text-left text-sm">Slug</th>
                          <th className="p-3 text-left text-sm">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {staticPages.map(p => (
                          <tr key={p.slug} className="border-b dark:border-gray-700">
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{p.title}</td>
                            <td className="p-3 text-gray-900 dark:text-white text-sm">{p.slug}</td>
                            <td className="p-3 text-sm">
                              <button
                                onClick={() => {
                                  setEditPage(p);
                                  setNewPageForm({ title: p.title, content: p.content });
                                }}
                                className="text-blue-600 hover:text-blue-700 mr-2"
                                title="Edit"
                              >
                                <i className="fas fa-edit"></i>
                              </button>
                              <button
                                onClick={() => handlePageAction('delete', { slug: p.slug })}
                                className="text-red-600 hover:text-red-700"
                                title="Delete"
                              >
                                <i className="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          )}
          {activeTab === 'communication' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Communication</h2>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Urgent Popup</h3>
                <form onSubmit={handleUrgentPopupUpdate} className="space-y-4">
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Message</label>
                    <textarea
                      value={urgentPopupForm.message}
                      onChange={(e) => setUrgentPopupForm({ ...urgentPopupForm, message: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white h-24"
                    ></textarea>
                  </div>
                  <div>
                    <label className="flex items-center">
                      <input
                        type="checkbox"
                        checked={urgentPopupForm.enabled}
                        onChange={(e) => setUrgentPopupForm({ ...urgentPopupForm, enabled: e.target.checked })}
                        className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="text-gray-700 dark:text-gray-200 text-sm">Enabled (shows on every dashboard refresh)</span>
                    </label>
                  </div>
                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
                  >
                    Update Urgent Popup
                  </button>
                </form>
              </div>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">Bell Icon Notification</h3>
                <form onSubmit={handleNotificationSubmit} className="space-y-4">
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Message</label>
                    <textarea
                      value={notificationForm.message}
                      onChange={(e) => setNotificationForm({ ...notificationForm, message: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white h-24"
                      required
                    ></textarea>
                  </div>
                  <div>
                    <label className="block text-gray-700 dark:text-gray-200 mb-1">Filter</label>
                    <select
                      value={notificationForm.filter}
                      onChange={(e) => setNotificationForm({ ...notificationForm, filter: e.target.value })}
                      className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    >
                      <option value="all">All Affiliates</option>
                      <option value="saleCount">Sale Count Below</option>
                    </select>
                  </div>
                  {notificationForm.filter === 'saleCount' && (
                    <div>
                      <label className="block text-gray-700 dark:text-gray-200 mb-1">Sale Count Threshold</label>
                      <input
                        type="number"
                        value={notificationForm.saleCount}
                        onChange={(e) => setNotificationForm({ ...notificationForm, saleCount: e.target.value })}
                        className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                        required
                        min="0"
                      />
                    </div>
                  )}
                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
                  >
                    Send Notification
                  </button>
                </form>
              </div>
            </div>
          )}
          {activeTab === 'settings' && (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
              <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Admin Settings</h2>
              <form onSubmit={handleSettingsUpdate} className="space-y-4">
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Support Email</label>
                  <input
                    type="email"
                    value={settingsForm.supportEmail}
                    onChange={(e) => setSettingsForm({ ...settingsForm, supportEmail: e.target.value })}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">WhatsApp Link</label>
                  <input
                    type="url"
                    value={settingsForm.whatsappLink}
                    onChange={(e) => setSettingsForm({ ...settingsForm, whatsappLink: e.target.value })}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Copyright Text</label>
                  <input
                    type="text"
                    value={settingsForm.copyrightText}
                    onChange={(e) => setSettingsForm({ ...settingsForm, copyrightText: e.target.value })}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Admin Email</label>
                  <input
                    type="email"
                    value={settingsForm.adminEmail}
                    onChange={(e) => setSettingsForm({ ...settingsForm, adminEmail: e.target.value })}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">New Admin Password</label>
                  <input
                    type="password"
                    value={settingsForm.adminPassword}
                    onChange={(e) => setSettingsForm({ ...settingsForm, adminPassword: e.target.value })}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                  />
                </div>
                <div>
                  <label className="block text-gray-700 dark:text-gray-200 mb-1">Commission Rate (%)</label>
                  <input
                    type="number"
                    value={settingsForm.commissionRate}
                    onChange={(e) => setSettingsForm({ ...settingsForm, commissionRate: e.target.value })}
                    className="w-full p-2 border rounded-md dark:bg-gray-700 dark:text-white"
                    step="0.1"
                  />
                </div>
                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700"
                >
                  Update Settings
                </button>
              </form>
            </div>
          )}
          <footer className="mt-8 text-center text-gray-600 dark:text-gray-300">
            <p>{settings.copyrightText || 'Deriv Bot Store Affiliates 2025'}</p>
          </footer>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [attemptsLeft, setAttemptsLeft] = useState(5);

      // Check for existing session
      useEffect(() => {
        const token = document.cookie.split('; ').find(row => row.startsWith('jwt='))?.split('=')[1];
        if (token) {
          axios.get('/api/admin/affiliate/verify', { withCredentials: true })
            .then(() => setIsLoggedIn(true))
            .catch(() => {
              setError('Session expired. Please log in again.');
              document.cookie = 'jwt=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
            });
        }
      }, []);

      // Handle login
      const handleLogin = async (formData) => {
        setError('');
        setLoading(true);
        try {
          const res = await axios.post('/api/admin/affiliate/login', formData, { withCredentials: true });
          document.cookie = `jwt=${res.data.token}; path=/; secure; samesite=strict`;
          setIsLoggedIn(true);
          setAttemptsLeft(5);
        } catch (err) {
          setError(err.response?.data?.error || 'Login failed');
          setAttemptsLeft(err.response?.data?.attemptsLeft || 0);
        } finally {
          setLoading(false);
        }
      };

      return (
        <>
          {isLoggedIn ? (
            <AdminDashboard setIsLoggedIn={setIsLoggedIn} />
          ) : (
            <LoginForm
              handleLogin={handleLogin}
              error={error}
              loading={loading}
              attemptsLeft={attemptsLeft}
            />
          )}
        </>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
