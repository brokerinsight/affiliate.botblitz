<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deriv Bot Store Affiliates Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <style>
    .notification { transform: translateX(100%); transition: transform 0.3s ease-in-out, opacity 0.3s; }
    .notification.show { transform: translateX(0); }
    .notification.hide { opacity: 0; }
    .card-hover:hover { transform: translateY(-2px); transition: transform 0.2s; }
    .fade-out { animation: fadeOut 0.3s forwards; }
    @keyframes fadeOut { to { opacity: 0; } }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <span id="logo" class="text-2xl font-bold">Deriv Bot Store Affiliates Admin</span>
      </div>
      <div class="flex items-center space-x-4">
        <button id="logout-btn" class="hidden bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-200">Logout</button>
        <button id="theme-toggle" aria-label="Toggle theme" class="p-2">
          <svg id="theme-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-[calc(100vh-8rem)]">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow max-w-xl w-full sm:w-3/4 md:w-1/2 lg:w-1/3">
        <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
        <div class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm font-medium">Email</label>
            <input id="login-email" type="email" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
          </div>
          <div>
            <label for="login-password" class="block text-sm font-medium">Password</label>
            <div class="relative">
              <input id="login-password" type="password" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
              <button id="toggle-login-password" class="absolute right-2 top-2 text-sm text-blue-500">Show</button>
            </div>
          </div>
          <button id="login-submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex justify-center items-center min-w-[120px] transition duration-200 hover:scale-105">
            Login
            <svg id="login-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
            </svg>
          </button>
        </div>
        <p class="text-center text-sm text-gray-500 mt-4">Deriv Bot Store Affiliates 2025</p>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <!-- Tabs Navigation -->
      <nav class="flex flex-wrap gap-2 mb-6">
        <button data-tab="home" class="tab-btn bg-blue-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Home</button>
        <button data-tab="affiliates" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Affiliates</button>
        <button data-tab="pending-withdrawals" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Pending Withdrawals</button>
        <button data-tab="sorted-withdrawals" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Sorted Withdrawals</button>
        <button data-tab="rewards" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Rewards</button>
        <button data-tab="static-pages" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Static Pages</button>
        <button data-tab="communication" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Communication</button>
        <button data-tab="password-resets" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Password Resets</button>
        <button data-tab="settings" class="tab-btn bg-gray-500 text-white px-4 py-2 rounded-md transition duration-200 hover:scale-105">Settings</button>
      </nav>

      <!-- Tab Content -->
      <div id="home-tab" class="tab-content">
        <h2 class="text-xl font-bold mb-4">Settings Overview</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <div class="space-y-4">
            <div>
              <label for="support-email" class="block text-sm font-medium">Support Email</label>
              <input id="support-email" type="email" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" value="derivbotstore@gmail.com">
            </div>
            <div>
              <label for="copyright-text" class="block text-sm font-medium">Copyright Text</label>
              <input id="copyright-text" type="text" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" value="Deriv Bot Store Affiliates 2025">
            </div>
            <div>
              <label for="whatsapp-link" class="block text-sm font-medium">WhatsApp Link</label>
              <input id="whatsapp-link" type="url" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" value="https://wa.link/4wppln">
            </div>
            <div>
              <label for="commission-rate" class="block text-sm font-medium">Commission Rate (0â€“1)</label>
              <input id="commission-rate" type="number" step="0.01" min="0" max="1" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" value="0.2">
            </div>
            <div>
              <label for="logo-url" class="block text-sm font-medium">Logo URL</label>
              <input id="logo-url" type="url" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
            </div>
            <button id="save-settings" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center min-w-[120px] transition duration-200 hover:scale-105">
              Save Settings
              <svg id="save-settings-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="affiliates-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Affiliates</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <div class="flex flex-col md:flex-row gap-4 mb-4">
            <input id="affiliate-search" type="text" placeholder="Search by Name, Email, or Username" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
            <select id="affiliate-sort" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
              <option value="monthly-sales">Monthly Sales: High to Low</option>
              <option value="status-active">Status: Active</option>
              <option value="status-blocked">Status: Blocked</option>
              <option value="status-deleted">Status: Deleted</option>
            </select>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-200 dark:bg-gray-700">
                  <th class="p-2 text-left">Name</th>
                  <th class="p-2 text-left">Email</th>
                  <th class="p-2 text-left">Username</th>
                  <th class="p-2 text-left">Join Date</th>
                  <th class="p-2 text-left">Link Clicks</th>
                  <th class="p-2 text-left">Sale Count</th>
                  <th class="p-2 text-left">Current Balance (KES)</th>
                  <th class="p-2 text-left">Withdrawn Total (KES)</th>
                  <th class="p-2 text-left">Monthly Sales</th>
                  <th class="p-2 text-left">Status</th>
                </tr>
              </thead>
              <tbody id="affiliates-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="pending-withdrawals-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Pending Withdrawals</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-200 dark:bg-gray-700">
                  <th class="p-2 text-left">Email</th>
                  <th class="p-2 text-left">Name</th>
                  <th class="p-2 text-left">Timestamp</th>
                  <th class="p-2 text-left">Amount (KES)</th>
                  <th class="p-2 text-left">MPESA Number</th>
                  <th class="p-2 text-left">MPESA Name</th>
                  <th class="p-2 text-left">Payment Refcode</th>
                  <th class="p-2 text-left">Status</th>
                </tr>
              </thead>
              <tbody id="pending-withdrawals-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="sorted-withdrawals-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Sorted Withdrawals</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-200 dark:bg-gray-700">
                  <th class="p-2 text-left">Email</th>
                  <th class="p-2 text-left">Name</th>
                  <th class="p-2 text-left">Timestamp</th>
                  <th class="p-2 text-left">Amount (KES)</th>
                  <th class="p-2 text-left">MPESA Number</th>
                  <th class="p-2 text-left">MPESA Name</th>
                  <th class="p-2 text-left">Payment Refcode</th>
                  <th class="p-2 text-left">Status</th>
                </tr>
              </thead>
              <tbody id="sorted-withdrawals-table"></tbody>
            </table>
            <div class="flex justify-between mt-4">
              <button id="prev-sorted-page" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 disabled:opacity-50 min-w-[120px] transition duration-200 hover:scale-105">Previous</button>
              <button id="next-sorted-page" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 disabled:opacity-50 min-w-[120px] transition duration-200 hover:scale-105">Next</button>
            </div>
          </div>
        </div>
      </div>

      <div id="rewards-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Rewards</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <h3 class="text-lg font-semibold mb-2">Leaderboard Rewards</h3>
          <div class="mb-4">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-200 dark:bg-gray-700">
                  <th class="p-2 text-left">Rank</th>
                  <th class="p-2 text-left">Name</th>
                  <th class="p-2 text-left">Email</th>
                  <th class="p-2 text-left">Monthly Sales</th>
                </tr>
              </thead>
              <tbody id="leaderboard-table"></tbody>
            </table>
            <div class="mt-4">
              <label for="percentage-reward" class="block text-sm font-medium">Percentage Reward (0â€“1)</label>
              <input id="percentage-reward" type="number" step="0.01" min="0" max="1" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
              <button id="apply-percentage-reward" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center min-w-[120px] transition duration-200 hover:scale-105">
                Apply Reward
                <svg id="percentage-reward-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                </svg>
              </button>
            </div>
          </div>
          <h3 class="text-lg font-semibold mb-2">Spot Rewards</h3>
          <div>
            <label for="spot-amount" class="block text-sm font-medium">Spot Amount (KES)</label>
            <input id="spot-amount" type="number" min="0" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
            <button id="select-recipients" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 min-w-[120px] transition duration-200 hover:scale-105">Select Recipients</button>
          </div>
        </div>
      </div>

      <div id="static-pages-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Static Pages</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <button id="create-page" class="mb-4 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 min-w-[120px] transition duration-200 hover:scale-105">Create Page</button>
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-200 dark:bg-gray-700">
                <th class="p-2 text-left">Slug</th>
                <th class="p-2 text-left">Title</th>
                <th class="p-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="static-pages-table"></tbody>
          </table>
        </div>
      </div>

      <div id="communication-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Communication</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <h3 class="text-lg font-semibold mb-2">Urgent Message</h3>
          <div class="space-y-4 mb-4">
            <div>
              <label for="urgent-message" class="block text-sm font-medium">Message</label>
              <textarea id="urgent-message" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" rows="4"></textarea>
            </div>
            <div>
              <label class="flex items-center">
                <input id="urgent-enabled" type="checkbox" class="mr-2">
                <span>Enabled</span>
              </label>
            </div>
            <button id="save-urgent" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center min-w-[120px] transition duration-200 hover:scale-105">
              Save
              <svg id="save-urgent-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
              </svg>
            </button>
          </div>
          <h3 class="text-lg font-semibold mb-2">News</h3>
          <div class="space-y-4">
            <div>
              <label for="news-message" class="block text-sm font-medium">Message</label>
              <textarea id="news-message" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" rows="4"></textarea>
            </div>
            <div>
              <label for="news-filter" class="block text-sm font-medium">Filter</label>
              <select id="news-filter" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                <option value="all">All Affiliates</option>
              </select>
            </div>
            <button id="send-news" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center min-w-[120px] transition duration-200 hover:scale-105">
              Send
              <svg id="send-news-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="password-resets-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Password Resets</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-200 dark:bg-gray-700">
                  <th class="p-2 text-left">Email</th>
                  <th class="p-2 text-left">Username</th>
                  <th class="p-2 text-left">Name</th>
                  <th class="p-2 text-left">Last Withdrawal Amount</th>
                  <th class="p-2 text-left">Description</th>
                  <th class="p-2 text-left">Timestamp</th>
                  <th class="p-2 text-left">Status</th>
                </tr>
              </thead>
              <tbody id="password-resets-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="settings-tab" class="tab-content hidden">
        <h2 class="text-xl font-bold mb-4">Admin Settings</h2>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <div class="space-y-4">
            <div>
              <label for="old-email" class="block text-sm font-medium">Old Email</label>
              <input id="old-email" type="email" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
            </div>
            <div>
              <label for="new-email" class="block text-sm font-medium">New Email</label>
              <input id="new-email" type="email" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
            </div>
            <div>
              <label for="old-password" class="block text-sm font-medium">Old Password</label>
              <div class="relative">
                <input id="old-password" type="password" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                <button id="toggle-old-password" class="absolute right-2 top-2 text-sm text-blue-500">Show</button>
              </div>
            </div>
            <div>
              <label for="new-password" class="block text-sm font-medium">New Password</label>
              <div class="relative">
                <input id="new-password" type="password" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                <button id="toggle-new-password" class="absolute right-2 top-2 text-sm text-blue-500">Show</button>
              </div>
            </div>
            <div>
              <label for="confirm-new-password" class="block text-sm font-medium">Confirm New Password</label>
              <div class="relative">
                <input id="confirm-new-password" type="password" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                <button id="toggle-confirm-new-password" class="absolute right-2 top-2 text-sm text-blue-500">Show</button>
              </div>
            </div>
            <button id="save-credentials" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center min-w-[120px] transition duration-200 hover:scale-105">
              Save Credentials
              <svg id="save-credentials-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white dark:bg-gray-800 py-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <span id="footer-copyright">Deriv Bot Store Affiliates 2025</span>
    </div>
  </footer>

  <!-- Notifications Container -->
  <div id="notifications" class="fixed top-4 right-4 space-y-2 max-w-sm"></div>

  <!-- Modals -->
  <div id="recipients-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-4xl w-full">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Select Recipients</h2>
        <button id="close-recipients-modal" class="text-gray-500 hover:text-gray-700">Ã—</button>
      </div>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200 dark:bg-gray-700">
            <th class="p-2 text-left">Email</th>
            <th class="p-2 text-left">Name</th>
            <th class="p-2 text-left">Monthly Sales</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">Select</th>
          </tr>
        </thead>
        <tbody id="recipients-table"></tbody>
      </table>
      <div class="mt-4 flex justify-end">
        <button id="apply-spot-reward" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center min-w-[120px] transition duration-200 hover:scale-105">
          Apply Spot Reward
          <svg id="spot-reward-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div id="page-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h2 id="page-modal-title" class="text-xl font-bold">Create Page</h2>
        <button id="close-page-modal" class="text-gray-500 hover:text-gray-700">Ã—</button>
      </div>
      <div class="space-y-4">
        <div>
          <label for="page-title" class="block text-sm font-medium">Title</label>
          <input id="page-title" type="text" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
        </div>
        <div>
          <label for="page-content" class="block text-sm font-medium">Content</label>
          <textarea id="page-content" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" rows="6"></textarea>
        </div>
        <div class="flex justify-end space-x-2">
          <button id="save-page" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center min-w-[120px] transition duration-200 hover:scale-105">
            Save
            <svg id="save-page-loading" class="hidden w-5 h-5 ml-2 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
            </svg>
          </button>
          <button id="cancel-page" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 min-w-[120px] transition duration-200 hover:scale-105">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="delete-page-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full">
      <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
      <p>Are you sure you want to delete this page?</p>
      <div class="flex justify-end space-x-2 mt-4">
        <button id="confirm-delete-page" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 min-w-[120px] transition duration-200 hover:scale-105">Delete</button>
        <button id="cancel-delete-page" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 min-w-[120px] transition duration-200 hover:scale-105">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://affiliate-botblitz.onrender.com';
    let ws = null;
    let currentTab = 'home';
    let affiliates = [];
    let pendingWithdrawals = [];
    let sortedWithdrawals = [];
    let staticPages = [];
    let passwordResets = [];
    let leaderboard = [];
    let settings = {};
    let notificationsQueue = [];
    let currentSortedPage = 1;
    let totalSortedPages = 1;

    // Utility Functions
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/;secure;sameSite=strict`;
    }

    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
    }

    function showNotification(message, color = 'blue') {
      const id = `NOTIF${Date.now()}`;
      notificationsQueue.push({ id, message, color });
      if (notificationsQueue.length > 3) {
        const oldest = notificationsQueue.shift();
        const el = document.getElementById(oldest.id);
        if (el) el.remove();
      }
      renderNotifications();
    }

    function renderNotifications() {
      const container = document.getElementById('notifications');
      container.innerHTML = notificationsQueue.map(n => `
        <div id="${n.id}" class="notification bg-white dark:bg-gray-800 p-4 rounded shadow border-l-4 border-${n.color}-500 flex justify-between items-center">
          <span>${n.message}</span>
          <button onclick="closeNotification('${n.id}')" class="text-gray-500 hover:text-gray-700">Ã—</button>
        </div>
      `).join('');
      setTimeout(() => {
        notificationsQueue.forEach(n => {
          const el = document.getElementById(n.id);
          if (el) el.classList.add('show');
          setTimeout(() => {
            closeNotification(n.id);
          }, 30000);
        });
      }, 100);
    }

    function closeNotification(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('hide');
        setTimeout(() => {
          notificationsQueue = notificationsQueue.filter(n => n.id !== id);
          el.remove();
          renderNotifications();
        }, 300);
      }
    }

    // Enhanced error handling for API calls
    async function handleApiError(err, message) {
      if (err.message.includes('401')) {
        deleteCookie('jwt');
        if (ws) ws.close();
        showLogin();
        showNotification('Session expired, please login again', 'red');
      } else if (err.message.includes('404')) {
        showNotification('Resource not found, please try again later', 'red');
      } else {
        showNotification(message || err.message, 'red');
      }
    }

    // Override fetchWithAuth for better error handling
    async function fetchWithAuth(url, options = {}) {
      const token = getCookie('jwt');
      if (!token) {
        showLogin();
        throw new Error('No authentication token');
      }
      options.headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
      try {
        const res = await fetch(url, options);
        const data = await res.json();
        if (!res.ok) throw new Error(`${res.status} ${data.error || 'Request failed'}`);
        return data;
      } catch (err) {
        throw err;
      }
    }

    // Theme Toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.getElementById('theme-icon').innerHTML = isDark
        ? `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`
        : `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z" />`;
    });

    // Initialize Theme
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
      document.getElementById('theme-icon').innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
    }

    // WebSocket Setup
    function setupWebSocket() {
      const token = getCookie('jwt');
      if (!token) return;
      ws = new WebSocket(`wss://affiliate-botblitz.onrender.com/ws/affiliate?token=${token}`);
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'update') {
          if (currentTab === 'home') fetchSettings();
          if (currentTab === 'affiliates') fetchAffiliates();
          if (currentTab === 'pending-withdrawals') fetchPendingWithdrawals();
          if (currentTab === 'sorted-withdrawals') fetchSortedWithdrawals();
          if (currentTab === 'rewards') fetchLeaderboard();
        } else if (data.type === 'notification') {
          showNotification(data.message, data.colour);
        } else if (data.type === 'logout') {
          deleteCookie('jwt');
          ws.close();
          showNotification('Logged out', 'green');
          showLogin();
        }
      };
      ws.onclose = () => {
        setTimeout(setupWebSocket, 5000);
      };
    }

    // Authentication Check
    async function checkAuth() {
      const token = getCookie('jwt');
      if (!token) {
        showLogin();
        return;
      }
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/validate`);
        showDashboard();
        setupWebSocket();
        fetchSettings();
        if (currentTab === 'home') fetchSettings();
        else document.querySelector(`[data-tab="${currentTab}"]`).click();
      } catch (err) {
        deleteCookie('jwt');
        showLogin();
        showNotification('Session expired, please login', 'red');
      }
    }

    function showLogin() {
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('logout-btn').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('logout-btn').classList.remove('hidden');
    }

    // Login
    document.getElementById('login-submit').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const btn = document.getElementById('login-submit');
      const loading = document.getElementById('login-loading');
      if (!email || !password) return showNotification('Please fill all fields', 'red');
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        const data = await fetch(`${API_BASE}/api/admin/affiliate/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        }).then(res => res.json());
        if (!data.success) throw new Error(data.error);
        setCookie('jwt', data.token, 7);
        showDashboard();
        setupWebSocket();
        fetchSettings();
        document.querySelector(`[data-tab="${currentTab}"]`).click();
      } catch (err) {
        showNotification(err.message || 'Login failed', 'red');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    // Toggle Password Visibility
    document.getElementById('toggle-login-password').addEventListener('click', () => {
      const input = document.getElementById('login-password');
      const btn = document.getElementById('toggle-login-password');
      input.type = input.type === 'password' ? 'text' : 'password';
      btn.textContent = input.type === 'password' ? 'Show' : 'Hide';
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', () => {
      deleteCookie('jwt');
      if (ws) ws.close();
      showLogin();
      showNotification('Logged out successfully', 'green');
    });

    // Tab Switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentTab = btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.replace('bg-blue-500', 'bg-gray-500'));
        btn.classList.replace('bg-gray-500', 'bg-blue-500');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`${currentTab}-tab`).classList.remove('hidden');
        if (currentTab === 'home') fetchSettings();
        if (currentTab === 'affiliates') fetchAffiliates();
        if (currentTab === 'pending-withdrawals') fetchPendingWithdrawals();
        if (currentTab === 'sorted-withdrawals') fetchSortedWithdrawals();
        if (currentTab === 'rewards') fetchLeaderboard();
        if (currentTab === 'static-pages') fetchStaticPages();
        if (currentTab === 'communication') fetchCommunication();
        if (currentTab === 'password-resets') fetchPasswordResets();
      });
    });

    // Fetch Settings
    async function fetchSettings() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/settings`);
        settings = data.settings;
        document.getElementById('support-email').value = settings.supportEmail;
        document.getElementById('copyright-text').value = settings.copyrightText;
        document.getElementById('whatsapp-link').value = settings.whatsappLink;
        document.getElementById('commission-rate').value = settings.commissionRate;
        document.getElementById('logo-url').value = settings.logoUrl || '';
        document.getElementById('footer-copyright').textContent = settings.copyrightText;
        if (settings.logoUrl) {
          document.getElementById('logo').innerHTML = `<img src="${settings.logoUrl}" alt="Deriv Bot Store Affiliates Admin" class="h-8">`;
        }
      } catch (err) {
        handleApiError(err, 'Failed to load settings');
      }
    }

    // Save Settings
    document.getElementById('save-settings').addEventListener('click', async () => {
      const btn = document.getElementById('save-settings');
      const loading = document.getElementById('save-settings-loading');
      const settingsData = {
        supportEmail: document.getElementById('support-email').value,
        copyrightText: document.getElementById('copyright-text').value,
        whatsappLink: document.getElementById('whatsapp-link').value,
        commissionRate: parseFloat(document.getElementById('commission-rate').value),
        logoUrl: document.getElementById('logo-url').value
      };
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/settings`, {
          method: 'POST',
          body: JSON.stringify(settingsData)
        });
        showNotification('Settings updated', 'green');
        fetchSettings();
      } catch (err) {
        handleApiError(err, 'Failed to save settings');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    // Fetch Affiliates
    async function fetchAffiliates() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/affiliates`);
        affiliates = data.affiliates;
        renderAffiliates();
      } catch (err) {
        handleApiError(err, 'Failed to load affiliates');
      }
    }

    function renderAffiliates() {
      const search = document.getElementById('affiliate-search').value.toLowerCase();
      const sort = document.getElementById('affiliate-sort').value;
      let filtered = affiliates.filter(a =>
        a.name.toLowerCase().includes(search) ||
        a.email.toLowerCase().includes(search) ||
        a.username.toLowerCase().includes(search)
      );
      if (sort === 'monthly-sales') {
        filtered.sort((a, b) => b.totalSalesMonthly - a.totalSalesMonthly);
      } else if (sort === 'status-active') {
        filtered = filtered.filter(a => a.statusjson.status === 'active');
      } else if (sort === 'status-blocked') {
        filtered = filtered.filter(a => a.statusjson.status === 'blocked');
      } else if (sort === 'status-deleted') {
        filtered = filtered.filter(a => a.statusjson.status === 'deleted');
      }
      document.getElementById('affiliates-table').innerHTML = filtered.map(a => `
        <tr class="border-b dark:border-gray-700">
          <td class="p-2">${a.name}</td>
          <td class="p-2">${a.email}</td>
          <td class="p-2">${a.username}</td>
          <td class="p-2">${new Date(a.joinDate).toLocaleDateString()}</td>
          <td class="p-2">${a.linkClicks}</td>
          <td class="p-2">${a.totalSales}</td>
          <td class="p-2">${a.currentBalance.toFixed(2)}</td>
          <td class="p-2">${a.withdrawnTotal.toFixed(2)}</td>
          <td class="p-2">${a.totalSalesMonthly}</td>
          <td class="p-2">
            <select data-email="${a.email}" class="status-select p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600">
              <option value="active" ${a.statusjson.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="blocked" ${a.statusjson.status === 'blocked' ? 'selected' : ''}>Blocked</option>
              <option value="deleted" ${a.statusjson.status === 'deleted' ? 'selected' : ''}>Delete</option>
            </select>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async () => {
          const email = select.dataset.email;
          const status = select.value;
          try {
            await fetchWithAuth(`${API_BASE}/api/admin/affiliate/update-status`, {
              method: 'POST',
              body: JSON.stringify({ email, status })
            });
            showNotification('Status updated', 'green');
            fetchAffiliates();
          } catch (err) {
            handleApiError(err, 'Failed to update status');
          }
        });
      });
    }

    document.getElementById('affiliate-search').addEventListener('input', renderAffiliates);
    document.getElementById('affiliate-sort').addEventListener('change', renderAffiliates);

    // Fetch Pending Withdrawals
    async function fetchPendingWithdrawals() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/withdrawals`);
        pendingWithdrawals = data.withdrawals;
        renderPendingWithdrawals();
      } catch (err) {
        handleApiError(err, 'Failed to load pending withdrawals');
      }
    }

    function renderPendingWithdrawals() {
      document.getElementById('pending-withdrawals-table').innerHTML = pendingWithdrawals.map(w => `
        <tr class="border-b dark:border-gray-700">
          <td class="p-2">${w.email}</td>
          <td class="p-2">${w.name}</td>
          <td class="p-2">${new Date(w.timestamp).toLocaleString()}</td>
          <td class="p-2">${w.amount.toFixed(2)}</td>
          <td class="p-2">
            ${w.mpesaNumber}
            <button data-mpesa="${w.mpesaNumber}" class="copy-mpesa ml-2 bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600 min-w-[60px] transition duration-200 hover:scale-105">Copy</button>
          </td>
          <td class="p-2">${w.mpesaName}</td>
          <td class="p-2">
            <input data-id="${w.id}" class="refcode-input p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600" value="${w.paymentRefcode || ''}">
          </td>
          <td class="p-2">
            <select data-id="${w.id}" class="status-select p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600">
              <option value="Pending" ${w.status === 'Pending' ? 'selected' : ''}>Pending</option>
              <option value="Done">Done</option>
              <option value="Dispute">Dispute</option>
            </select>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.copy-mpesa').forEach(btn => {
        btn.addEventListener('click', () => {
          const text = btn.dataset.mpesa;
          navigator.clipboard.writeText(text).then(() => {
            showNotification('MPESA number copied', 'green');
          }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification('MPESA number copied', 'green');
          });
        });
      });
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async () => {
          const id = select.dataset.id;
          const status = select.value;
          const refcode = document.querySelector(`.refcode-input[data-id="${id}"]`).value;
          if (status === 'Done' && !refcode) {
            showNotification('Enter the ref code', 'red');
            select.value = 'Pending';
            return;
          }
          try {
            await fetchWithAuth(`${API_BASE}/api/admin/affiliate/withdrawals/${status.toLowerCase()}`, {
              method: 'POST',
              body: JSON.stringify({ email: pendingWithdrawals.find(w => w.id === id).email, withdrawalId: id, status, refCode: refcode })
            });
            showNotification('Withdrawal processed', 'green');
            fetchPendingWithdrawals();
            fetchSortedWithdrawals();
          } catch (err) {
            handleApiError(err, 'Failed to process withdrawal');
            select.value = 'Pending';
          }
        });
      });
    }

    // Fetch Sorted Withdrawals
    async function fetchSortedWithdrawals() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/sorted-withdrawals?page=${currentSortedPage}`);
        sortedWithdrawals = data.withdrawals;
        totalSortedPages = data.totalPages;
        renderSortedWithdrawals();
      } catch (err) {
        handleApiError(err, 'Failed to load sorted withdrawals');
      }
    }

    function renderSortedWithdrawals() {
      document.getElementById('sorted-withdrawals-table').innerHTML = sortedWithdrawals.map(w => `
        <tr class="border-b dark:border-gray-700">
          <td class="p-2">${w.email}</td>
          <td class="p-2">${w.name}</td>
          <td class="p-2">${new Date(w.timestamp).toLocaleString()}</td>
          <td class="p-2">${w.amount.toFixed(2)}</td>
          <td class="p-2">${w.mpesaNumber}</td>
          <td class="p-2">${w.mpesaName}</td>
          <td class="p-2">${w.paymentRefcode || ''}</td>
          <td class="p-2">${w.status}</td>
        </tr>
      `).join('');
      document.getElementById('prev-sorted-page').disabled = currentSortedPage === 1;
      document.getElementById('next-sorted-page').disabled = currentSortedPage === totalSortedPages;
    }

    document.getElementById('prev-sorted-page').addEventListener('click', () => {
      if (currentSortedPage > 1) {
        currentSortedPage--;
        fetchSortedWithdrawals();
      }
    });

    document.getElementById('next-sorted-page').addEventListener('click', () => {
      if (currentSortedPage < totalSortedPages) {
        currentSortedPage++;
        fetchSortedWithdrawals();
      }
    });

    // Fetch Leaderboard
    async function fetchLeaderboard() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/affiliates`);
        leaderboard = data.affiliates
          .filter(a => a.statusjson.status === 'active')
          .sort((a, b) => b.totalSalesMonthly - a.totalSalesMonthly)
          .slice(0, 10);
        renderLeaderboard();
      } catch (err) {
        handleApiError(err, 'Failed to load leaderboard');
      }
    }

    function renderLeaderboard() {
      document.getElementById('leaderboard-table').innerHTML = leaderboard.map((a, i) => `
        <tr class="border-b dark:border-gray-700">
          <td class="p-2">${i + 1}</td>
          <td class="p-2">${a.name}</td>
          <td class="p-2">${a.email}</td>
          <td class="p-2">${a.totalSalesMonthly}</td>
        </tr>
      `).join('');
    }

    // Apply Percentage Reward
    document.getElementById('apply-percentage-reward').addEventListener('click', async () => {
      const percentage = parseFloat(document.getElementById('percentage-reward').value);
      const btn = document.getElementById('apply-percentage-reward');
      const loading = document.getElementById('percentage-reward-loading');
      if (!percentage || percentage < 0 || percentage > 1) {
        showNotification('Invalid percentage', 'red');
        return;
      }
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/rewards`, {
          method: 'POST',
          body: JSON.stringify({ type: 'percentage', percentage })
        });
        showNotification('Rewards applied', 'green');
        fetchLeaderboard();
      } catch (err) {
        handleApiError(err, 'Failed to apply rewards');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    // Select Recipients for Spot Reward
    document.getElementById('select-recipients').addEventListener('click', async () => {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/affiliates`);
        const activeAffiliates = data.affiliates.filter(a => a.statusjson.status === 'active');
        document.getElementById('recipients-table').innerHTML = activeAffiliates.map(a => `
          <tr class="border-b dark:border-gray-700">
            <td class="p-2">${a.email}</td>
            <td class="p-2">${a.name}</td>
            <td class="p-2">${a.totalSalesMonthly}</td>
            <td class="p-2">${a.statusjson.status}</td>
            <td class="p-2">
              <input type="checkbox" data-email="${a.email}" class="recipient-checkbox">
            </td>
          </tr>
        `).join('');
        document.getElementById('recipients-modal').classList.remove('hidden');
      } catch (err) {
        handleApiError(err, 'Failed to load affiliates');
      }
    });

    document.getElementById('close-recipients-modal').addEventListener('click', () => {
      document.getElementById('recipients-modal').classList.add('hidden');
    });

    // Apply Spot Reward
    document.getElementById('apply-spot-reward').addEventListener('click', async () => {
      const amount = parseFloat(document.getElementById('spot-amount').value);
      const recipients = Array.from(document.querySelectorAll('.recipient-checkbox:checked')).map(cb => cb.dataset.email);
      const btn = document.getElementById('apply-spot-reward');
      const loading = document.getElementById('spot-reward-loading');
      if (!amount || amount <= 0) {
        showNotification('Invalid amount', 'red');
        return;
      }
      if (!recipients.length) {
        showNotification('Select at least one recipient', 'red');
        return;
      }
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/rewards`, {
          method: 'POST',
          body: JSON.stringify({ type: 'spot', amount, recipients })
        });
        showNotification('Spot rewards applied', 'green');
        document.getElementById('recipients-modal').classList.add('hidden');
        fetchLeaderboard();
      } catch (err) {
        handleApiError(err, 'Failed to apply spot rewards');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    // Fetch Static Pages
    async function fetchStaticPages() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/staticpages`);
        staticPages = data.pages;
        renderStaticPages();
      } catch (err) {
        handleApiError(err, 'Failed to load static pages');
      }
    }

    function renderStaticPages() {
      document.getElementById('static-pages-table').innerHTML = staticPages.map(p => `
        <tr class="border-b dark:border-gray-700">
          <td class="p-2">${p.slug}</td>
          <td class="p-2">${p.title}</td>
          <td class="p-2">
            <button data-slug="${p.slug}" class="edit-page bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600 min-w-[60px] transition duration-200 hover:scale-105">Edit</button>
            <button data-slug="${p.slug}" class="delete-page bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 min-w-[60px] transition duration-200 hover:scale-105">Delete</button>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.edit-page').forEach(btn => {
        btn.addEventListener('click', () => {
          const page = staticPages.find(p => p.slug === btn.dataset.slug);
          document.getElementById('page-modal-title').textContent = 'Edit Page';
          document.getElementById('page-title').value = page.title;
          document.getElementById('page-content').value = page.content;
          document.getElementById('save-page').dataset.slug = page.slug;
          document.getElementById('page-modal').classList.remove('hidden');
        });
      });
      document.querySelectorAll('.delete-page').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('confirm-delete-page').dataset.slug = btn.dataset.slug;
          document.getElementById('delete-page-modal').classList.remove('hidden');
        });
      });
    }

    document.getElementById('create-page').addEventListener('click', () => {
      document.getElementById('page-modal-title').textContent = 'Create Page';
      document.getElementById('page-title').value = '';
      document.getElementById('page-content').value = '';
      delete document.getElementById('save-page').dataset.slug;
      document.getElementById('page-modal').classList.remove('hidden');
    });

    document.getElementById('close-page-modal').addEventListener('click', () => {
      document.getElementById('page-modal').classList.add('hidden');
    });

    document.getElementById('cancel-page').addEventListener('click', () => {
      document.getElementById('page-modal').classList.add('hidden');
    });

    document.getElementById('save-page').addEventListener('click', async () => {
      const title = document.getElementById('page-title').value;
      const content = document.getElementById('page-content').value;
      const slug = document.getElementById('save-page').dataset.slug || `/affiliate-${title.toLowerCase().replace(/\s+/g, '-')}`;
      const btn = document.getElementById('save-page');
      const loading = document.getElementById('save-page-loading');
      if (!title || !content) {
        showNotification('Please fill all fields', 'red');
        return;
      }
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/staticpages`, {
          method: 'POST',
          body: JSON.stringify({ slug, title, content })
        });
        showNotification('Page saved', 'green');
        document.getElementById('page-modal').classList.add('hidden');
        fetchStaticPages();
      } catch (err) {
        handleApiError(err, 'Failed to save page');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    document.getElementById('confirm-delete-page').addEventListener('click', async () => {
      const slug = document.getElementById('confirm-delete-page').dataset.slug;
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/staticpages/delete`, {
          method: 'POST',
          body: JSON.stringify({ slug })
        });
        showNotification('Page deleted', 'green');
        document.getElementById('delete-page-modal').classList.add('hidden');
        fetchStaticPages();
      } catch (err) {
        handleApiError(err, 'Failed to delete page');
      }
    });

    document.getElementById('cancel-delete-page').addEventListener('click', () => {
      document.getElementById('delete-page-modal').classList.add('hidden');
    });

    // Fetch Communication
    async function fetchCommunication() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/settings`);
        const urgent = JSON.parse(data.settings.urgentPopup || '{}');
        document.getElementById('urgent-message').value = urgent.message || '';
        document.getElementById('urgent-enabled').checked = urgent.enabled || false;
      } catch (err) {
        handleApiError(err, 'Failed to load communication settings');
      }
    }

    document.getElementById('save-urgent').addEventListener('click', async () => {
      const message = document.getElementById('urgent-message').value;
      const enabled = document.getElementById('urgent-enabled').checked;
      const btn = document.getElementById('save-urgent');
      const loading = document.getElementById('save-urgent-loading');
      if (!message) {
        showNotification('Message is required', 'red');
        return;
      }
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/communication`, {
          method: 'POST',
          body: JSON.stringify({ type: 'urgent', message, enabled })
        });
        showNotification('Urgent message updated', 'green');
      } catch (err) {
        handleApiError(err, 'Failed to save urgent message');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    document.getElementById('send-news').addEventListener('click', async () => {
      const message = document.getElementById('news-message').value;
      const filter = document.getElementById('news-filter').value;
      const btn = document.getElementById('send-news');
      const loading = document.getElementById('send-news-loading');
      if (!message) {
        showNotification('Message is required', 'red');
        return;
      }
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/communication`, {
          method: 'POST',
          body: JSON.stringify({ type: 'news', message, filter })
        });
        showNotification('News sent', 'green');
        document.getElementById('news-message').value = '';
      } catch (err) {
        handleApiError(err, 'Failed to send news');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    // Fetch Password Resets
    async function fetchPasswordResets() {
      try {
        const data = await fetchWithAuth(`${API_BASE}/api/admin/affiliate/reset-passwords`);
        passwordResets = data.requests;
        renderPasswordResets();
      } catch (err) {
        handleApiError(err, 'Failed to load password resets');
      }
    }

    function renderPasswordResets() {
      document.getElementById('password-resets-table').innerHTML = passwordResets.map(r => `
        <tr class="border-b dark:border-gray-700">
          <td class="p-2">${r.email}</td>
          <td class="p-2">${r.username}</td>
          <td class="p-2">${r.name}</td>
          <td class="p-2">${r.lastWithdrawalAmount || 0}</td>
          <td class="p-2">${r.description}</td>
          <td class="p-2">${new Date(r.timestamp).toLocaleString()}</td>
          <td class="p-2">
            <select data-email="${r.email}" class="reset-status p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600">
              <option value="pending" ${r.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="approved" ${r.status === 'approved' ? 'selected' : ''}>Approved</option>
              <option value="declined" ${r.status === 'declined' ? 'selected' : ''}>Declined</option>
            </select>
            ${r.status === 'approved' ? `
              <div class="mt-2">
                <input type="text" value="${r.password}" class="p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600" readonly>
                <button data-password="${r.password}" class="copy-password bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600 min-w-[60px] transition duration-200 hover:scale-105">Copy</button>
                <button data-email="${r.email}" data-password="${r.password}" class="email-password bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600 min-w-[60px] transition duration-200 hover:scale-105">Email</button>
              </div>
            ` : ''}
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.reset-status').forEach(select => {
        select.addEventListener('change', async () => {
          const email = select.dataset.email;
          const status = select.value;
          let password = '';
          if (status === 'approved') {
            password = Math.random().toString(36).slice(2, 14); // 12-char password
            if (!/^(?=.*[a-zA-Z])(?=.*\d)/.test(password)) {
              password = password.slice(0, 10) + 'a1';
            }
          }
          try {
            await fetchWithAuth(`${API_BASE}/api/admin/affiliate/reset-password`, {
              method: 'POST',
              body: JSON.stringify({ email, status, password })
            });
            showNotification('Reset request processed', 'green');
            fetchPasswordResets();
          } catch (err) {
            handleApiError(err, 'Failed to process reset');
            select.value = 'pending';
          }
        });
      });
      document.querySelectorAll('.copy-password').forEach(btn => {
        btn.addEventListener('click', () => {
          const text = btn.dataset.password;
          navigator.clipboard.writeText(text).then(() => {
            showNotification('Password copied', 'green');
          }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification('Password copied', 'green');
          });
        });
      });
      document.querySelectorAll('.email-password').forEach(btn => {
        btn.addEventListener('click', () => {
          const email = btn.dataset.email;
          const password = btn.dataset.password;
          window.location.href = `mailto:${email}?subject=Deriv%20Bot%20Store%20Affiliate&body=Your%20password%20was%20reset,%20use%20this%20password%20to%20login:%20${password}.%20Regards,%20Deriv%20Bot%20Store%20Affiliate`;
        });
      });
    }

    // Save Admin Credentials
    document.getElementById('save-credentials').addEventListener('click', async () => {
      const oldEmail = document.getElementById('old-email').value;
      const newEmail = document.getElementById('new-email').value;
      const oldPassword = document.getElementById('old-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmNewPassword = document.getElementById('confirm-new-password').value;
      const btn = document.getElementById('save-credentials');
      const loading = document.getElementById('save-credentials-loading');
      if (!oldEmail || !newEmail || !oldPassword || !newPassword || !confirmNewPassword) {
        showNotification('Please fill all fields', 'red');
        return;
      }
      if (newPassword !== confirmNewPassword) {
        showNotification('New passwords do not match', 'red');
        return;
      }
      if (!/^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{8,}$/.test(newPassword)) {
        showNotification('New password must be at least 8 characters with 1 letter and 1 number', 'red');
        return;
      }
      btn.disabled = true;
      loading.classList.remove('hidden');
      try {
        await fetchWithAuth(`${API_BASE}/api/admin/affiliate/settings`, {
          method: 'POST',
          body: JSON.stringify({ adminEmail: newEmail, adminPassword: newPassword, oldEmail, oldPassword })
        });
        showNotification('Credentials updated', 'green');
        deleteCookie('jwt');
        if (ws) ws.close();
        showLogin();
      } catch (err) {
        handleApiError(err, 'Failed to update credentials');
      } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
      }
    });

    // Toggle Password Visibility for Settings
    document.querySelectorAll('.relative button[id*="toggle"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const inputId = btn.id.replace('toggle-', '');
        const input = document.getElementById(inputId);
        if (input) {
          input.type = input.type === 'password' ? 'text' : 'password';
          btn.textContent = input.type === 'password' ? 'Show' : 'Hide';
        }
      });
    });

    // Initialize
    checkAuth();

    // Prevent form submissions
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('submit', (e) => e.preventDefault());
    });

    // Handle window resize for responsive adjustments
    window.addEventListener('resize', () => {
      renderAffiliates();
      renderPendingWithdrawals();
      renderSortedWithdrawals();
      renderLeaderboard();
      renderStaticPages();
      renderPasswordResets();
      // Adjust login form size
      const loginForm = document.querySelector('#login-page > div');
      if (loginForm) {
        loginForm.style.maxWidth = window.innerWidth < 640 ? '90%' : '32rem';
      }
    });

    // Periodic data refresh with error handling
    setInterval(async () => {
      if (document.getElementById('dashboard').classList.contains('hidden')) return;
      try {
        if (currentTab === 'home') await fetchSettings();
        if (currentTab === 'affiliates') await fetchAffiliates();
        if (currentTab === 'pending-withdrawals') await fetchPendingWithdrawals();
        if (currentTab === 'sorted-withdrawals') await fetchSortedWithdrawals();
        if (currentTab === 'rewards') await fetchLeaderboard();
        if (currentTab === 'static-pages') await fetchStaticPages();
        if (currentTab === 'communication') await fetchCommunication();
        if (currentTab === 'password-resets') await fetchPasswordResets();
      } catch (err) {
        handleApiError(err, 'Failed to refresh data');
      }
    }, 300000); // Refresh every 5 minutes

    // Prevent page reload on Enter key in inputs
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') e.preventDefault();
      });
    });
  </script>
</body>
</html>
