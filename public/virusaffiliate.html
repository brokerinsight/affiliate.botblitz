<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deriv Bot Store Affiliates Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <style>
    /* Custom animations */
    .notification-enter {
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    }
    .notification-enter-active {
      transform: translateX(0);
      opacity: 1;
    }
    .notification-exit {
      opacity: 1;
      transition: opacity 0.3s ease-in-out;
    }
    .notification-exit-active {
      opacity: 0;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      transition: transform 0.2s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div id="logo" class="flex items-center">
        <h1 class="text-2xl font-bold">Deriv Bot Store Affiliates Admin</h1>
      </div>
      <div id="nav" class="flex items-center space-x-4 hidden">
        <button id="logout" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Logout</button>
        <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
          <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          <svg id="moon-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Login Page -->
    <div id="login-section" class="hidden">
      <div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4 text-center">Admin Login</h2>
        <form id="login-form" class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm font-medium">Email</label>
            <input id="login-email" type="email" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required aria-label="Admin Email">
          </div>
          <div>
            <label for="login-password" class="block text-sm font-medium">Password</label>
            <div class="relative">
              <input id="login-password" type="password" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required aria-label="Admin Password">
              <button type="button" id="login-password-toggle" class="absolute right-2 top-2 text-sm text-blue-500">Show</button>
            </div>
          </div>
          <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center" aria-label="Login">
            <span>Login</span>
            <svg id="login-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="hidden">
      <!-- Tabs -->
      <nav class="flex flex-wrap gap-2 mb-6">
        <button id="tab-home" class="px-4 py-2 bg-blue-500 text-white rounded-md">Home</button>
        <button id="tab-affiliates" class="px-4 py-2 bg-gray-500 text-white rounded-md">Affiliates</button>
        <button id="tab-pending-withdrawals" class="px-4 py-2 bg-gray-500 text-white rounded-md">Pending Withdrawals</button>
        <button id="tab-sorted-withdrawals" class="px-4 py-2 bg-gray-500 text-white rounded-md">Sorted Withdrawals</button>
        <button id="tab-rewards" class="px-4 py-2 bg-gray-500 text-white rounded-md">Rewards</button>
        <button id="tab-static-pages" class="px-4 py-2 bg-gray-500 text-white rounded-md">Static Pages</button>
        <button id="tab-communication" class="px-4 py-2 bg-gray-500 text-white rounded-md">Communication</button>
        <button id="tab-password-resets" class="px-4 py-2 bg-gray-500 text-white rounded-md">Password Resets</button>
        <button id="tab-settings" class="px-4 py-2 bg-gray-500 text-white rounded-md">Settings</button>
      </nav>

      <!-- Tab Content -->
      <div id="home-content" class="space-y-6">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <h2 class="text-lg font-bold mb-4">Global Settings</h2>
          <form id="settings-form" class="space-y-4">
            <div>
              <label for="support-email" class="block text-sm font-medium">Support Email</label>
              <input id="support-email" type="email" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
              <label for="copyright-text" class="block text-sm font-medium">Copyright Text</label>
              <input id="copyright-text" type="text" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
              <label for="whatsapp-link" class="block text-sm font-medium">WhatsApp Link</label>
              <input id="whatsapp-link" type="url" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
              <label for="commission-rate" class="block text-sm font-medium">Commission Rate (0â€“1)</label>
              <input id="commission-rate" type="number" step="0.01" min="0" max="1" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
              <label for="logo-url" class="block text-sm font-medium">Logo URL</label>
              <input id="logo-url" type="url" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
            </div>
            <div>
              <label for="admin-email" class="block text-sm font-medium">Admin Email</label>
              <input id="admin-email" type="email" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
              <label for="admin-password" class="block text-sm font-medium">Admin Password</label>
              <div class="relative">
                <input id="admin-password" type="password" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                <button type="button" id="admin-password-toggle" class="absolute right-2 top-2 text-sm text-blue-500">Show</button>
              </div>
            </div>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center">
              <span>Save Settings</span>
              <svg id="settings-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
      <div id="affiliates-content" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover mb-4">
          <div class="flex flex-col md:flex-row gap-4">
            <div>
              <label for="affiliate-search" class="block text-sm font-medium">Search</label>
              <input id="affiliate-search" type="text" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Search by Name, Email, or Username">
            </div>
            <div>
              <label for="affiliate-sort" class="block text-sm font-medium">Sort By</label>
              <select id="affiliate-sort" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                <option value="monthly-sales-desc">Monthly Sales: High to Low</option>
                <option value="status-active">Status: Active</option>
                <option value="status-blocked">Status: Blocked</option>
                <option value="status-deleted">Status: Deleted</option>
              </select>
            </div>
          </div>
        </div>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 dark:bg-gray-700">
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Email</th>
              <th class="p-2 text-left">Username</th>
              <th class="p-2 text-left">Join Date</th>
              <th class="p-2 text-left">Link Clicks</th>
              <th class="p-2 text-left">Sale Count</th>
              <th class="p-2 text-left">Total Earnings (KES)</th>
              <th class="p-2 text-left">Withdrawn Total (KES)</th>
              <th class="p-2 text-left">Monthly Sales</th>
              <th class="p-2 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="affiliates-table"></tbody>
        </table>
      </div>
      <div id="pending-withdrawals-content" class="hidden">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 dark:bg-gray-700">
              <th class="p-2 text-left">Email</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Timestamp</th>
              <th class="p-2 text-left">Amount (KES)</th>
              <th class="p-2 text-left">MPESA Number</th>
              <th class="p-2 text-left">MPESA Name</th>
              <th class="p-2 text-left">Payment Refcode</th>
              <th class="p-2 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="pending-withdrawals-table"></tbody>
        </table>
      </div>
      <div id="sorted-withdrawals-content" class="hidden">
        <p class="text-sm text-gray-500 mb-4">Showing up to 40 recent withdrawals.</p>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 dark:bg-gray-700">
              <th class="p-2 text-left">Email</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Timestamp</th>
              <th class="p-2 text-left">Amount (KES)</th>
              <th class="p-2 text-left">MPESA Number</th>
              <th class="p-2 text-left">MPESA Name</th>
              <th class="p-2 text-left">Payment Refcode</th>
              <th class="p-2 text-left">Status</th>
            </tr>
          </thead>
          <tbody id="sorted-withdrawals-table"></tbody>
        </table>
        <div class="flex justify-between mt-4">
          <button id="sorted-withdrawals-prev" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 disabled:opacity-50" disabled>Previous</button>
          <button id="sorted-withdrawals-next" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 disabled:opacity-50" disabled>Next</button>
        </div>
      </div>
      <div id="rewards-content" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover mb-4">
          <h2 class="text-lg font-bold mb-4">Leaderboard Rewards</h2>
          <table class="w-full border-collapse mb-4">
            <thead>
              <tr class="bg-gray-200 dark:bg-gray-700">
                <th class="p-2 text-left">Rank</th>
                <th class="p-2 text-left">Name</th>
                <th class="p-2 text-left">Email</th>
                <th class="p-2 text-left">Monthly Sales</th>
              </tr>
            </thead>
            <tbody id="leaderboard-table"></tbody>
          </table>
          <div class="space-y-4">
            <div>
              <label for="reward-type" class="block text-sm font-medium">Reward Type</label>
              <select id="reward-type" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                <option value="percentage">Percentage</option>
                <option value="spot">Spot</option>
              </select>
            </div>
            <div id="percentage-reward" class="space-y-4">
              <div>
                <label for="percentage-amount" class="block text-sm font-medium">Percentage (e.g., 10% = 0.1)</label>
                <input id="percentage-amount" type="number" step="0.01" min="0" max="1" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
              </div>
              <button id="apply-percentage" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center">
                <span>Apply Reward</span>
                <svg id="percentage-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              </button>
            </div>
            <div id="spot-reward" class="space-y-4 hidden">
              <div>
                <label for="spot-amount" class="block text-sm font-medium">Fixed Amount (KES)</label>
                <input id="spot-amount" type="number" min="0" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
              </div>
              <button id="select-recipients" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Select Recipients</button>
            </div>
          </div>
        </div>
      </div>
      <div id="static-pages-content" class="hidden">
        <div class="flex justify-end mb-4">
          <button id="create-page" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Create Page</button>
        </div>
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 dark:bg-gray-700">
              <th class="p-2 text-left">Slug</th>
              <th class="p-2 text-left">Title</th>
              <th class="p-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="static-pages-table"></tbody>
        </table>
      </div>
      <div id="communication-content" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover mb-4">
          <h2 class="text-lg font-bold mb-4">Urgent Message</h2>
          <form id="urgent-form" class="space-y-4">
            <div>
              <label for="urgent-message" class="block text-sm font-medium">Message</label>
              <textarea id="urgent-message" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required></textarea>
            </div>
            <div>
              <label class="flex items-center">
                <input id="urgent-enabled" type="checkbox" class="mr-2">
                <span class="text-sm">Enable Popup on Affiliate Dashboard</span>
              </label>
            </div>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center">
              <span>Save</span>
              <svg id="urgent-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </form>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <h2 class="text-lg font-bold mb-4">News</h2>
          <form id="news-form" class="space-y-4">
            <div>
              <label for="news-message" class="block text-sm font-medium">Message</label>
              <textarea id="news-message" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required></textarea>
            </div>
            <div>
              <label for="news-filter" class="block text-sm font-medium">Filter</label>
              <select id="news-filter" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                <option value="all">All Affiliates</option>
              </select>
            </div>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center">
              <span>Send</span>
              <svg id="news-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
      <div id="password-resets-content" class="hidden">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200 dark:bg-gray-700">
              <th class="p-2 text-left">Email</th>
              <th class="p-2 text-left">Username</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Last Withdrawal Amount</th>
              <th class="p-2 text-left">Description</th>
              <th class="p-2 text-left">Timestamp</th>
              <th class="p-2 text-left">Status</th>
              <th class="p-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="password-resets-table"></tbody>
        </table>
      </div>
      <div id="settings-content" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow card-hover">
          <h2 class="text-lg font-bold mb-4">Admin Credentials</h2>
          <form id="admin-settings-form" class="space-y-4">
            <div>
              <label for="settings-admin-email" class="block text-sm font-medium">Admin Email</label>
              <input id="settings-admin-email" type="email" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
            </div>
            <div>
              <label for="settings-admin-password" class="block text-sm font-medium">Admin Password</label>
              <div class="relative">
                <input id="settings-admin-password" type="password" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                <button type="button" id="settings-admin-password-toggle" class="absolute right-2 top-2 text-sm text-blue-500">Show</button>
              </div>
            </div>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center">
              <span>Save</span>
              <svg id="admin-settings-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white dark:bg-gray-800 py-6">
    <div class="max-w-7xl mx-auto px-4 text-center">
      <p id="copyright" class="text-sm text-gray-500">Deriv Bot Store Affiliates 2025</p>
    </div>
  </footer>

  <!-- Modals -->
  <div id="spot-reward-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-4xl w-full">
      <h2 class="text-xl font-bold mb-4">Select Spot Reward Recipients</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200 dark:bg-gray-700">
            <th class="p-2 text-left">Email</th>
            <th class="p-2 text-left">Name</th>
            <th class="p-2 text-left">Monthly Sales</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">Select</th>
          </tr>
        </thead>
        <tbody id="spot-reward-table"></tbody>
      </table>
      <div class="flex justify-end mt-4 space-x-4">
        <button id="apply-spot-reward" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center">
          <span>Apply Spot Reward</span>
          <svg id="spot-reward-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
        <button id="close-spot-reward" class="text-gray-500 hover:text-gray-700">Cancel</button>
      </div>
    </div>
  </div>
  <div id="static-page-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full">
      <h2 id="static-page-title" class="text-xl font-bold mb-4">Create Page</h2>
      <form id="static-page-form" class="space-y-4">
        <div>
          <label for="page-title" class="block text-sm font-medium">Title</label>
          <input id="page-title" type="text" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
        </div>
        <div>
          <label for="page-content" class="block text-sm font-medium">Content (HTML/Markdown)</label>
          <textarea id="page-content" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="6" required></textarea>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex justify-center items-center">
            <span>Save</span>
            <svg id="static-page-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
          <button type="button" id="close-static-page" class="text-gray-500 hover:text-gray-700">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  <div id="delete-page-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full">
      <h2 class="text-xl font-bold mb-4">Delete Page</h2>
      <p class="mb-4">Are you sure you want to delete this page? This action cannot be undone.</p>
      <div class="flex justify-end space-x-4">
        <button id="confirm-delete-page" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 flex justify-center items-center">
          <span>Delete</span>
          <svg id="delete-page-loading" class="w-5 h-5 ml-2 animate-spin hidden" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
        <button id="close-delete-page" class="text-gray-500 hover:text-gray-700">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notifications" class="fixed top-4 right-4 space-y-2"></div>

  <script>
    // Constants
    const API_BASE = 'https://affiliate-botblitz.onrender.com';
    const WS_BASE = 'wss://affiliate-botblitz.onrender.com/ws/admin/affiliates';
    const NOTIFICATION_TIMEOUT = 30000; // 30s
    const ITEMS_PER_PAGE = 20;

    // State
    let ws = null;
    let notificationsQueue = [];
    let activeNotifications = 0;
    let dashboardData = {
      settings: {},
      affiliates: [],
      pendingWithdrawals: [],
      sortedWithdrawals: [],
      leaderboard: [],
      staticPages: [],
      passwordResets: []
    };
    let pagination = {
      sortedWithdrawals: { page: 1, total: 0 }
    };
    let currentSlug = null;

    // Utility Functions
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, maxAge) {
      document.cookie = `${name}=${value}; max-age=${maxAge}; path=/; secure; SameSite=Strict`;
    }

    function clearCookie(name) {
      document.cookie = `${name}=; max-age=0; path=/; secure; SameSite=Strict`;
    }

    function showNotification(message, color, id = `NOTIF${Date.now()}`) {
      if (activeNotifications >= 3) {
        notificationsQueue.push({ message, color, id });
        return;
      }
      activeNotifications++;
      const notification = document.createElement('div');
      notification.className = `bg-white dark:bg-gray-800 p-4 rounded shadow border-l-4 border-${color}-500 notification-enter`;
      notification.innerHTML = `
        <div class="flex justify-between items-center">
          <p>${message}</p>
          <button class="text-gray-500 hover:text-gray-700" onclick="closeNotification(this, '${id}')">X</button>
        </div>
      `;
      document.getElementById('notifications').appendChild(notification);
      setTimeout(() => notification.classList.add('notification-enter-active'), 10);
      setTimeout(() => closeNotification(notification.querySelector('button'), id), NOTIFICATION_TIMEOUT);
    }

    function closeNotification(button, id) {
      const notification = button.parentElement.parentElement;
      notification.classList.add('notification-exit');
      setTimeout(() => {
        notification.classList.add('notification-exit-active');
        setTimeout(() => {
          notification.remove();
          activeNotifications--;
          if (notificationsQueue.length > 0) {
            const next = notificationsQueue.shift();
            showNotification(next.message, next.color, next.id);
          }
        }, 300);
      }, 10);
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function validateUrl(url) {
      try {
        new URL(url);
        return true;
      } catch {
        return false;
      }
    }

    // WebSocket Setup
    function initWebSocket(token) {
      let reconnectAttempts = 0;
      const maxAttempts = 5;
      const baseDelay = 1000;

      function connect() {
        ws = new WebSocket(`${WS_BASE}?token=${token}`);
        ws.onopen = () => {
          console.log('WebSocket connected');
          reconnectAttempts = 0;
        };
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'update') {
            dashboardData = { ...dashboardData, ...data.data };
            updateDashboard();
          } else if (data.type === 'notification') {
            showNotification(data.message, data.colour, data.id);
          } else if (data.type === 'logout') {
            clearCookie('jwt');
            ws.close();
            showNotification('Session expired, please login', 'red');
            showLogin();
          }
        };
        ws.onclose = () => {
          console.log('WebSocket disconnected');
          if (reconnectAttempts < maxAttempts) {
            const delay = baseDelay * Math.pow(2, reconnectAttempts);
            setTimeout(() => {
              console.log(`Reconnecting WebSocket, attempt ${reconnectAttempts + 1}`);
              reconnectAttempts++;
              connect();
            }, delay);
          } else {
            showNotification('Lost connection to server', 'red');
          }
        };
        ws.onerror = (err) => console.error('WebSocket error:', err);
      }
      connect();
    }

    // Dashboard Rendering
    function updateDashboard() {
      try {
        const {
          settings = {},
          affiliates = [],
          pendingWithdrawals = [],
          sortedWithdrawals = [],
          leaderboard = [],
          staticPages = [],
          passwordResets = []
        } = dashboardData;

        // Header
        document.getElementById('logo').innerHTML = settings.logoUrl
          ? `<img src="${settings.logoUrl}" alt="Deriv Bot Store Affiliates Admin" class="h-8">`
          : '<h1 class="text-2xl font-bold">Deriv Bot Store Affiliates Admin</h1>';
        document.getElementById('copyright').textContent = settings.copyrightText || '';

        // Home Tab
        document.getElementById('support-email').value = settings.supportEmail || '';
        document.getElementById('copyright-text').value = settings.copyrightText || '';
        document.getElementById('whatsapp-link').value = settings.whatsappLink || '';
        document.getElementById('commission-rate').value = settings.commissionRate || 0;
        document.getElementById('logo-url').value = settings.logoUrl || '';
        document.getElementById('admin-email').value = settings.adminEmail || '';
        document.getElementById('admin-password').value = settings.adminPassword || '';

        // Affiliates Tab
        const affiliatesTable = document.getElementById('affiliates-table');
        affiliatesTable.innerHTML = '';
        const filteredAffiliates = filterAndSortAffiliates(affiliates);
        filteredAffiliates.forEach(a => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${a.Name || '-'}</td>
            <td class="p-2">${a.Email || '-'}</td>
            <td class="p-2">${a.Username || '-'}</td>
            <td class="p-2">${a.JoinDate ? new Date(a.JoinDate).toLocaleDateString() : '-'}</td>
            <td class="p-2">${a.LinkClicks || 0}</td>
            <td class="p-2">${a.TotalSales || 0}</td>
            <td class="p-2">${((a.CurrentBalance || 0) + (a.WithdrawnTotal || 0)).toFixed(2)}</td>
            <td class="p-2">${(a.WithdrawnTotal || 0).toFixed(2)}</td>
            <td class="p-2">${a.TotalSalesMonthly || 0}</td>
            <td class="p-2">
              <select class="status-select w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" data-email="${a.Email || ''}">
                <option value="active" ${a.Statusjson?.status === 'active' ? 'selected' : ''}>Active</option>
                <option value="blocked" ${a.Statusjson?.status === 'blocked' ? 'selected' : ''}>Blocked</option>
                <option value="deleted" ${a.Statusjson?.status === 'deleted' ? 'selected' : ''}>Delete</option>
              </select>
            </td>
          `;
          affiliatesTable.appendChild(row);
        });

        // Pending Withdrawals Tab
        const pendingWithdrawalsTable = document.getElementById('pending-withdrawals-table');
        pendingWithdrawalsTable.innerHTML = '';
        pendingWithdrawals.forEach(w => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${w.Email || '-'}</td>
            <td class="p-2">${w.Name || '-'}</td>
            <td class="p-2">${w.Timestamp ? new Date(w.Timestamp).toLocaleString() : '-'}</td>
            <td class="p-2">${w.Amount ? w.Amount.toFixed(2) : '0.00'}</td>
            <td class="p-2">
              ${w.MpesaNumber || '-'}
              ${w.MpesaNumber ? `<button class="copy-mpesa ml-2 bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600" data-value="${w.MpesaNumber}">Copy</button>` : ''}
            </td>
            <td class="p-2">${w.MpesaName || '-'}</td>
            <td class="p-2">
              <input class="refcode-input w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" value="${w.PaymentRefcode || ''}">
            </td>
            <td class="p-2">
              <select class="status-select w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" data-id="${w.withdrawalId || ''}" data-email="${w.Email || ''}">
                <option value="Pending" ${w.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                <option value="Done">Done</option>
                <option value="Dispute">Dispute</option>
              </select>
            </td>
          `;
          pendingWithdrawalsTable.appendChild(row);
        });

        // Sorted Withdrawals Tab
        const sortedWithdrawalsTable = document.getElementById('sorted-withdrawals-table');
        sortedWithdrawalsTable.innerHTML = '';
        pagination.sortedWithdrawals.total = sortedWithdrawals.length;
        const sortedPage = sortedWithdrawals.slice(
          (pagination.sortedWithdrawals.page - 1) * ITEMS_PER_PAGE,
          pagination.sortedWithdrawals.page * ITEMS_PER_PAGE
        );
        sortedPage.forEach(w => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${w.Email || '-'}</td>
            <td class="p-2">${w.Name || '-'}</td>
            <td class="p-2">${w.Timestamp ? new Date(w.Timestamp).toLocaleString() : '-'}</td>
            <td class="p-2">${w.Amount ? w.Amount.toFixed(2) : '0.00'}</td>
            <td class="p-2">${w.MpesaNumber || '-'}</td>
            <td class="p-2">${w.MpesaName || '-'}</td>
            <td class="p-2">${w.PaymentRefcode || '-'}</td>
            <td class="p-2">${w.Status || '-'}</td>
          `;
          sortedWithdrawalsTable.appendChild(row);
        });
        document.getElementById('sorted-withdrawals-prev').disabled = pagination.sortedWithdrawals.page === 1;
        document.getElementById('sorted-withdrawals-next').disabled = (Number.isInteger(pagination.sortedWithdrawals.page) && Number.isInteger(pagination.sortedWithdrawals.total)) 
          ? pagination.sortedWithdrawals.page * ITEMS_PER_PAGE >= pagination.sortedWithdrawals.total 
          : true;

        // Rewards Tab
        const leaderboardTable = document.getElementById('leaderboard-table');
        leaderboardTable.innerHTML = '';
        leaderboard.forEach(l => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${l.rank || '-'}</td>
            <td class="p-2">${l.Name || '-'}</td>
            <td class="p-2">${l.Email || '-'}</td>
            <td class="p-2">${l.TotalSalesMonthly || 0}</td>
          `;
          leaderboardTable.appendChild(row);
        });

        // Static Pages Tab
        const staticPagesTable = document.getElementById('static-pages-table');
        staticPagesTable.innerHTML = '';
        staticPages.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">/affiliate-${p.Slug || '-'}</td>
            <td class="p-2">${p.Title || '-'}</td>
            <td class="p-2">
              <button class="edit-page bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600" data-slug="${p.Slug || ''}">Edit</button>
              <button class="delete-page bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600" data-slug="${p.Slug || ''}">Delete</button>
            </td>
          `;
          staticPagesTable.appendChild(row);
        });

        // Password Resets Tab
        const passwordResetsTable = document.getElementById('password-resets-table');
        passwordResetsTable.innerHTML = '';
        passwordResets.forEach(r => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2">${r.Email || '-'}</td>
            <td class="p-2">${r.Username || '-'}</td>
            <td class="p-2">${r.Name || '-'}</td>
            <td class="p-2">${r.LastWithdrawalAmount ? r.LastWithdrawalAmount.toFixed(2) : '0.00'}</td>
            <td class="p-2">${r.Description || '-'}</td>
            <td class="p-2">${r.Timestamp ? new Date(r.Timestamp).toLocaleString() : '-'}</td>
            <td class="p-2">
              <select class="reset-status w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" data-email="${r.Email || ''}">
                <option value="Pending" ${r.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                <option value="Approved" ${r.Status === 'Approved' ? 'selected' : ''}>Approved</option>
                <option value="Declined" ${r.Status === 'Declined' ? 'selected' : ''}>Declined</option>
              </select>
            </td>
            <td class="p-2">
              ${r.Status === 'Approved' && r.Password ? `
                <div class="flex space-x-2">
                  <input type="text" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" value="${r.Password}" readonly>
                  <button class="copy-password bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600" data-value="${r.Password}">Copy</button>
                  <a href="mailto:${r.Email}?subject=Deriv Bot Store Affiliate&body=Your password was reset, use this password to login: ${r.Password}. Regards, Deriv Bot Store Affiliate" class="bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">Email</a>
                </div>
              ` : ''}
            </td>
          `;
          passwordResetsTable.appendChild(row);
        });

        // Settings Tab
        document.getElementById('settings-admin-email').value = settings.adminEmail || '';
        document.getElementById('settings-admin-password').value = settings.adminPassword || '';
      } catch (err) {
        console.error('updateDashboard error:', err);
        showNotification('Failed to update dashboard: ' + err.message, 'red');
      }
    }

    function filterAndSortAffiliates(affiliates) {
      try {
        const search = document.getElementById('affiliate-search').value.toLowerCase();
        const sort = document.getElementById('affiliate-sort').value;
        let filtered = affiliates.filter(a =>
          (a.Name || '').toLowerCase().includes(search) ||
          (a.Email || '').toLowerCase().includes(search) ||
          (a.Username || '').toLowerCase().includes(search)
        );
        if (sort === 'monthly-sales-desc') {
          filtered.sort((a, b) => (b.TotalSalesMonthly || 0) - (a.TotalSalesMonthly || 0));
        } else if (sort === 'status-active') {
          filtered = filtered.filter(a => a.Statusjson?.status === 'active');
        } else if (sort === 'status-blocked') {
          filtered = filtered.filter(a => a.Statusjson?.status === 'blocked');
        } else if (sort === 'status-deleted') {
          filtered = filtered.filter(a => a.Statusjson?.status === 'deleted');
        }
        return filtered;
      } catch (err) {
        console.error('filterAndSortAffiliates error:', err);
        return affiliates;
      }
    }

    // Authentication
    function showLogin() {
      console.log('showLogin: Displaying login section');
      try {
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('nav').classList.add('hidden');
      } catch (err) {
        console.error('showLogin error:', err);
      }
    }

    function showDashboard() {
      console.log('showDashboard: Displaying dashboard section');
      try {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('nav').classList.remove('hidden');
        document.getElementById('tab-home').click();
        fetchDashboard();
      } catch (err) {
        console.error('showDashboard error:', err);
        showLogin();
      }
    }

    async function fetchDashboard() {
      try {
        const response = await fetchWithRetry(`${API_BASE}/api/admin/affiliates/dashboard`, {
          headers: { 'Authorization': `Bearer ${getCookie('jwt')}` }
        });
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        if (data.success) {
          dashboardData = data.data;
          updateDashboard();
        } else {
          throw new Error(data.error || 'Failed to load dashboard data');
        }
      } catch (err) {
        console.error('fetchDashboard error:', err);
        showNotification(`Failed to load dashboard: ${err.message}`, 'red');
        showLogin();
      }
    }

    // Retry Fetch with Exponential Backoff
    async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, options);
          if (response.status === 429) {
            const waitTime = delay * Math.pow(2, i);
            await new Promise(resolve => setTimeout(resolve, waitTime));
            continue;
          }
          return response;
        } catch (err) {
          if (i === retries - 1) throw err;
          await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
        }
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded: Initializing');
      try {
        // Theme Toggle
        const theme = localStorage.getItem('theme') || 'dark';
        document.documentElement.classList.toggle('dark', theme === 'dark');
        document.getElementById('sun-icon').classList.toggle('hidden', theme === 'dark');
        document.getElementById('moon-icon').classList.toggle('hidden', theme === 'light');
        document.getElementById('theme-toggle').addEventListener('click', () => {
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          document.getElementById('sun-icon').classList.toggle('hidden', isDark);
          document.getElementById('moon-icon').classList.toggle('hidden', !isDark);
        });

        // Password Toggles
        ['login', 'admin', 'settings-admin'].forEach(id => {
          const toggle = document.getElementById(`${id}-password-toggle`);
          const input = document.getElementById(`${id}-password`);
          if (toggle && input) {
            toggle.addEventListener('click', () => {
              const isPassword = input.type === 'password';
              input.type = isPassword ? 'text' : 'password';
              toggle.textContent = isPassword ? 'Hide' : 'Show';
            });
          }
        });

        // Login Form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;

          if (!validateEmail(email)) return showNotification('Invalid email format', 'red');

          document.getElementById('login-loading').classList.remove('hidden');
          try {
            const response = await fetchWithRetry(`${API_BASE}/api/admin/affiliates/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
            });
            if (!response.ok) {
              throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
            }
            const text = await response.text();
            let data;
            try {
              data = text ? JSON.parse(text) : { success: false, error: 'Empty response' };
            } catch (err) {
              throw new Error('Invalid JSON response from server');
            }
            document.getElementById('login-loading').classList.add('hidden');
            if (data.success) {
              setCookie('jwt', data.token, 604800);
              initWebSocket(data.token);
              showDashboard();
            } else {
              showNotification(data.error || 'Invalid credentials', 'red');
            }
          } catch (err) {
            document.getElementById('login-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        // Dashboard Tabs
        ['home', 'affiliates', 'pending-withdrawals', 'sorted-withdrawals', 'rewards', 'static-pages', 'communication', 'password-resets', 'settings'].forEach(tab => {
          document.getElementById(`tab-${tab}`).addEventListener('click', () => {
            document.querySelectorAll('nav button').forEach(btn => {
              btn.classList.replace('bg-blue-500', 'bg-gray-500');
            });
            document.getElementById(`tab-${tab}`).classList.replace('bg-gray-500', 'bg-blue-500');
            document.querySelectorAll('#dashboard-section > div').forEach(div => {
              div.classList.add('hidden');
            });
            document.getElementById(`${tab}-content`).classList.remove('hidden');
          });
        });

        // Home/Settings Form
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const settings = {
            supportEmail: document.getElementById('support-email').value,
            copyrightText: document.getElementById('copyright-text').value,
            whatsappLink: document.getElementById('whatsapp-link').value,
            commissionRate: parseFloat(document.getElementById('commission-rate').value),
            logoUrl: document.getElementById('logo-url').value,
            adminEmail: document.getElementById('admin-email').value,
            adminPassword: document.getElementById('admin-password').value
          };

          if (!validateEmail(settings.supportEmail) || !validateEmail(settings.adminEmail)) return showNotification('Invalid email format', 'red');
          if (!validateUrl(settings.whatsappLink)) return showNotification('Invalid WhatsApp link', 'red');
          if (settings.commissionRate < 0 || settings.commissionRate > 1) return showNotification('Commission rate must be between 0 and 1', 'red');
          if (settings.logoUrl && !validateUrl(settings.logoUrl)) return showNotification('Invalid logo URL', 'red');

          document.getElementById('settings-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/settings`, {
              method: 'PATCH',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(settings)
            });
            const data = await response.json();
            document.getElementById('settings-loading').classList.add('hidden');
            if (data.success) {
              showNotification('Settings updated', 'green');
              fetchDashboard();
            } else {
              showNotification(data.error || 'Failed to update settings', 'red');
            }
          } catch (err) {
            document.getElementById('settings-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        // Affiliates Search and Sort
        document.getElementById('affiliate-search').addEventListener('input', () => updateDashboard());
        document.getElementById('affiliate-sort').addEventListener('change', () => updateDashboard());

        // Affiliates Status Update
        document.getElementById('affiliates-table').addEventListener('change', async (e) => {
          if (e.target.classList.contains('status-select')) {
            const email = e.target.dataset.email;
            const status = e.target.value;
            try {
              const response = await fetch(`${API_BASE}/api/admin/affiliates/${email}/status`, {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${getCookie('jwt')}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status })
              });
              const data = await response.json();
              if (data.success) {
                showNotification('Status updated', 'green');
                fetchDashboard();
              } else {
                showNotification(data.error || 'Failed to update status', 'red');
              }
            } catch (err) {
              showNotification('Error: ' + err.message, 'red');
            }
          }
        });

        // Pending Withdrawals Status Update
        document.getElementById('pending-withdrawals-table').addEventListener('change', async (e) => {
          if (e.target.classList.contains('status-select')) {
            const withdrawalId = e.target.dataset.id;
            const email = e.target.dataset.email;
            const status = e.target.value;
            const refCode = e.target.parentElement.previousElementSibling.querySelector('.refcode-input').value;
            if (status === 'Done' && !refCode) return showNotification('Enter the ref code', 'red');

            try {
              const response = await fetch(`${API_BASE}/api/admin/affiliates/withdrawals/${withdrawalId}`, {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${getCookie('jwt')}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, status, refCode })
              });
              const data = await response.json();
              if (data.success) {
                showNotification('Withdrawal processed', 'green');
                fetchDashboard();
              } else {
                showNotification(data.error || 'Failed to process withdrawal', 'red');
              }
            } catch (err) {
              showNotification('Error: ' + err.message, 'red');
            }
          }
        });

        // Copy MPESA Number
        document.getElementById('pending-withdrawals-table').addEventListener('click', (e) => {
          if (e.target.classList.contains('copy-mpesa')) {
            const value = e.target.dataset.value;
            navigator.clipboard.writeText(value).then(() => {
              showNotification('MPESA number copied', 'green');
            }).catch(() => {
              showNotification('Failed to copy', 'red');
            });
          }
        });

        // Sorted Withdrawals Pagination
        document.getElementById('sorted-withdrawals-prev').addEventListener('click', () => {
          if (pagination.sortedWithdrawals.page > 1) {
            pagination.sortedWithdrawals.page--;
            updateDashboard();
          }
        });
        document.getElementById('sorted-withdrawals-next').addEventListener('click', () => {
          if ((Number.isInteger(pagination.sortedWithdrawals.page) && Number.isInteger(pagination.sortedWithdrawals.total)) &&
              pagination.sortedWithdrawals.page * ITEMS_PER_PAGE < pagination.sortedWithdrawals.total) {
            pagination.sortedWithdrawals.page++;
            updateDashboard();
          }
        });

        // Rewards Type Toggle
        document.getElementById('reward-type').addEventListener('change', (e) => {
          const isPercentage = e.target.value === 'percentage';
          document.getElementById('percentage-reward').classList.toggle('hidden', !isPercentage);
          document.getElementById('spot-reward').classList.toggle('hidden', isPercentage);
        });

        // Apply Percentage Reward
        document.getElementById('apply-percentage').addEventListener('click', async () => {
          const percentage = parseFloat(document.getElementById('percentage-amount').value);
          if (percentage <= 0 || percentage > 1) return showNotification('Percentage must be between 0 and 1', 'red');

          document.getElementById('percentage-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/rewards`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ type: 'percentage', percentage })
            });
            const data = await response.json();
            document.getElementById('percentage-loading').classList.add('hidden');
            if (data.success) {
              showNotification('Rewards applied', 'green');
              fetchDashboard();
            } else {
              showNotification(data.error || 'Failed to apply rewards', 'red');
            }
          } catch (err) {
            document.getElementById('percentage-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        // Select Spot Reward Recipients
        document.getElementById('select-recipients').addEventListener('click', () => {
          const table = document.getElementById('spot-reward-table');
          table.innerHTML = '';
          dashboardData.affiliates.filter(a => a.Statusjson?.status === 'active').forEach(a => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="p-2">${a.Email || '-'}</td>
              <td class="p-2">${a.Name || '-'}</td>
              <td class="p-2">${a.TotalSalesMonthly || 0}</td>
              <td class="p-2">${a.Statusjson?.status || '-'}</td>
              <td class="p-2">
                <input type="checkbox" class="recipient-checkbox" data-email="${a.Email || ''}">
              </td>
            `;
            table.appendChild(row);
          });
          document.getElementById('spot-reward-modal').classList.remove('hidden');
        });

        // Apply Spot Reward
        document.getElementById('apply-spot-reward').addEventListener('click', async () => {
          const amount = parseFloat(document.getElementById('spot-amount').value);
          if (amount <= 0) return showNotification('Amount must be greater than 0', 'red');
          const recipients = Array.from(document.querySelectorAll('.recipient-checkbox:checked')).map(cb => cb.dataset.email);
          if (!recipients.length) return showNotification('Select at least one recipient', 'red');

          document.getElementById('spot-reward-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/rewards`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ type: 'spot', amount, recipients })
            });
            const data = await response.json();
            document.getElementById('spot-reward-loading').classList.add('hidden');
            if (data.success) {
              document.getElementById('spot-reward-modal').classList.add('hidden');
              showNotification('Rewards applied', 'green');
              fetchDashboard();
            } else {
              showNotification(data.error || 'Failed to apply rewards', 'red');
            }
          } catch (err) {
            document.getElementById('spot-reward-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        document.getElementById('close-spot-reward').addEventListener('click', () => {
          document.getElementById('spot-reward-modal').classList.add('hidden');
        });

        // Static Pages
        document.getElementById('create-page').addEventListener('click', () => {
          document.getElementById('static-page-title').textContent = 'Create Page';
          document.getElementById('page-title').value = '';
          document.getElementById('page-content').value = '';
          currentSlug = null;
          document.getElementById('static-page-modal').classList.remove('hidden');
        });

        document.getElementById('static-pages-table').addEventListener('click', (e) => {
          if (e.target.classList.contains('edit-page')) {
            const slug = e.target.dataset.slug;
            const page = dashboardData.staticPages.find(p => p.Slug === slug);
            document.getElementById('static-page-title').textContent = 'Edit Page';
            document.getElementById('page-title').value = page.Title || '';
            document.getElementById('page-content').value = page.Content || '';
            currentSlug = slug;
            document.getElementById('static-page-modal').classList.remove('hidden');
          } else if (e.target.classList.contains('delete-page')) {
            currentSlug = e.target.dataset.slug;
            document.getElementById('delete-page-modal').classList.remove('hidden');
          }
        });

        document.getElementById('static-page-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const title = document.getElementById('page-title').value;
          const content = document.getElementById('page-content').value;
          const slug = currentSlug || title.toLowerCase().replace(/\s+/g, '-');

          document.getElementById('static-page-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/static-pages`, {
              method: currentSlug ? 'PATCH' : 'POST',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ slug, title, content })
            });
            const data = await response.json();
            document.getElementById('static-page-loading').classList.add('hidden');
            if (data.success) {
              document.getElementById('static-page-modal').classList.add('hidden');
              showNotification('Page saved', 'green');
              fetchDashboard();
            } else {
              showNotification(data.error || 'Failed to save page', 'red');
            }
          } catch (err) {
            document.getElementById('static-page-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        document.getElementById('close-static-page').addEventListener('click', () => {
          document.getElementById('static-page-modal').classList.add('hidden');
        });

        document.getElementById('confirm-delete-page').addEventListener('click', async () => {
          document.getElementById('delete-page-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/static-pages/${currentSlug}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              }
            });
            const data = await response.json();
            document.getElementById('delete-page-loading').classList.add('hidden');
            if (data.success) {
              document.getElementById('delete-page-modal').classList.add('hidden');
              showNotification('Page deleted', 'green');
              fetchDashboard();
            } else {
              showNotification(data.error || 'Failed to delete page', 'red');
            }
          } catch (err) {
            document.getElementById('delete-page-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');}
          }
        });

        document.getElementById('close-delete-page').addEventListener('click', () => {
          document.getElementById('delete-page-modal').classList.add('hidden');
        });

        // Urgent Message Form
        document.getElementById('urgent-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const message = document.getElementById('urgent-message').value;
          const enabled = document.getElementById('urgent-enabled').checked;

          document.getElementById('urgent-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/urgent`, {
              method: 'PATCH',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ message, enabled })
            });
            const data = await response.json();
            document.getElementById('urgent-loading').classList.add('hidden');
            if (data.success) {
              showNotification('Urgent message updated', 'green');
              fetchDashboard();
            } else {
              showNotification(data.error || 'Failed to update urgent message', 'red');
            }
          } catch (err) {
            document.getElementById('urgent-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        // News Form
        document.getElementById('news-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const message = document.getElementById('news-message').value;
          const filter = document.getElementById('news-filter').value;

          document.getElementById('news-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/news`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ message, filter })
            });
            const data = await response.json();
            document.getElementById('news-loading').classList.add('hidden');
            if (data.success) {
              showNotification('News sent', 'green');
              document.getElementById('news-message').value = '';
            } else {
              showNotification(data.error || 'Failed to send news', 'red');
            }
          } catch (err) {
            document.getElementById('news-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        // Password Resets Status Update
        document.getElementById('password-resets-table').addEventListener('change', async (e) => {
          if (e.target.classList.contains('reset-status')) {
            const email = e.target.dataset.email;
            const status = e.target.value;

            try {
              const response = await fetch(`${API_BASE}/api/admin/affiliates/reset-password/${email}`, {
                method: 'PATCH',
                headers: {
                  'Authorization': `Bearer ${getCookie('jwt')}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status })
              });
              const data = await response.json();
              if (data.success) {
                showNotification('Password reset status updated', 'green');
                fetchDashboard();
              } else {
                showNotification(data.error || 'Failed to update password reset status', 'red');
              }
            } catch (err) {
              showNotification('Error: ' + err.message, 'red');
            }
          }
        });

        // Copy Password
        document.getElementById('password-resets-table').addEventListener('click', (e) => {
          if (e.target.classList.contains('copy-password')) {
            const value = e.target.dataset.value;
            navigator.clipboard.writeText(value).then(() => {
              showNotification('Password copied', 'green');
            }).catch(() => {
              showNotification('Failed to copy', 'red');
            });
          }
        });

        // Admin Settings Form
        document.getElementById('admin-settings-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('settings-admin-email').value;
          const password = document.getElementById('settings-admin-password').value;

          if (!validateEmail(email)) return showNotification('Invalid email format', 'red');

          document.getElementById('admin-settings-loading').classList.remove('hidden');
          try {
            const response = await fetch(`${API_BASE}/api/admin/affiliates/credentials`, {
              method: 'PATCH',
              headers: {
                'Authorization': `Bearer ${getCookie('jwt')}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            document.getElementById('admin-settings-loading').classList.add('hidden');
            if (data.success) {
              showNotification('Credentials updated', 'green');
              setCookie('jwt', data.token, 604800);
              initWebSocket(data.token);
              fetchDashboard();
            } else {
              showNotification(data.error || 'Failed to update credentials', 'red');
            }
          } catch (err) {
            document.getElementById('admin-settings-loading').classList.add('hidden');
            showNotification('Error: ' + err.message, 'red');
          }
        });

        // Logout
        document.getElementById('logout').addEventListener('click', () => {
          clearCookie('jwt');
          if (ws) ws.close();
          showLogin();
          showNotification('Logged out', 'green');
        });

        // Initial Check
        // clearCookie('jwt'); // Uncomment for testing to force login screen
        const token = getCookie('jwt');
        console.log('Initial check: JWT token exists:', !!token);
        if (token) {
          try {
            const decoded = jwt_decode(token);
            console.log('Initial check: Token decoded, exp:', decoded.exp);
            if (decoded.exp * 1000 > Date.now()) {
              console.log('Initial check: Token valid, initializing WebSocket and showing dashboard');
              initWebSocket(token);
              showDashboard();
            } else {
              console.log('Initial check: Token expired, clearing cookie and showing login');
              clearCookie('jwt');
              showLogin();
            }
          } catch (err) {
            console.error('Initial check: Token decode error:', err);
            clearCookie('jwt');
            showLogin();
          }
        } else {
          console.log('Initial check: No token, showing login');
          showLogin();
        }
      } catch (err) {
        console.error('DOMContentLoaded error:', err);
        showNotification('Initialization error: ' + err.message, 'red');
        showLogin();
      }
    });
  </script>
</body>
</html>
